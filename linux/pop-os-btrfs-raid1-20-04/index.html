<!DOCTYPE html><html lang="en-us" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.6.0 for Hugo" />
  

  
  












  
  










  







  
  

  
  
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Willi Mutschler" />

  
  
  
    
  
  <meta name="description" content="In this guide I will walk you through the installation procedure to get a Pop!_OS 20.04 system with a luks-encrypted partition which contains a LVM with a logical volume for the root filesystem that is formatted with btrfs and contains a subvolume @ for / and a subvolume @home for /home. The system is set up in a RAID1 managed by the btrfs filesystem. I will show how to optimize the btrfs mount options and how to setup encrypted swap partitions which work with hibernation. This layout enables one to use Timeshift and timeshift-autosnap-apt which will regularly take snapshots of the system and particularly on any apt operation. The recovery system of Pop!_OS is also installed to both disks and accessible via the systemd bootloaders. Due to the RAID1 managed by btrfs you get redundancy of your data." />

  
  <link rel="alternate" hreflang="en-us" href="https://mutschler.dev/linux/pop-os-btrfs-raid1-20-04/" />

  
  
  
    <meta name="theme-color" content="#bbdefb" />
  

  
  
    
    <script src="/js/mathjax-config.js"></script>
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha512-W0xM4mr6dEP9nREo7Z9z+9X70wytKvMGeDsj7ps2+xg5QPrEBXC8tAW1IFnzjR6eoJ90JmCnFzerQJTLzIEHjA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    
    
    
    
      
      
    
    
    

    
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.css" integrity="" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.8916ecd0e6b91586be6f7b434c75fb00.css" />

  
  
  
  
  
  
  
    
    
    <link rel="stylesheet" href="/css/libs/chroma/github-light.min.css" title="hl-light" media="print" onload="this.media='all'" disabled>
    <link rel="stylesheet" href="/css/libs/chroma/dracula.min.css" title="hl-dark" media="print" onload="this.media='all'" >
  

  
  



  


  


  




  
  
  

  
  

  
  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  
  <link rel="icon" type="image/png" href="/media/icon_hu589851f325050e29bd29c51f9d799271_45964_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu589851f325050e29bd29c51f9d799271_45964_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://mutschler.dev/linux/pop-os-btrfs-raid1-20-04/" />

  
  
  
  
  
  
  
  
    
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary" />
  
  <meta property="og:site_name" content="mutschler.dev" />
  <meta property="og:url" content="https://mutschler.dev/linux/pop-os-btrfs-raid1-20-04/" />
  <meta property="og:title" content="Pop!_OS 20.04: installation guide with btrfs-LVM-luks-RAID1 and auto-apt snapshots with Timeshift | mutschler.dev" />
  <meta property="og:description" content="In this guide I will walk you through the installation procedure to get a Pop!_OS 20.04 system with a luks-encrypted partition which contains a LVM with a logical volume for the root filesystem that is formatted with btrfs and contains a subvolume @ for / and a subvolume @home for /home. The system is set up in a RAID1 managed by the btrfs filesystem. I will show how to optimize the btrfs mount options and how to setup encrypted swap partitions which work with hibernation. This layout enables one to use Timeshift and timeshift-autosnap-apt which will regularly take snapshots of the system and particularly on any apt operation. The recovery system of Pop!_OS is also installed to both disks and accessible via the systemd bootloaders. Due to the RAID1 managed by btrfs you get redundancy of your data." /><meta property="og:image" content="https://mutschler.dev/media/icon_hu589851f325050e29bd29c51f9d799271_45964_512x512_fill_lanczos_center_3.png" />
    <meta property="twitter:image" content="https://mutschler.dev/media/icon_hu589851f325050e29bd29c51f9d799271_45964_512x512_fill_lanczos_center_3.png" /><meta property="og:locale" content="en-us" />
  
    
      <meta
        property="article:published_time"
        content="2020-04-21T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2022-08-14T20:11:21&#43;02:00">
  

  



  

  


  <title>Pop!_OS 20.04: installation guide with btrfs-LVM-luks-RAID1 and auto-apt snapshots with Timeshift | mutschler.dev</title>

  
  
  
  











</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper  dark " data-wc-page-id="3cae6052902c1871f0f16cd8cfd091ed" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.22ad66a4f96b4e9da14bbb023ea57684.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="Search...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    












<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/">mutschler.dev</a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/">mutschler.dev</a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/apple/"><span>Apple</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/linux/"><span>Linux</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/stuff/"><span>Stuff</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://buymeacoffee.com/mutschler" data-toggle="tooltip" data-placement="bottom" title="Buy me a coffee" target="_blank" rel="noopener" aria-label="Buy me a coffee">
                <i class="fas fa-coffee" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="mailto:willi@mutschler.dev" data-toggle="tooltip" data-placement="bottom" title="Write me an email"  aria-label="Write me an email">
                <i class="fas fa-envelope" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://github.com/wmutschl" data-toggle="tooltip" data-placement="bottom" title="Follow me on GitHub" target="_blank" rel="noopener" aria-label="Follow me on GitHub">
                <i class="fab fa-github" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://gitlab.com/wmutschl" data-toggle="tooltip" data-placement="bottom" title="Follow me on Gitlab" target="_blank" rel="noopener" aria-label="Follow me on Gitlab">
                <i class="fab fa-gitlab" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://www.youtube.com/c/wmutschl" data-toggle="tooltip" data-placement="bottom" title="Follow me on YouTube" target="_blank" rel="noopener" aria-label="Follow me on YouTube">
                <i class="fab fa-youtube" aria-hidden="true"></i>
              </a>
            </li>
          
        

        
        
        <li class="nav-item">
          <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    




<div class="container-fluid docs">
  <div class="row flex-xl-nowrap">
    <div class="col-12 col-md-3 col-xl-2 docs-sidebar">
      <form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <div class="d-flex">
      <span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">
        
        
          Linux
        
      </span>
      <span><i class="fas fa-chevron-down"></i></span>
    </div>
  </button>

  
  <button class="form-control sidebar-search js-search d-none d-md-flex">
    <i class="fas fa-search pr-2"></i>
    <span class="sidebar-search-text">Search...</span>
    <span class="sidebar-search-shortcut">/</span>
  </button>
  
</form>

<nav class="collapse docs-links" id="docs-nav">
  
  
  
  
  
  

  
  
    

    
      

      


  
    
    
    
    
      
    
    

    
      <ul class="nav docs-sidenav">
        <li class=""><a href="/linux/">Linux</a></li>
    
      


  <li class=""><a href="/linux/pop-os-btrfs-24-04/">Pop!_OS 24.04: installation guide with BTRFS, LUKS encryption and auto snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/elementary-os-post-install/">elementary OS: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/elementary-os-6-1/">elementary OS 6.1 JÃ³lnir: installation guide with btrfs, luks encryption and auto snapshots with timeshift</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-22-04/">Pop!_OS 22.04: installation guide with btrfs, luks encryption and auto snapshots with timeshift</a></li>



  <li class=""><a href="/linux/pop-os-post-install/">Pop!_OS: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/fedora-post-install/">Fedora Workstation: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/fedora-btrfs-35/">Fedora Workstation 35 with automatic btrfs snapshots and backups using BTRBK</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-21-10/">DRAFT: Pop!_OS 21.10: installation guide with btrfs-LVM-luks and auto snapshots with BTRBK</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-21-04/">Pop!_OS 21.04: installation guide with btrfs-LVM-luks and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/raspi-post-install/">Ubuntu Server Raspberry Pi: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/raspi-btrfs/">Ubuntu Server 20.10 on Raspberry Pi 4: installation guide with USB Boot (no SD card) and full disk encryption (excluding /boot) using btrfs-inside-luks and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/fedora-btrfs-33/">Fedora Workstation 33: installation guide with btrfs-luks full disk encryption (optionally including /boot) and auto snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/btrfs/">Why I (still) like btrfs</a></li>



  <li class=""><a href="/linux/ubuntu-btrfs-raid1-20-04/">Ubuntu Desktop 20.04: installation guide with btrfs-luks-RAID1 full disk encryption including /boot and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/ubuntu-btrfs-20-04/">Ubuntu Desktop 20.04: installation guide with btrfs-luks full disk encryption including /boot and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/ubuntu-post-install/">Ubuntu Desktop: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class="active"><a href="/linux/pop-os-btrfs-raid1-20-04/">Pop!_OS 20.04: installation guide with btrfs-LVM-luks-RAID1 and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-20-04/">Pop!_OS 20.04: installation guide with btrfs-LVM-luks and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/timeshift/">Timeshift</a></li>

      
    

    
      </ul>
    

  
</nav>

    </div>

    
    
    <div class="d-none d-xl-block col-xl-2 docs-toc">
      












      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
      </ul>

      <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#step-0-general-remarks">Step 0: General remarks</a></li>
    <li><a href="#step-1-boot-the-install-check-uefi-mode-and-open-an-interactive-root-shell">Step 1: Boot the install, check UEFI mode and open an interactive root shell</a></li>
    <li><a href="#step-2-prepare-partitions-manually">Step 2: Prepare partitions manually</a>
      <ul>
        <li><a href="#create-partition-table-and-layout">Create partition table and layout</a></li>
        <li><a href="#create-luks2-partitions-lvm-and-btrfs-root-filesystems">Create luks2 partitions, LVM and btrfs root filesystems</a></li>
      </ul>
    </li>
    <li><a href="#step-3-install-pop_os-using-the-graphical-installer">Step 3: Install POP!_OS using the graphical installer</a></li>
    <li><a href="#step-4-post-installation-steps">Step 4: Post-Installation steps</a>
      <ul>
        <li><a href="#mount-the-btrfs-top-level-root-filesystem">Mount the btrfs top-level root filesystem</a></li>
        <li><a href="#create-raid-1-for-root-filesystem-using-btrfs-balance">Create RAID 1 for root filesystem using btrfs balance</a></li>
        <li><a href="#create-btrfs-subvolumes--and-home">Create btrfs subvolumes <code>@</code> and <code>@home</code></a></li>
        <li><a href="#create-a-chroot-environment-and-enter-your-system">Create a chroot environment and enter your system</a></li>
        <li><a href="#adjust-configuration-of-crypttab-systemd-bootloader-and-kernelstub">Adjust configuration of crypttab, systemd bootloader and kernelstub</a></li>
      </ul>
    </li>
    <li><a href="#step-5-reboot-some-checks-and-update-system">Step 5: Reboot, some checks, and update system</a></li>
    <li><a href="#step-6-create-degraded-boot-entry">Step 6: Create degraded boot entry</a></li>
    <li><a href="#step-7-make-duplicate-of-recovery-partition-and-create-separate-boot-entries">Step 7: Make duplicate of recovery partition and create separate boot entries</a></li>
    <li><a href="#step-8-make-duplicate-of-efi">Step 8: Make duplicate of EFI</a></li>
    <li><a href="#step-9-install-timeshift-and-timeshift-autosnap-apt">Step 9: Install Timeshift and timeshift-autosnap-apt</a></li>
    <li><a href="#step-10-wip-keep-efi-partitions-in-sync">Step 10 (WIP): Keep efi partitions in sync</a></li>
    <li><a href="#emergency-scenario-raid1-is-broken">Emergency scenario: RAID1 is broken</a>
      <ul>
        <li><a href="#wip-efi-is-broken">[WIP] efi is broken</a></li>
        <li><a href="#vda-is-broken">vda is broken</a></li>
        <li><a href="#vdb-is-broken">vdb is broken</a></li>
      </ul>
    </li>
  </ul>
</nav>

      











    </div>
    

    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role="main">

      <article class="article">

        <div class="docs-article-container">
          
        </div>

        
        

        <div class="docs-article-container">
          
          <h1>Pop!_OS 20.04: installation guide with btrfs-LVM-luks-RAID1 and auto-apt snapshots with Timeshift</h1>

          <div class="article-style">

            
            

            <p><em><strong>Please feel free to raise any comments or issues on the <a href="https://github.com/wmutschl/mutschler.dev" target="_blank" rel="noopener">website&rsquo;s Github repository</a>. Pull requests are very much appreciated.</strong></em>
<a href="https://www.buymeacoffee.com/mutschler" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-red.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;" ></a></p>
<p>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/teD1bQ7rn9c" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<em>Note that this written guide is an updated version of the video and contains much more information.</em>
<details class="toc-inpage d-print-none d-xl-none " open>
  <summary class="font-weight-bold">Table of Contents</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#step-0-general-remarks">Step 0: General remarks</a></li>
    <li><a href="#step-1-boot-the-install-check-uefi-mode-and-open-an-interactive-root-shell">Step 1: Boot the install, check UEFI mode and open an interactive root shell</a></li>
    <li><a href="#step-2-prepare-partitions-manually">Step 2: Prepare partitions manually</a>
      <ul>
        <li><a href="#create-partition-table-and-layout">Create partition table and layout</a></li>
        <li><a href="#create-luks2-partitions-lvm-and-btrfs-root-filesystems">Create luks2 partitions, LVM and btrfs root filesystems</a></li>
      </ul>
    </li>
    <li><a href="#step-3-install-pop_os-using-the-graphical-installer">Step 3: Install POP!_OS using the graphical installer</a></li>
    <li><a href="#step-4-post-installation-steps">Step 4: Post-Installation steps</a>
      <ul>
        <li><a href="#mount-the-btrfs-top-level-root-filesystem">Mount the btrfs top-level root filesystem</a></li>
        <li><a href="#create-raid-1-for-root-filesystem-using-btrfs-balance">Create RAID 1 for root filesystem using btrfs balance</a></li>
        <li><a href="#create-btrfs-subvolumes--and-home">Create btrfs subvolumes <code>@</code> and <code>@home</code></a></li>
        <li><a href="#create-a-chroot-environment-and-enter-your-system">Create a chroot environment and enter your system</a></li>
        <li><a href="#adjust-configuration-of-crypttab-systemd-bootloader-and-kernelstub">Adjust configuration of crypttab, systemd bootloader and kernelstub</a></li>
      </ul>
    </li>
    <li><a href="#step-5-reboot-some-checks-and-update-system">Step 5: Reboot, some checks, and update system</a></li>
    <li><a href="#step-6-create-degraded-boot-entry">Step 6: Create degraded boot entry</a></li>
    <li><a href="#step-7-make-duplicate-of-recovery-partition-and-create-separate-boot-entries">Step 7: Make duplicate of recovery partition and create separate boot entries</a></li>
    <li><a href="#step-8-make-duplicate-of-efi">Step 8: Make duplicate of EFI</a></li>
    <li><a href="#step-9-install-timeshift-and-timeshift-autosnap-apt">Step 9: Install Timeshift and timeshift-autosnap-apt</a></li>
    <li><a href="#step-10-wip-keep-efi-partitions-in-sync">Step 10 (WIP): Keep efi partitions in sync</a></li>
    <li><a href="#emergency-scenario-raid1-is-broken">Emergency scenario: RAID1 is broken</a>
      <ul>
        <li><a href="#wip-efi-is-broken">[WIP] efi is broken</a></li>
        <li><a href="#vda-is-broken">vda is broken</a></li>
        <li><a href="#vdb-is-broken">vdb is broken</a></li>
      </ul>
    </li>
  </ul>
</nav>
</details>
</p>
<h2 id="overview">Overview</h2>
<p>Since a couple of months, I am exclusively using btrfs as my filesystem on all my systems, see <a href="../btrfs/">Why I (still) like btrfs</a>. So, in this guide I will show how to install Pop!_OS 20.04 with the following structure:</p>
<ul>
<li>a btrfs-LVM-inside-luks partition for the root filesystem on two hard disks in a RAID1 managed by btrfs
<ul>
<li>the btrfs logical volume contains a subvolume <code>@</code> for <code>/</code> and a subvolume <code>@home</code> for <code>/home</code>. Note that the Pop!_OS installer does not create any subvolumes on btrfs, so we need to do this manually.</li>
</ul>
</li>
<li>an encrypted swap partition</li>
<li>an unencrypted EFI partition for the systemd bootloader duplicated on both disks</li>
<li>an unencrypted partition for the Pop!_OS recovery system duplicated on both disks</li>
<li>automatic system snapshots and easy rollback similar to <em>zsys</em> using:
<ul>
<li><a href="https://github.com/teejee2008/timeshift" target="_blank" rel="noopener">Timeshift</a> which will regularly take (almost instant) snapshots of the system</li>
<li><a href="https://github.com/wmutschl/timeshift-autosnap-apt" target="_blank" rel="noopener">timeshift-autosnap-apt</a> which will automatically run Timeshift on any APT operation and also keep a backup of your EFI partition inside the snapshot</li>
</ul>
</li>
<li>If you don&rsquo;t need RAID1, follow this guide: <a href="../pop-os-btrfs-20-04">Pop!_OS 20.04 btrfs-luks</a></li>
</ul>
<p>With this setup you basically get the same comfort of Ubuntu&rsquo;s 20.04&rsquo;s ZFS and <em>zsys</em> initiative, but with much more flexibility and comfort due to the awesome <a href="https://github.com/teejee2008/timeshift" target="_blank" rel="noopener">Timeshift</a> program, which saved my bacon quite a few times. This setup works similarly well on other distributions, for which I also have <a href="../../install-guides">installation guides with optional RAID1</a>.</p>
<p><strong>If you ever need to rollback your system, checkout <a href="../../timeshift/">Recovery and system rollback with Timeshift</a>.</strong>
In the video, I also show what to do if your RAID1 is broken.</p>
<h2 id="step-0-general-remarks">Step 0: General remarks</h2>
<p><strong>I strongly advise to try the following installation steps in a virtual machine first before doing anything like that on real hardware!</strong></p>
<p>So, let&rsquo;s spin up a virtual machine with 4 cores, 8 GB RAM, and two 64GB disk using e.g. my fork of the awesome bash script <a href="https://github.com/wmutschl/quickemu" target="_blank" rel="noopener">quickemu</a> to automatically create 2 disks. I can confirm that the installation works equally well on my Dell Precision 7520 (RAID1 between a SSD and NVME).</p>
<p>This tutorial is made with Pop!_OS 20.04 from <a href="https://system76.com/pop" target="_blank" rel="noopener">https://system76.com/pop</a> copied to an installation media (usually a USB Flash device but may be a DVD or the ISO file attached to a virtual machine hypervisor). Other versions of Pop!_OS and other distributions that use Systemd boot manager should also work, see my other <a href="../../install-guides">installation guides</a>.</p>
<h2 id="step-1-boot-the-install-check-uefi-mode-and-open-an-interactive-root-shell">Step 1: Boot the install, check UEFI mode and open an interactive root shell</h2>
<p>Since most modern PCs have UEFI, I will cover only the UEFI installation (see the <a href="../../references/#btrfs-installation-guides">References</a> on how to deal with Legacy installs). So, boot the installation medium in UEFI mode and choose <code>Try or install Pop!_OS</code>. Once the Live Desktop environment has started choose your language, region, and keyboard layout, then hit <code>Try Demo Mode</code>. Open a terminal (<kbd>META</kbd> + <kbd>T</kbd>) and run the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mount <span class="p">|</span> grep efivars
</span></span><span class="line"><span class="cl"><span class="c1"># efivarfs on /sys/firmware/efi/efivars type efivarfs (rw,nosuid,nodev,noexec,relatime)</span>
</span></span></code></pre></div><p>to detect whether you are in UEFI mode. Now switch to an interactive root session:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo -i
</span></span></code></pre></div><p>You might find maximizing the terminal window is helpful for working with the command-line. Do not close this terminal window during the whole installation process until we are finished with everything.</p>
<h2 id="step-2-prepare-partitions-manually">Step 2: Prepare partitions manually</h2>
<h3 id="create-partition-table-and-layout">Create partition table and layout</h3>
<p>First find out the name of your drive. For me the installation target device is called <code>vda</code> and I will use <code>vdb</code> for the RAID1 managed by btrfs:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">lsblk
</span></span><span class="line"><span class="cl"><span class="c1"># NAME  MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span>
</span></span><span class="line"><span class="cl"><span class="c1"># loop0   7:0    0    2G  1 loop /rofs</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sr0    11:0    1  2.1G  0 rom  /cdrom</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sr1    11:1    1 1024M  0 rom  </span>
</span></span><span class="line"><span class="cl"><span class="c1"># sr2    11:2    1 1024M  0 rom  </span>
</span></span><span class="line"><span class="cl"><span class="c1"># vda   252:0    0   64G  0 disk </span>
</span></span><span class="line"><span class="cl"><span class="c1"># vdb   252:16   0   64G  0 disk </span>
</span></span></code></pre></div><p>You can also open <code>gparted</code> or have a look into the <code>/dev</code> folder to make sure what your hard drives are called. In most cases they are called <code>sda</code> and <code>sdb</code> for normal SSD and HDD, whereas for NVME storage the naming is <code>nvme0</code> and <code>nvme1</code>. Also note that there are no partitions or data on my hard drive, you should always double check which partition layout fits your use case, particularly if you dual-boot with other systems.</p>
<p>We&rsquo;ll now create a disk table and add three partitions on <code>vda</code> and <code>vdb</code>:</p>
<ol>
<li>a 498 MiB FAT32 EFI partition for the systemd bootloader</li>
<li>a 4 GiB FAT32 partition for the Pop!_OS recovery system</li>
<li>a 4 GiB partition for encrypted swap use</li>
<li>a luks2 encrypted partition which contains a LVM with one logical volume formatted with btrfs, which will be our root filesystem</li>
</ol>
<p>Some remarks:</p>
<ul>
<li>The LVM is actually a bit of an overkill for my typical use case, but otherwise the installer cannot access the luks partition.</li>
<li><code>/boot</code> will reside on the encrypted partition. The systemd bootloader is able to decrypt this at boot time.</li>
<li>With btrfs I do not need any other partitions for e.g. <code>/home</code>, as we will use subvolumes instead.</li>
<li>As we plan to use RAID1 managed by btrfs, we cannot use swapfiles as these are not supported in RAID1.</li>
</ul>
<p>Let&rsquo;s use <code>parted</code> for this (feel free to use <code>gparted</code> accordingly):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">parted /dev/vda
</span></span><span class="line"><span class="cl">  mklabel gpt
</span></span><span class="line"><span class="cl">  mkpart primary fat32 2MiB 500MiB
</span></span><span class="line"><span class="cl">  mkpart primary fat32 500MiB 4596MiB
</span></span><span class="line"><span class="cl">  mkpart primary linux-swap 4596MiB 8692MiB
</span></span><span class="line"><span class="cl">  mkpart primary 8692MiB 100%
</span></span><span class="line"><span class="cl">  <span class="nb">set</span> <span class="m">1</span> bios_grub on
</span></span><span class="line"><span class="cl">  <span class="nb">set</span> <span class="m">1</span> esp on
</span></span><span class="line"><span class="cl">  <span class="nb">set</span> <span class="m">3</span> swap on
</span></span><span class="line"><span class="cl">  print
</span></span><span class="line"><span class="cl"><span class="c1"># Model: Virtio Block Device (virtblk)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Disk /dev/vda: 68.7GB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sector size (logical/physical): 512B/512B</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Partition Table: gpt</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Disk Flags: </span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Number  Start   End     Size    File system     Name     Flags</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  1      2097kB  524MB   522MB   fat32           primary  boot, esp</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  2      524MB   4819MB  4295MB  fat32           primary</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  3      4819MB  9114MB  4295MB  linux-swap(v1)  primary  swap</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  4      9114MB  68.7GB  59.6GB                  primary</span>
</span></span><span class="line"><span class="cl">  quit
</span></span></code></pre></div><p>And the same commands for <code>vdb</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">parted /dev/vdb
</span></span><span class="line"><span class="cl">  mklabel gpt
</span></span><span class="line"><span class="cl">  mkpart primary fat32 2MiB 500MiB
</span></span><span class="line"><span class="cl">  mkpart primary fat32 500MiB 4596MiB
</span></span><span class="line"><span class="cl">  mkpart primary linux-swap 4596MiB 8692MiB
</span></span><span class="line"><span class="cl">  mkpart primary 8692MiB 100%
</span></span><span class="line"><span class="cl">  <span class="nb">set</span> <span class="m">1</span> bios_grub on
</span></span><span class="line"><span class="cl">  <span class="nb">set</span> <span class="m">1</span> esp on
</span></span><span class="line"><span class="cl">  <span class="nb">set</span> <span class="m">3</span> swap on
</span></span><span class="line"><span class="cl">  print
</span></span><span class="line"><span class="cl"><span class="c1"># Model: Virtio Block Device (virtblk)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Disk /dev/vdb: 68.7GB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sector size (logical/physical): 512B/512B</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Partition Table: gpt</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Disk Flags: </span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Number  Start   End     Size    File system     Name     Flags</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  1      2097kB  524MB   522MB   fat32           primary  boot, esp</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  2      524MB   4819MB  4295MB  fat32           primary</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  3      4819MB  9114MB  4295MB  linux-swap(v1)  primary  swap</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  4      9114MB  68.7GB  59.6GB                  primary</span>
</span></span><span class="line"><span class="cl">  quit
</span></span></code></pre></div><h3 id="create-luks2-partitions-lvm-and-btrfs-root-filesystems">Create luks2 partitions, LVM and btrfs root filesystems</h3>
<p>Pop!_OS uses the systemd bootloader, which can handle luks type 2 encryption just fine at boot time, so we can use the default options of <code>cryptsetup luksFormat</code> to format our <code>vda4</code> and <code>vdb4</code> partitions and map them to devices called <code>crypt_vda</code> and <code>crypt_vdb</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cryptsetup luksFormat /dev/vda4
</span></span><span class="line"><span class="cl"><span class="c1"># WARNING!</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ========</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This will overwrite data on /dev/vda4 irrevocably.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Are you sure? (Type uppercase yes): YES</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Enter passphrase for /dev/vda4: </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Verify passphrase:</span>
</span></span><span class="line"><span class="cl">cryptsetup luksFormat /dev/vdb4
</span></span><span class="line"><span class="cl"><span class="c1"># WARNING!</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ========</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This will overwrite data on /dev/vdb4 irrevocably.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Are you sure? (Type uppercase yes): YES</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Enter passphrase for /dev/vdb4: </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Verify passphrase:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cryptsetup luksOpen /dev/vda4 crypt_vda
</span></span><span class="line"><span class="cl"><span class="c1"># Enter passphrase for /dev/vda4:</span>
</span></span><span class="line"><span class="cl">cryptsetup luksOpen /dev/vdb4 crypt_vdb
</span></span><span class="line"><span class="cl"><span class="c1"># Enter passphrase for /dev/vdb4:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ls /dev/mapper
</span></span><span class="line"><span class="cl"><span class="c1"># control  crypt_vda  crypt_vdb</span>
</span></span></code></pre></div><p>Use very good passwords here. Now we need to create the LVM for the Pop!_OS installer:</p>
<ul>
<li>make <code>crypt_vda</code> and <code>crypt_vdb</code> physical volumes</li>
<li>add new volume groups called <code>data_vda</code> and <code>data_vdb</code></li>
<li>create a logical volume inside both volume groups named <code>root</code></li>
</ul>
<p>These are also the steps the POP!_OS installer performs when you click <code>Clean install</code>, albeit with ext4 as the filesystem and another logical volume for encrypted swap. So here are the commands:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pvcreate /dev/mapper/crypt_vda
</span></span><span class="line"><span class="cl"><span class="c1"># Physical volume &#34;/dev/mapper/crypt_vda&#34; successfully created</span>
</span></span><span class="line"><span class="cl">pvcreate /dev/mapper/crypt_vdb
</span></span><span class="line"><span class="cl"><span class="c1"># Physical volume &#34;/dev/mapper/crypt_vdb&#34; successfully created</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vgcreate data_vda /dev/mapper/crypt_vda
</span></span><span class="line"><span class="cl"><span class="c1"># Volume group &#34;data_vda&#34; successfully created</span>
</span></span><span class="line"><span class="cl">vgcreate data_vdb /dev/mapper/crypt_vdb
</span></span><span class="line"><span class="cl"><span class="c1"># Volume group &#34;data_vdb&#34; successfully created</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">lvcreate -n root -l 100%FREE data_vda
</span></span><span class="line"><span class="cl"><span class="c1"># Logical volume &#34;root&#34; created.</span>
</span></span><span class="line"><span class="cl">lvcreate -n root -l 100%FREE data_vdb
</span></span><span class="line"><span class="cl"><span class="c1"># Logical volume &#34;root&#34; created.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ls /dev/mapper/
</span></span><span class="line"><span class="cl"><span class="c1"># control  crypt_vda  crypt_vdb  data_vda-root  data_vdb-root</span>
</span></span><span class="line"><span class="cl">cryptsetup luksClose /dev/mapper/data_vda-root
</span></span><span class="line"><span class="cl">cryptsetup luksClose /dev/mapper/data_vdb-root
</span></span><span class="line"><span class="cl">cryptsetup luksClose /dev/mapper/crypt_vda
</span></span><span class="line"><span class="cl">cryptsetup luksClose /dev/mapper/crypt_vdb
</span></span><span class="line"><span class="cl">ls /dev/mapper
</span></span><span class="line"><span class="cl"><span class="c1"># control</span>
</span></span></code></pre></div><p><code>data_vda-root</code> will be the installation target for root during the graphical installer. We will use the Pop!_OS installer to format it to btrfs and install the system to it. After the installation we create the RAID1 with btrfs between <code>data_vda-root</code> and <code>data_vdb-root</code>, and also create two subvolumes:</p>
<ul>
<li><code>@</code> for <code>/</code></li>
<li><code>@home</code> for <code>/home</code>
This is due to the fact that the Pop!_OS installer does not create any subvolumes by default, so we will do that manually.</li>
</ul>
<h2 id="step-3-install-pop_os-using-the-graphical-installer">Step 3: Install POP!_OS using the graphical installer</h2>
<p>Now let&rsquo;s return to the installation process choose <code>Custom (Advanced)</code>. You will see your partitioned hard disk:</p>
<ul>
<li>Click on the first partition on vda, activate <code>Use partition</code>, activate <code>Format</code>, Use as <code>Boot /boot/efi</code>, Filesystem: <code>fat32</code>.</li>
<li>Click on the second partition on vda, activate <code>Use partition</code>, activate <code>Format</code>, Use as <code>Custom</code> and enter <code>/recovery</code>, Filesystem: <code>fat32</code>.</li>
<li>Click on the third partition on vda, activate <code>Use partition</code>, Use as <code>Swap</code>.</li>
<li>Click on the fourth and largest partition on vda. A <code>Decrypt This Partition</code> dialog opens, enter your luks password and change the name to <code>crypt_vda</code>, hit <code>Decrypt</code>. A new line is displayed <code>LVM data_vda /dev/mapper/data_vda</code>. Click on this partition, activate <code>Use partition</code>, activate <code>Format</code>, Use as <code>Root (/)</code> , Filesystem: <code>btrfs</code>.</li>
<li>Click on the fourth and largest partition on vdb. A <code>Decrypt This Partition</code> dialog opens, enter your luks password and change the name to <code>crypt_vdb</code>, hit <code>Decrypt</code>. A new line is displayed <code>LVM data_vdb /dev/mapper/data_vdb</code>.</li>
<li>If you have other partitions, check their types and use; particularly, deactivate other EFI partitions.</li>
</ul>
<p>Recheck everything (check the partitions where there is a black checkmark) and hit <code>Erase and Install</code> to write the changes to the disk. Once the installer finishes do NOT <strong>Restart Device</strong>, but return to your terminal.</p>
<h2 id="step-4-post-installation-steps">Step 4: Post-Installation steps</h2>
<h3 id="mount-the-btrfs-top-level-root-filesystem">Mount the btrfs top-level root filesystem</h3>
<p>Let&rsquo;s mount our root partition (the top-level btrfs volume always has root-id 5), but with mount options that optimize performance and durability on SSD or NVME drives:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cryptsetup luksOpen /dev/vda4 crypt_vda
</span></span><span class="line"><span class="cl"><span class="c1"># Enter passphrase for /dev/vda4</span>
</span></span><span class="line"><span class="cl">cryptsetup luksOpen /dev/vdb4 crypt_vdb
</span></span><span class="line"><span class="cl"><span class="c1"># Enter passphrase for /dev/vdb4</span>
</span></span><span class="line"><span class="cl">mount -o defaults,subvolid<span class="o">=</span>5,ssd,noatime,space_cache,commit<span class="o">=</span>120,compress<span class="o">=</span>zstd /dev/mapper/data_vda-root /mnt
</span></span></code></pre></div><p>I have found that there is some general agreement to use the following mount options, namely:</p>
<ul>
<li><code>ssd</code>: use SSD specific options for optimal use on SSD and NVME</li>
<li><code>noatime</code>: prevent frequent disk writes by instructing the Linux kernel not to store the last access time of files and folders (noatime also includes nodiratime)</li>
<li><code>space_cache</code>: allows btrfs to store free space cache on the disk to make caching of a block group much quicker</li>
<li><code>commit=120</code>: time interval in which data is written to the filesystem (value of 120 is taken from Manjaro&rsquo;s minimal iso)</li>
<li><code>compress=zstd</code>: compress allows us to specify the compression algorithm which we want to use. btrfs provides lzo, zstd and zlib compression algorithms. Based on some phoronix test cases, zstd seems to be the better performing candidate.</li>
</ul>
<h3 id="create-raid-1-for-root-filesystem-using-btrfs-balance">Create RAID 1 for root filesystem using btrfs balance</h3>
<p>Currently btrfs uses only one device <code>/dev/mapper/data_vda-root</code>, so let&rsquo;s add our other encrypted device <code>/dev/mapper/data_vdb-root</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">btrfs filesystem show /mnt
</span></span><span class="line"><span class="cl"><span class="c1"># Label: none  uuid: c277ed84-e32f-4204-a211-1d80596e6e15</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Total devices 1 FS bytes used 5.08GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	devid    1 size 55.49GiB used 8.02GiB path /dev/mapper/data_vda-root</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">btrfs device add /dev/mapper/data_vdb-root /mnt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">btrfs filesystem show /mnt
</span></span><span class="line"><span class="cl"><span class="c1"># Label: none  uuid: c277ed84-e32f-4204-a211-1d80596e6e15</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Total devices 2 FS bytes used 5.08GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	devid    1 size 55.49GiB used 8.02GiB path /dev/mapper/data_vda-root</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	devid    2 size 55.49GiB used 0.00B path /dev/mapper/data_vdb-root</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">btrfs filesystem usage /mnt
</span></span><span class="line"><span class="cl"><span class="c1"># Overall:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Device size:		 110.98GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Device allocated:	   8.02GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Device unallocated:	 102.96GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Device missing:		     0.00B</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Used:			   5.27GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Free (estimated):	 104.07GiB	(min: 52.59GiB)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Data ratio:		   1.00</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Metadata ratio:		   2.00</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Global reserve:		  14.70MiB	(used: 0.00B)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Data,single: Size:6.01GiB, Used:4.90GiB (81.52%)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    /dev/mapper/data_vda-root	   6.01GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Metadata,DUP: Size:1.00GiB, Used:191.64MiB (18.71%)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    /dev/mapper/data_vda-root	   2.00GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># System,DUP: Size:8.00MiB, Used:16.00KiB (0.20%)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    /dev/mapper/data_vda-root	  16.00MiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Unallocated:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/data_vda-root	  47.47GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/data_vdb-root	  55.49GiB</span>
</span></span></code></pre></div><p>Note, however, that on the second device there is no data yet (see the &ldquo;single&rdquo; and &ldquo;DUP&rdquo; flags of the above &ldquo;usage&rdquo; command). We need to move the data chunks around to have a working RAID1 and btrfs has a balance command just for this case: &ldquo;A balance passes all data in the filesystem through the allocator again. It is primarly intended to rebalance the data in the filesystem across the devices when a device eis added or removed. A balance will regenerate missing copies for the redundant <em>RAID</em> levels, if a device has failed&rdquo;.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">btrfs balance start -dconvert<span class="o">=</span>raid1 -mconvert<span class="o">=</span>raid1 /mnt
</span></span><span class="line"><span class="cl"><span class="c1"># Done, had to relocate 9 out of 9 chunks</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">btrfs filesystem usage /mnt
</span></span><span class="line"><span class="cl"><span class="c1"># Overall:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Device size:		 110.98GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Device allocated:	  18.06GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Device unallocated:	  92.92GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Device missing:		   0.00B</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Used:			  10.18GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Free (estimated):	  48.56GiB	(min: 48.56GiB)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Data ratio:		   2.00</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Metadata ratio:		   2.00</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Global reserve:		  18.05MiB	(used: 0.00B)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Data,RAID1: Size:7.00GiB, Used:4.90GiB (69.97%)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    /dev/mapper/data_vda-root	   7.00GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    /dev/mapper/data_vdb-root	   7.00GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Metadata,RAID1: Size:2.00GiB, Used:194.98MiB (9.52%)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    /dev/mapper/data_vda-root	   2.00GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    /dev/mapper/data_vdb-root	   2.00GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># System,RAID1: Size:32.00MiB, Used:16.00KiB (0.05%)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    /dev/mapper/data_vda-root	  32.00MiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    /dev/mapper/data_vdb-root	  32.00MiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Unallocated:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    /dev/mapper/data_vda-root	  46.46GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    /dev/mapper/data_vdb-root	  46.46GiB</span>
</span></span></code></pre></div><p>You can monitor the progress in a new terminal using <code>sudo btrfs balance status /mnt</code>. Rarely, one gets an ERROR &ldquo;out of space&rdquo; or the output of <code>sudo btrfs filesystem usage /mnt</code> still shows &ldquo;Data,single&rdquo; or &ldquo;Metadata,single&rdquo; (instead of the &ldquo;RAID1&rdquo; tag like above), then you should try to run with different values for &ldquo;dusage&rdquo; and &ldquo;musage&rdquo;, starting with e.g. 90:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">btrfs balance start -dconvert<span class="o">=</span>raid1 -mconvert<span class="o">=</span>raid1 -dusage<span class="o">=</span><span class="m">95</span> -musage<span class="o">=</span><span class="m">95</span> /mnt
</span></span><span class="line"><span class="cl">btrfs filesystem usage /mnt
</span></span></code></pre></div><p>and try to lower values for dusage and musage by 5 (one at a time), until there is the &ldquo;RAID1&rdquo; tag everywhere and all chunks are reallocated. Note also that you cannot have a swapfile in a RAID1, so deactivate and delete it, if you have one for some reason.</p>
<h3 id="create-btrfs-subvolumes--and-home">Create btrfs subvolumes <code>@</code> and <code>@home</code></h3>
<p>Now we will first create the subvolume <code>@</code> and move all files and folders from the top-level filesystem into it. Note that as we use the optimized mount options like compression, these will be applied during the moving process:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /mnt
</span></span><span class="line"><span class="cl">btrfs subvolume create /mnt/@
</span></span><span class="line"><span class="cl"><span class="c1"># Create subvolume &#39;/mnt/@&#39;</span>
</span></span><span class="line"><span class="cl">ls <span class="p">|</span> grep -v @ <span class="p">|</span> xargs mv -t @
</span></span><span class="line"><span class="cl">ls /mnt
</span></span><span class="line"><span class="cl"><span class="c1"># @</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /
</span></span></code></pre></div><p>Now let&rsquo;s create another subvolume <code>@home</code> in order to mount <code>/home</code> to it. Note that the Pop!_OS installer has not created a user yet, so there is nothing in <code>/home</code> we need to copy over.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">btrfs subvolume create /mnt/@home
</span></span><span class="line"><span class="cl"><span class="c1"># Create subvolume &#39;/mnt/@home&#39;</span>
</span></span><span class="line"><span class="cl">btrfs subvolume list /mnt
</span></span><span class="line"><span class="cl"><span class="c1"># ID 269 gen 118 top level 5 path @</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ID 270 gen 118 top level 5 path @home</span>
</span></span></code></pre></div><p>Now we need to adapt the mount options in <code>fstab</code> with a text editor, e.g.:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nano /mnt/@/etc/fstab
</span></span></code></pre></div><p>or use these <code>sed</code> and <code>echo</code> commands:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sed -i <span class="s1">&#39;/cryptswap/d&#39;</span> /mnt/@/etc/fstab <span class="c1">#temporarily remove the cryptswap line</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/defaults/defaults,subvol=@,ssd,noatime,space_cache,commit=120,compress=zstd/&#39;</span> /mnt/@/etc/fstab
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;UUID=</span><span class="k">$(</span>blkid -s UUID -o value /dev/mapper/data_vda-root<span class="k">)</span><span class="s2">   /home   btrfs   defaults,subvol=@home,ssd,noatime,space_cache,commit=120,compress=zstd   0 0&#34;</span> &gt;&gt; /mnt/@/etc/fstab
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;/dev/mapper/cryptswap  none  swap  defaults  0  0&#34;</span> &gt;&gt; /mnt/@/etc/fstab <span class="c1">#add the cryptswap file back</span>
</span></span></code></pre></div><p>Either way your <code>fstab</code> should look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat /mnt/@/etc/fstab
</span></span><span class="line"><span class="cl"><span class="c1"># PARTUUID=7109bb96-1c90-48bf-b290-a475996aa97b  /boot/efi  vfat  umask=0077  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># PARTUUID=6316f309-81a6-476b-b804-ae315d5e5ae3  /recovery  vfat  umask=0077  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=c277ed84-e32f-4204-a211-1d80596e6e15  /  btrfs  defaults,subvol=@,ssd,noatime,space_cache,commit=120,compress=zstd  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=c277ed84-e32f-4204-a211-1d80596e6e15   /home   btrfs   defaults,subvol=@home,ssd,noatime,space_cache,commit=120,compress=zstd   0 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptswap  none  swap  defaults  0  0</span>
</span></span></code></pre></div><p>Note that the mount options for <code>@</code> and <code>@home</code> are the same.</p>
<h3 id="create-a-chroot-environment-and-enter-your-system">Create a chroot environment and enter your system</h3>
<p>Now, let&rsquo;s create a chroot environment, which enables you to work directly inside your newly installed OS, without actually rebooting. For this, unmount the top-level root filesystem from <code>/mnt</code> and remount the subvolume <code>@</code> which we created for <code>/</code> to <code>/mnt</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /
</span></span><span class="line"><span class="cl">umount -l /mnt
</span></span><span class="line"><span class="cl">mount -o defaults,subvol<span class="o">=</span>@,ssd,noatime,space_cache,commit<span class="o">=</span>120,compress<span class="o">=</span>zstd /dev/mapper/data_vda-root /mnt
</span></span><span class="line"><span class="cl">ls /mnt
</span></span><span class="line"><span class="cl"><span class="c1"># bin   dev  home           lib    lib64   media  opt   recovery  run   srv  tmp  var</span>
</span></span><span class="line"><span class="cl"><span class="c1"># boot  etc  installer.log  lib32  libx32  mnt    proc  root      sbin  sys  usr</span>
</span></span></code></pre></div><p>Then the following commands put us into our system using chroot:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">for</span> i in /dev /dev/pts /proc /sys /run<span class="p">;</span> <span class="k">do</span> sudo mount -B <span class="nv">$i</span> /mnt<span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>
</span></span><span class="line"><span class="cl">sudo cp /etc/resolv.conf /mnt/etc/
</span></span><span class="line"><span class="cl">sudo chroot /mnt
</span></span></code></pre></div><p>Cool, you are now inside your system and we can check whether our <code>fstab</code> mounts everything correctly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mount -av
</span></span><span class="line"><span class="cl"><span class="c1"># /boot/efi                : successfully mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /recovery                : successfully mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /                        : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /home                    : successfully mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># none                     : ignored</span>
</span></span></code></pre></div><p>Looks good! Now we need to adapt some other stuff.</p>
<h3 id="adjust-configuration-of-crypttab-systemd-bootloader-and-kernelstub">Adjust configuration of crypttab, systemd bootloader and kernelstub</h3>
<p>We need to adjust settings for the <code>crypttab</code> and the configuration files of the systemd bootloader and the kernelstub. Also we need to make sure these settings are not overwritten, if we e.g. install new kernels or update modules. Let&rsquo;s do this in our chroot environment.</p>
<ol>
<li>Add our second RAID1 drive to the <code>crypttab</code>:</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;crypt_vdb UUID=</span><span class="k">$(</span>blkid -s UUID -o value /dev/vdb4<span class="k">)</span><span class="s2"> none luks&#34;</span> &gt;&gt; /etc/crypttab
</span></span><span class="line"><span class="cl">cat /etc/crypttab
</span></span><span class="line"><span class="cl"><span class="c1"># cryptswap UUID=03019356-3691-4002-a013-be15f291cde2 /dev/urandom swap,offset=1024,cipher=aes-xts-plain64,size=512</span>
</span></span><span class="line"><span class="cl"><span class="c1"># crypt_vda UUID=9fc916b2-bdd8-4fbd-b557-4c4366f8cd63 none luks</span>
</span></span><span class="line"><span class="cl"><span class="c1"># crypt_vdb UUID=93fc3643-a687-4a1c-9859-409b090448b9 none luks</span>
</span></span></code></pre></div><ol start="2">
<li>Add a timeout to the systemd boot menu in order to easily access the recovery partition:</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;timeout 2&#34;</span> &gt;&gt; /boot/efi/loader/loader.conf
</span></span><span class="line"><span class="cl">cat /boot/efi/loader/loader.conf 
</span></span><span class="line"><span class="cl"><span class="c1"># default Pop_OS-current</span>
</span></span><span class="line"><span class="cl"><span class="c1"># timeout 2</span>
</span></span></code></pre></div><ol start="3">
<li>Add <code>rootflags=subvol=@</code> to last line of <code>Pop_OS_current.conf</code> either using a text editor or the following command</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/splash/splash rootflags=subvol=@/&#39;</span> /boot/efi/loader/entries/Pop_OS-current.conf
</span></span><span class="line"><span class="cl">cat /boot/efi/loader/entries/Pop_OS-current.conf
</span></span><span class="line"><span class="cl"><span class="c1"># title Pop!_OS</span>
</span></span><span class="line"><span class="cl"><span class="c1"># linux /EFI/Pop_OS-c277ed84-e32f-4204-a211-1d80596e6e15/vmlinuz.efi</span>
</span></span><span class="line"><span class="cl"><span class="c1"># initrd /EFI/Pop_OS-c277ed84-e32f-4204-a211-1d80596e6e15/initrd.img</span>
</span></span><span class="line"><span class="cl"><span class="c1"># options root=UUID=c277ed84-e32f-4204-a211-1d80596e6e15 ro quiet loglevel=0 systemd.show_status=false splash rootflags=subvol=@</span>
</span></span></code></pre></div><ol start="4">
<li>Lastly, we need to add <code>rootflags=subvol=@</code> to the <code>&quot;user&quot;</code> kernel options of the kernelstub configuration file:</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nano /etc/kernelstub/configuration
</span></span><span class="line"><span class="cl"><span class="c1"># add rootflags=subvol=@ to &#34;user&#34; kernel options</span>
</span></span><span class="line"><span class="cl"><span class="c1"># don&#39;t forget the comma after &#34;splash&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat /etc/kernelstub/configuration
</span></span><span class="line"><span class="cl"><span class="c1"># {</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &#34;default&#34;: {</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;kernel_options&#34;: [</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;quiet&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;splash&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ],</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;esp_path&#34;: &#34;/boot/efi&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;setup_loader&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;manage_mode&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;force_update&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;live_mode&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;config_rev&#34;: 3</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   },</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   &#34;user&#34;: {</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;kernel_options&#34;: [</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;quiet&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;loglevel=0&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;systemd.show_status=false&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;splash&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;rootflags=subvol=@&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ],</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;esp_path&#34;: &#34;/boot/efi&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;setup_loader&#34;: true,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;manage_mode&#34;: true,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;force_update&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;live_mode&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;config_rev&#34;: 3</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   }</span>
</span></span><span class="line"><span class="cl"><span class="c1"># }</span>
</span></span></code></pre></div><p><strong>VERY IMPORTANTLY: Don&rsquo;t forget the comma after <code>&quot;splash&quot;</code>, otherwise you get errors when you later run <code>update-initramfs</code> (see below)!</strong></p>
<ol start="5">
<li>Install <code>btrfs-progs</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apt install btrfs-progs
</span></span><span class="line"><span class="cl"><span class="c1"># Reading package lists... Done</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Building dependency tree       </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Reading state information... Done</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The following additional packages will be installed:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   liblzo2-2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Suggested packages:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   duperemove</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The following NEW packages will be installed:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   btrfs-progs liblzo2-2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 0 upgraded, 2 newly installed, 0 to remove and 0 not upgraded.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Need to get 705 kB of archives.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># After this operation, 4292 kB of additional disk space will be used.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Do you want to continue? [Y/n] Y</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Get:1 http://us.archive.ubuntu.com/ubuntu focal/main amd64 liblzo2-2 amd64 2.10-2 [50.8 kB]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Get:2 http://us.archive.ubuntu.com/ubuntu focal/main amd64 btrfs-progs amd64 5.4.1-2 [654 kB]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Fetched 705 kB in 1s (693 kB/s)  </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Selecting previously unselected package liblzo2-2:amd64.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (Reading database ... 208003 files and directories currently installed.)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Preparing to unpack .../liblzo2-2_2.10-2_amd64.deb ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Unpacking liblzo2-2:amd64 (2.10-2) ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Selecting previously unselected package btrfs-progs.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Preparing to unpack .../btrfs-progs_5.4.1-2_amd64.deb ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Unpacking btrfs-progs (5.4.1-2) ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Setting up liblzo2-2:amd64 (2.10-2) ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Setting up btrfs-progs (5.4.1-2) ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># update-initramfs: deferring update (trigger activated)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Processing triggers for man-db (2.9.1-1) ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Processing triggers for initramfs-tools (0.136ubuntu6) ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># update-initramfs: Generating /boot/initrd.img-5.4.0-7624-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Config    : INFO     Looking for configuration...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub           : INFO     System information: </span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1">#     OS:..................Pop!_OS 20.04</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Root partition:....../dev/dm-1</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Root FS UUID:........c277ed84-e32f-4204-a211-1d80596e6e15</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ESP Path:............/boot/efi</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ESP Partition:......./dev/vda1</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ESP Partition #:.....1</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     NVRAM entry #:.......-1</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Boot Variable #:.....0000</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Kernel Boot Options:.quiet loglevel=0 systemd.show_status=false splash rootflags=subvol=@</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Kernel Image Path:.../boot/vmlinuz-5.4.0-7624-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Initrd Image Path:.../boot/initrd.img-5.4.0-7624-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Force-overwrite:.....False</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     Copying Kernel into ESP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     Copying initrd.img into ESP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     Setting up loader.conf configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     Making entry file for Pop!_OS</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     Backing up old kernel</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     No old kernel found, skipping</span>
</span></span></code></pre></div><p>Note that this has also updated the initramfs, but to just be sure, run it again:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">update-initramfs -c -k all
</span></span></code></pre></div><p>Note that if you run into errors like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">update-initramfs: Generating /boot/initrd.img-5.11.0-7620-generic
</span></span><span class="line"><span class="cl">kernelstub.Config    : INFO     Looking <span class="k">for</span> configuration...
</span></span><span class="line"><span class="cl">Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/bin/kernelstub&#34;</span>, line 244, in &lt;module&gt;
</span></span><span class="line"><span class="cl">    main<span class="o">()</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/bin/kernelstub&#34;</span>, line 241, in main
</span></span><span class="line"><span class="cl">    kernelstub.main<span class="o">(</span>args<span class="o">)</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3/dist-packages/kernelstub/application.py&#34;</span>, line 142, in main
</span></span><span class="line"><span class="cl">    <span class="nv">config</span> <span class="o">=</span> Config.Config<span class="o">()</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3/dist-packages/kernelstub/config.py&#34;</span>, line 50, in __init__
</span></span><span class="line"><span class="cl">    self.config <span class="o">=</span> self.load_config<span class="o">()</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3/dist-packages/kernelstub/config.py&#34;</span>, line 60, in load_config
</span></span><span class="line"><span class="cl">    self.config <span class="o">=</span> json.load<span class="o">(</span>config_file<span class="o">)</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3.9/json/__init__.py&#34;</span>, line 293, in load
</span></span><span class="line"><span class="cl">    <span class="k">return</span> loads<span class="o">(</span>fp.read<span class="o">()</span>,
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3.9/json/__init__.py&#34;</span>, line 346, in loads
</span></span><span class="line"><span class="cl">    <span class="k">return</span> _default_decoder.decode<span class="o">(</span>s<span class="o">)</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3.9/json/decoder.py&#34;</span>, line 337, in decode
</span></span><span class="line"><span class="cl">    obj, <span class="nv">end</span> <span class="o">=</span> self.raw_decode<span class="o">(</span>s, <span class="nv">idx</span><span class="o">=</span>_w<span class="o">(</span>s, 0<span class="o">)</span>.end<span class="o">())</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3.9/json/decoder.py&#34;</span>, line 353, in raw_decode
</span></span><span class="line"><span class="cl">    obj, <span class="nv">end</span> <span class="o">=</span> self.scan_once<span class="o">(</span>s, idx<span class="o">)</span>
</span></span><span class="line"><span class="cl">json.decoder.JSONDecodeError: Expecting <span class="s1">&#39;,&#39;</span> delimiter: line <span class="m">20</span> column <span class="m">7</span> <span class="o">(</span>char 363<span class="o">)</span>
</span></span><span class="line"><span class="cl">run-parts: /etc/initramfs/post-update.d//zz-kernelstub exited with <span class="k">return</span> code <span class="m">1</span>
</span></span></code></pre></div><p>you probably forgot a comma after <code>&quot;splash&quot;</code> in the <code>/etc/kernelstub/configuration</code> file (see above).</p>
<h2 id="step-5-reboot-some-checks-and-update-system">Step 5: Reboot, some checks, and update system</h2>
<p>Now, it is time to exit the chroot - cross your fingers - and reboot the system:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">exit</span>
</span></span><span class="line"><span class="cl"><span class="c1"># exit</span>
</span></span><span class="line"><span class="cl">reboot now
</span></span></code></pre></div><p>If all went well you should see a passphrase prompt for <code>crypt_vda</code> and one for <code>crypt_vdb</code>, where you enter the corresponding luks passphrases and your system boots.</p>
<p>Now let&rsquo;s click through the welcome screen and create a user account. Let&rsquo;s open up a terminal to see whether everything is set up correctly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cat /etc/crypttab
</span></span><span class="line"><span class="cl"><span class="c1"># cryptswap UUID=03019356-3691-4002-a013-be15f291cde2 /dev/urandom swap,offset=1024,cipher=aes-xts-plain64,size=512</span>
</span></span><span class="line"><span class="cl"><span class="c1"># crypt_vda UUID=9fc916b2-bdd8-4fbd-b557-4c4366f8cd63 none luks</span>
</span></span><span class="line"><span class="cl"><span class="c1"># crypt_vdb UUID=93fc3643-a687-4a1c-9859-409b090448b9 none luks</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo cat /etc/fstab
</span></span><span class="line"><span class="cl"><span class="c1"># PARTUUID=7109bb96-1c90-48bf-b290-a475996aa97b  /boot/efi  vfat  umask=0077  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># PARTUUID=6316f309-81a6-476b-b804-ae315d5e5ae3  /recovery  vfat  umask=0077  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=c277ed84-e32f-4204-a211-1d80596e6e15  /  btrfs  defaults,subvol=@,ssd,noatime,space_cache,commit=120,compress=zstd  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=c277ed84-e32f-4204-a211-1d80596e6e15   /home   btrfs   defaults,subvol=@home,ssd,noatime,space_cache,commit=120,compress=zstd   0 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptswap  none  swap  defaults  0  0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo mount -av
</span></span><span class="line"><span class="cl"><span class="c1"># /boot/efi                : already mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /recovery                : already mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /                        : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /home                    : already mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># none                     : ignored</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo mount -v <span class="p">|</span> grep data_vd
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/data_vda-root on / type btrfs (rw,noatime,compress=zstd:3,ssd,space_cache,commit=120,subvolid=269,subvol=/@)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/data_vda-root on /home type btrfs (rw,noatime,compress=zstd:3,ssd,space_cache,commit=120,subvolid=270,subvol=/@home)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo swapon
</span></span><span class="line"><span class="cl"><span class="c1"># NAME      TYPE      SIZE USED PRIO</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/dm-4 partition   4G   0B   -2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo btrfs filesystem show /
</span></span><span class="line"><span class="cl"><span class="c1"># Label: none  uuid: c277ed84-e32f-4204-a211-1d80596e6e15</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Total devices 2 FS bytes used 4.45GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	devid    1 size 55.49GiB used 7.03GiB path /dev/mapper/data_vda-root</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       devid    2 size 55.49GiB used 7.03GiB path /dev/mapper/data_vdb-root</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo btrfs subvolume list /
</span></span><span class="line"><span class="cl"><span class="c1"># ID 269 gen 538 top level 5 path @</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ID 270 gen 528 top level 5 path @home</span>
</span></span></code></pre></div><p>If all look&rsquo;s good, let&rsquo;s update and upgrade the system:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt upgrade
</span></span><span class="line"><span class="cl">sudo apt dist-upgrade
</span></span><span class="line"><span class="cl">sudo apt autoremove
</span></span><span class="line"><span class="cl">sudo apt autoclean
</span></span></code></pre></div><p>Optionally, if you installed on a SSD and NVME, enable <code>fstrim.timer</code> as we did not add <code>discard</code> to the <code>crypttab</code>. This is due to the fact that <a href="https://www.phoronix.com/scan.php?page=news_item&amp;px=Btrfs-Async-Discard" target="_blank" rel="noopener">Btrfs Async Discard Support Looks To Be Ready For Linux 5.6</a> is quite new, but 20.04 still runs kernel 5.4, it is better to enable the <code>fstrim.timer</code> systemd service:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> fstrim.timer
</span></span></code></pre></div><p>Now reboot:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo reboot now
</span></span></code></pre></div><h2 id="step-6-create-degraded-boot-entry">Step 6: Create degraded boot entry</h2>
<ol>
<li>Let&rsquo;s go into root mode and export the UUID and PARTUUID of our recovery partitions into environmental variables for easy use later on:</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo -i
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">UUID_vda2</span><span class="o">=</span><span class="k">$(</span>blkid -s UUID -o value /dev/vda2<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PARTUUID_vda2</span><span class="o">=</span><span class="k">$(</span>blkid -s PARTUUID -o value /dev/vda2<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">UUID_vdb2</span><span class="o">=</span><span class="k">$(</span>blkid -s UUID -o value /dev/vdb2<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PARTUUID_vdb2</span><span class="o">=</span><span class="k">$(</span>blkid -s PARTUUID -o value /dev/vdb2<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">UUID_root</span><span class="o">=</span><span class="k">$(</span>blkid -s UUID -o value /dev/mapper/data_vda-root<span class="k">)</span>
</span></span></code></pre></div><p>Let&rsquo;s create a boot entry in case the RAID1 is broken, i.e. use degraded mode as rootflag:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF &gt; /boot/efi/loader/entries/Pop_OS-degraded.conf
</span></span></span><span class="line"><span class="cl"><span class="s">title Pop!_OS (degraded)
</span></span></span><span class="line"><span class="cl"><span class="s">linux /EFI/Pop_OS-${UUID_root}/vmlinuz.efi
</span></span></span><span class="line"><span class="cl"><span class="s">initrd /EFI/Pop_OS-${UUID_root}/initrd.img
</span></span></span><span class="line"><span class="cl"><span class="s">options root=UUID=${UUID_root} ro quiet loglevel=0 systemd.show_status=false splash rootflags=subvol=@,degraded
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat /boot/efi/loader/entries/Pop_OS-degraded.conf
</span></span><span class="line"><span class="cl"><span class="c1"># title Pop!_OS (degraded)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># linux /EFI/Pop_OS-c277ed84-e32f-4204-a211-1d80596e6e15/vmlinuz.efi</span>
</span></span><span class="line"><span class="cl"><span class="c1"># initrd /EFI/Pop_OS-c277ed84-e32f-4204-a211-1d80596e6e15/initrd.img</span>
</span></span><span class="line"><span class="cl"><span class="c1"># options root=UUID=c277ed84-e32f-4204-a211-1d80596e6e15 ro quiet loglevel=0 systemd.show_status=false splash rootflags=subvol=@,degraded</span>
</span></span></code></pre></div><p>Note that <code>/dev/mapper/data_vda-root</code> and <code>/dev/mapper/data_vdb-root</code> have the same UUID.</p>
<h2 id="step-7-make-duplicate-of-recovery-partition-and-create-separate-boot-entries">Step 7: Make duplicate of recovery partition and create separate boot entries</h2>
<p>Now let&rsquo;s clone the recovery partition <code>vda2</code> to <code>vdb2</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">dd <span class="k">if</span><span class="o">=</span>/dev/vda2 <span class="nv">of</span><span class="o">=</span>/dev/vdb2 <span class="nv">bs</span><span class="o">=</span><span class="m">1024</span> <span class="nv">status</span><span class="o">=</span>progress
</span></span><span class="line"><span class="cl"><span class="c1"># 4248138752 bytes (4.2 GB, 4.0 GiB) copied, 66 s, 64.4 MB/s </span>
</span></span><span class="line"><span class="cl"><span class="c1"># 4194303+1 records in</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 4194303+1 records out</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 4294966784 bytes (4.3 GB, 4.0 GiB) copied, 71.2853 s, 60.3 MB/s</span>
</span></span></code></pre></div><p>and create two boot entries called &ldquo;Pop!_OS recovery (vda)&rdquo; and &ldquo;Pop!_OS recovery (vdb)&rdquo;:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF &gt; /boot/efi/loader/entries/Recovery-vda.conf
</span></span></span><span class="line"><span class="cl"><span class="s">title Pop!_OS recovery (vda)
</span></span></span><span class="line"><span class="cl"><span class="s">linux /EFI/Recovery-${UUID_vda2}/vmlinuz.efi
</span></span></span><span class="line"><span class="cl"><span class="s">initrd /EFI/Recovery-${UUID_vda2}/initrd.gz
</span></span></span><span class="line"><span class="cl"><span class="s">options  boot=casper hostname=recovery userfullname=Recovery username=recovery live-media-path=/casper-${UUID_vda2} live-media=/dev/disk/by-partuuid/${PARTUUID_vda2} noprompt 
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">cat /boot/efi/loader/entries/Recovery-vda.conf 
</span></span><span class="line"><span class="cl"><span class="c1"># title Pop!_OS recovery (vda)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># linux /EFI/Recovery-C419-37C6/vmlinuz.efi</span>
</span></span><span class="line"><span class="cl"><span class="c1"># initrd /EFI/Recovery-C419-37C6/initrd.gz</span>
</span></span><span class="line"><span class="cl"><span class="c1"># options  boot=casper hostname=recovery userfullname=Recovery username=recovery live-media-path=/casper-C419-37C6 live-media=/dev/disk/by-partuuid/6316f309-81a6-476b-b804-ae315d5e5ae3 noprompt </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF &gt; /boot/efi/loader/entries/Recovery-vdb.conf
</span></span></span><span class="line"><span class="cl"><span class="s">title Pop!_OS recovery (vdb)
</span></span></span><span class="line"><span class="cl"><span class="s">linux /EFI/Recovery-${UUID_vdb2}/vmlinuz.efi
</span></span></span><span class="line"><span class="cl"><span class="s">initrd /EFI/Recovery-${UUID_vdb2}/initrd.gz
</span></span></span><span class="line"><span class="cl"><span class="s">options  boot=casper hostname=recovery userfullname=Recovery username=recovery live-media-path=/casper-${UUID_vdb2} live-media=/dev/disk/by-partuuid/${PARTUUID_vdb2} noprompt 
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">cat /boot/efi/loader/entries/Recovery-vdb.conf
</span></span><span class="line"><span class="cl"><span class="c1"># title Pop!_OS recovery (vdb)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># linux /EFI/Recovery-C419-37C6/vmlinuz.efi</span>
</span></span><span class="line"><span class="cl"><span class="c1"># initrd /EFI/Recovery-C419-37C6/initrd.gz</span>
</span></span><span class="line"><span class="cl"><span class="c1"># options  boot=casper hostname=recovery userfullname=Recovery username=recovery live-media-path=/casper-C419-37C6 live-media=/dev/disk/by-partuuid/3560ffd1-39f0-44da-9c3b-a5d98ea43f08 noprompt</span>
</span></span></code></pre></div><p>Now, you should update the initramfs and reboot.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">update-initramfs -c -k all
</span></span><span class="line"><span class="cl">reboot now
</span></span></code></pre></div><p>Don&rsquo;t boot into your normal system but check whether both recovery partitions work. If that is the case, boot back into your system and continue with the next step.</p>
<h2 id="step-8-make-duplicate-of-efi">Step 8: Make duplicate of EFI</h2>
<p>Open an interactive sudo terminal, duplicate the efi partition to the second disk, unmount the current efi partition and mount the one from the second disk:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo -i
</span></span><span class="line"><span class="cl">umount /boot/efi
</span></span><span class="line"><span class="cl">dd <span class="k">if</span><span class="o">=</span>/dev/vda1 <span class="nv">of</span><span class="o">=</span>/dev/vdb1 <span class="nv">bs</span><span class="o">=</span><span class="m">1024</span> <span class="nv">status</span><span class="o">=</span>progress
</span></span><span class="line"><span class="cl"><span class="c1"># 459621376 bytes (460 MB, 438 MiB) copied, 6 s, 76.6 MB/s</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 509951+1 records in</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 509951+1 records out</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 522190336 bytes (522 MB, 498 MiB) copied, 9.58114 s, 54.5 MB/s</span>
</span></span><span class="line"><span class="cl">mount /dev/vdb1 /boot/efi
</span></span></code></pre></div><p>Reinstall the systemd boot manager to <code>vdb1</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apt install --reinstall linux-generic linux-headers-generic
</span></span><span class="line"><span class="cl"><span class="c1"># Reading package lists... Done</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Building dependency tree       </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Reading state information... Done</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 0 upgraded, 0 newly installed, 2 reinstalled, 0 to remove and 0 not upgraded.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Need to get 503 kB of archives.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># After this operation, 0 B of additional disk space will be used.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Get:1 http://ppa.launchpad.net/system76/pop/ubuntu focal/main amd64 linux-generic amd64 5.4.0-7624.28~1586790353~20.04~9e10e31 [252 kB]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Get:2 http://ppa.launchpad.net/system76/pop/ubuntu focal/main amd64 linux-headers-generic amd64 5.4.0-7624.28~1586790353~20.04~9e10e31 [252 kB]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Fetched 503 kB in 0s (1,291 kB/s)          </span>
</span></span><span class="line"><span class="cl"><span class="c1"># (Reading database ... 172366 files and directories currently installed.)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Preparing to unpack .../linux-generic_5.4.0-7624.28~1586790353~20.04~9e10e31_amd64.deb ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Unpacking linux-generic (5.4.0-7624.28~1586790353~20.04~9e10e31) over (5.4.0-7624.28~1586790353~20.04~9e10e31) ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Preparing to unpack .../linux-headers-generic_5.4.0-7624.28~1586790353~20.04~9e10e31_amd64.deb ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Unpacking linux-headers-generic (5.4.0-7624.28~1586790353~20.04~9e10e31) over (5.4.0-7624.28~1586790353~20.04~9e10e31) ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Setting up linux-headers-generic (5.4.0-7624.28~1586790353~20.04~9e10e31) ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Setting up linux-generic (5.4.0-7624.28~1586790353~20.04~9e10e31) ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">update-initramfs -c -k all
</span></span><span class="line"><span class="cl"><span class="c1"># update-initramfs: Generating /boot/initrd.img-5.4.0-7624-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cryptsetup: WARNING: Resume target cryptswap uses a key file</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Config    : INFO     Looking for configuration...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub           : INFO     System information: </span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1">#     OS:..................Pop!_OS 20.04</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Root partition:....../dev/dm-1</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Root FS UUID:........c277ed84-e32f-4204-a211-1d80596e6e15</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ESP Path:............/boot/efi</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ESP Partition:......./dev/vda1</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ESP Partition #:.....1</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     NVRAM entry #:.......-1</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Boot Variable #:.....0000</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Kernel Boot Options:.quiet loglevel=0 systemd.show_status=false splash rootflags=subvol=@</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Kernel Image Path:.../boot/vmlinuz-5.4.0-7624-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Initrd Image Path:.../boot/initrd.img-5.4.0-7624-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Force-overwrite:.....False</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     Copying Kernel into ESP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     Copying initrd.img into ESP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     Setting up loader.conf configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     Making entry file for Pop!_OS</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     Backing up old kernel</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     No old kernel found, skipping</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">bootctl --path<span class="o">=</span>/boot/efi install
</span></span></code></pre></div><p>Now, you should reboot and check whether both EFI partitions work.</p>
<h2 id="step-9-install-timeshift-and-timeshift-autosnap-apt">Step 9: Install Timeshift and timeshift-autosnap-apt</h2>
<p>Open a terminal and install some dependencies:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install -y git make
</span></span></code></pre></div><p>Install Timeshift and configure it directly via the GUI:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install -y timeshift
</span></span><span class="line"><span class="cl">sudo timeshift-gtk
</span></span></code></pre></div><ul>
<li>Select &ldquo;btrfs&rdquo; as the &ldquo;Snapshot Type&rdquo;; continue with &ldquo;Next&rdquo;</li>
<li>Choose your btrfs system partition as &ldquo;Snapshot Location&rdquo;; continue with &ldquo;Next&rdquo;  (even if timeshift does not see a btrfs system in the GUI it will still work, so continue (I already filed a bug report with timeshift))</li>
<li>&ldquo;Select Snapshot Levels&rdquo; (type and number of snapshots that will be automatically created and managed/deleted by Timeshift), my recommendations:
<ul>
<li>Activate &ldquo;Monthly&rdquo; and set it to 1</li>
<li>Activate &ldquo;Weekly&rdquo; and set it to 3</li>
<li>Activate &ldquo;Daily&rdquo; and set it to 5</li>
<li>Deactivate &ldquo;Hourly&rdquo;</li>
<li>Activate &ldquo;Boot&rdquo; and set it to 3</li>
<li>Activate &ldquo;Stop cron emails for scheduled tasks&rdquo;</li>
<li>continue with &ldquo;Next&rdquo;</li>
<li>I also include the <code>@home</code> subvolume (which is not selected by default). Note that when you restore a snapshot Timeshift you get the choise whether you want to restore it as well (which in most cases you don&rsquo;t want to).</li>
<li>Click &ldquo;Finish&rdquo;</li>
</ul>
</li>
<li>&ldquo;Create&rdquo; a manual first snapshot &amp; exit Timeshift</li>
</ul>
<p><em>Timeshift</em> will now check every hour if snapshots (&ldquo;hourly&rdquo;, &ldquo;daily&rdquo;, &ldquo;weekly&rdquo;, &ldquo;monthly&rdquo;, &ldquo;boot&rdquo;) need to be created or deleted. Note that &ldquo;boot&rdquo; snapshots will not be created directly but about 10 minutes after a system startup.</p>
<p><em>Timeshift</em> puts all snapshots into <code>/run/timeshift/backup</code>. Conveniently, the real root (subvolid 5) of your btrfs partition is also mounted here, so it is easy to view, create, delete and move around snapshots manually.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ls /run/timeshift/backup
</span></span><span class="line"><span class="cl"><span class="c1"># @  @home  @swap  timeshift-btrfs</span>
</span></span></code></pre></div><p>Note that <code>/run/timeshift/backup/@</code> contains your <code>/</code> folder, <code>/run/timeshift/backup/@home</code> contains your <code>/home</code> folder, <code>/run/timeshift/backup/@swap</code> contains your <code>/swap</code> folder.</p>
<p>Now let&rsquo;s install <em>timeshift-autosnap-apt</em> from GitHub</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/wmutschl/timeshift-autosnap-apt.git /home/<span class="nv">$USER</span>/timeshift-autosnap-apt
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /home/<span class="nv">$USER</span>/timeshift-autosnap-apt
</span></span><span class="line"><span class="cl">sudo make install
</span></span></code></pre></div><p>After this, optionally, make changes to the configuration file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo nano /etc/timeshift-autosnap-apt.conf
</span></span></code></pre></div><p>For example, as we don&rsquo;t have a dedicated <code>/boot</code> partition, we can set <code>snapshotBoot=false</code> in the <code>timeshift-autosnap-apt-conf</code> file to not rsync the <code>/boot</code> directory to <code>/boot.backup</code>. Note that the EFI partition is still rsynced into your snapshot to <code>/boot.backup/efi</code>.</p>
<p>Check if everything is working:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo timeshift-autosnap-apt
</span></span><span class="line"><span class="cl"><span class="c1"># Rsyncing /boot/efi into the filesystem before the call to timeshift.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Using system disk as snapshot device for creating snapshots in BTRFS mode</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/dm-0 is mounted at: /run/timeshift/backup, options: rw,relatime,compress=zstd:3,ssd,space_cache,commit=120,subvolid=5,subvol=/</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Creating new backup...(BTRFS)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Saving to device: /dev/dm-0, mounted at path: /run/timeshift/backup</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Created directory: /run/timeshift/backup/timeshift-btrfs/snapshots/2020-05-06_23-43-29</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Created subvolume snapshot: /run/timeshift/backup/timeshift-btrfs/snapshots/2020-05-06_23-43-29/@</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Created subvolume snapshot: /run/timeshift/backup/timeshift-btrfs/snapshots/2020-05-06_23-43-29/@home</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Created control file: /run/timeshift/backup/timeshift-btrfs/snapshots/2020-05-06_23-43-29/info.json</span>
</span></span><span class="line"><span class="cl"><span class="c1"># BTRFS Snapshot saved successfully (0s)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Tagged snapshot &#39;2020-05-06_23-43-29&#39;: ondemand</span>
</span></span></code></pre></div><p>Now, if you run <code>sudo apt install|remove|upgrade|dist-upgrade</code>, <em>timeshift-autosnap-apt</em> will create a snapshot of your system with <em>Timeshift</em>. Note that if you use this you always have a backup of your efi parition inside any btrfs snapshot in the folder <code>/boot.backup/efi/</code>.</p>
<h2 id="step-10-wip-keep-efi-partitions-in-sync">Step 10 (WIP): Keep efi partitions in sync</h2>
<p>To Do list:</p>
<ul>
<li><input disabled="" type="checkbox"> mount both efi partitions via fstab</li>
<li><input disabled="" type="checkbox"> add dpkg hook similar to timeshift-autosnap-apt</li>
<li><input disabled="" type="checkbox"> alternatively show how to reinstall EFI partition</li>
</ul>
<p>Note that if you use timeshift-autosnap-apt you always have a backup of your efi parition inside any btrfs snapshot in the folder <code>/boot.backup/efi/</code>.</p>
<h2 id="emergency-scenario-raid1-is-broken">Emergency scenario: RAID1 is broken</h2>
<h3 id="wip-efi-is-broken">[WIP] efi is broken</h3>
<p>see Repair bootloader in the <a href="../../references/#btrfs-installation-guides">References</a>&hellip;.</p>
<h3 id="vda-is-broken">vda is broken</h3>
<p>Let&rsquo;s assume <code>vda</code> is broken (to this end I shutdown the virtual machine and add an empty <code>vda</code>). Now we need to open the &ldquo;EFI BOOT MANAGER IN BIOS&rdquo; and select to boot from the EFI partition on <code>vda</code>. The system will not boot, but we have our recovery system on <code>vdb</code>, so let&rsquo;s boot into it. Then, we need to chroot in degraded mode into the system, change PARTUUID in the fstab, and remove the bad drive from the crypttab:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo -i
</span></span><span class="line"><span class="cl">cryptsetup luksOpen /dev/vdb4 crypt_vdb
</span></span><span class="line"><span class="cl">mount -o <span class="nv">subvol</span><span class="o">=</span>@,degraded /dev/mapper/data_vdb-root /mnt
</span></span><span class="line"><span class="cl">mount /dev/vdb1 /mnt/boot/efi
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in /dev /dev/pts /proc /sys /run<span class="p">;</span> <span class="k">do</span> sudo mount -B <span class="nv">$i</span> /mnt<span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>
</span></span><span class="line"><span class="cl">sudo cp /etc/resolv.conf /mnt/etc/
</span></span><span class="line"><span class="cl">sudo chroot /mnt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># get PARTUUID</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="k">$(</span>blkid -s PARTUUID -o value /dev/vdb1<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># df1701f7-6e8b-4db1-8192-3a7931e3a905</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="k">$(</span>blkid -s PARTUUID -o value /dev/vdb2<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 3560ffd1-39f0-44da-9c3b-a5d98ea43f08</span>
</span></span><span class="line"><span class="cl">nano /etc/fstab
</span></span><span class="line"><span class="cl"><span class="c1"># USE df1701f7-6e8b-4db1-8192-3a7931e3a905 FOR /boot/efi</span>
</span></span><span class="line"><span class="cl"><span class="c1"># USE 3560ffd1-39f0-44da-9c3b-a5d98ea43f08 FOR /recovery</span>
</span></span><span class="line"><span class="cl">cat /etc/fstab
</span></span><span class="line"><span class="cl"><span class="c1"># PARTUUID=df1701f7-6e8b-4db1-8192-3a7931e3a905  /boot/efi  vfat  umask=0077  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># PARTUUID=3560ffd1-39f0-44da-9c3b-a5d98ea43f08  /recovery  vfat  umask=0077  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=c277ed84-e32f-4204-a211-1d80596e6e15  /  btrfs  defaults,subvol=@,ssd,noatime,space_cache,commit=120,compress=zstd  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=c277ed84-e32f-4204-a211-1d80596e6e15   /home   btrfs   defaults,subvol=@home,ssd,noatime,space_cache,commit=120,compress=zstd   0 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptswap  none  swap  defaults  0  0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mkswap /dev/vdb3
</span></span><span class="line"><span class="cl"><span class="c1"># Setting up swapspace version 1, size = 4 GiB (4294963200 bytes)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># no label, UUID=a6a9ec65-a225-4185-8edd-f9dd3c243a2a</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">nano /etc/crypttab
</span></span><span class="line"><span class="cl"><span class="c1"># UNCOMMENT THE NOT WORKING DEVICE AND CHANGE UUID of cryptswap</span>
</span></span><span class="line"><span class="cl">cat /etc/crypttab
</span></span><span class="line"><span class="cl"><span class="c1"># cryptswap UUID=a6a9ec65-a225-4185-8edd-f9dd3c243a2a /dev/urandom swap,offset=1024,cipher=aes-xts-plain64,size=512</span>
</span></span><span class="line"><span class="cl"><span class="c1"># #crypt_vda UUID=9fc916b2-bdd8-4fbd-b557-4c4366f8cd63 none luks</span>
</span></span><span class="line"><span class="cl"><span class="c1"># crypt_vdb UUID=93fc3643-a687-4a1c-9859-409b090448b9 none luks</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">update-initramfs -c -k all
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">exit</span>
</span></span><span class="line"><span class="cl">reboot now
</span></span></code></pre></div><p>Choose &ldquo;POP!_OS (degraded)&rdquo; in the boot menu and you can boot into your system and repair it!</p>
<h3 id="vdb-is-broken">vdb is broken</h3>
<p>Let&rsquo;s assume <code>vdb</code> is broken (to this end I shutdown the virtual machine and added a empty <code>vdb</code>).
Now we need to open the &ldquo;EFI BOOT MANAGER IN BIOS&rdquo; and select to boot from the EFI partition on <code>vdb</code>. The system will not boot, but we have our recovery system on <code>vda</code>, so let&rsquo;s boot into it. Then, we need to chroot in degraded mode into the system and remove the bad drive from the crypttab:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo -i
</span></span><span class="line"><span class="cl">cryptsetup luksOpen /dev/vda4 crypt_vda
</span></span><span class="line"><span class="cl">mount -o <span class="nv">subvol</span><span class="o">=</span>@,degraded /dev/mapper/data_vda-root /mnt
</span></span><span class="line"><span class="cl">mount /dev/vda1 /mnt/boot/efi
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in /dev /dev/pts /proc /sys /run<span class="p">;</span> <span class="k">do</span> sudo mount -B <span class="nv">$i</span> /mnt<span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>
</span></span><span class="line"><span class="cl">sudo cp /etc/resolv.conf /mnt/etc/
</span></span><span class="line"><span class="cl">sudo chroot /mnt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># NO NEED TO CHANGE THE FSTAB</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">nano /etc/crypttab
</span></span><span class="line"><span class="cl"><span class="c1"># UNCOMMENT THE NOT WORKING DEVICE</span>
</span></span><span class="line"><span class="cl">cat /etc/crypttab
</span></span><span class="line"><span class="cl"><span class="c1"># cryptswap UUID=03019356-3691-4002-a013-be15f291cde2 /dev/urandom swap,offset=1024,cipher=aes-xts-plain64,size=512</span>
</span></span><span class="line"><span class="cl"><span class="c1"># crypt_vda UUID=9fc916b2-bdd8-4fbd-b557-4c4366f8cd63 none luks</span>
</span></span><span class="line"><span class="cl"><span class="c1"># #crypt_vdb UUID=93fc3643-a687-4a1c-9859-409b090448b9 none luks</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">update-initramfs -c -k all
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">exit</span>
</span></span><span class="line"><span class="cl">reboot now
</span></span></code></pre></div><p>Choose POP!_OS (degraded) in the boot menu and you can boot into your system and repair it!</p>
<p><strong>FINISHED! CONGRATULATIONS AND THANKS FOR STICKING THROUGH!</strong>
<strong>If you ever need to rollback your system, checkout my <a href="../../timeshift/">Recovery and system rollback with Timeshift</a>.</strong></p>


          </div>

          

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/linux/">linux</a>
  
  <a class="badge badge-light" href="/tag/pop-os/">pop-os</a>
  
  <a class="badge badge-light" href="/tag/install-guide/">install guide</a>
  
  <a class="badge badge-light" href="/tag/btrfs/">btrfs</a>
  
  <a class="badge badge-light" href="/tag/luks/">luks</a>
  
  <a class="badge badge-light" href="/tag/timeshift/">timeshift</a>
  
  <a class="badge badge-light" href="/tag/timeshift-autosnap-apt/">timeshift-autosnap-apt</a>
  
</div>



          
          
          <div class="article-widget">
            
<div class="post-nav">
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Previous</div>
    <a href="/linux/ubuntu-post-install/" rel="next">Ubuntu Desktop: Things to do after installation (Apps, Settings, and Tweaks)</a>
  </div>
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Next</div>
    <a href="/linux/pop-os-btrfs-20-04/" rel="prev">Pop!_OS 20.04: installation guide with btrfs-LVM-luks and auto-apt snapshots with Timeshift</a>
  </div>
  
</div>

          </div>
          
        </div>

        <div class="body-footer">
          <p>Last updated on Aug 14, 2022</p>

          




          




          


        </div>

      </article>

      <footer class="site-footer">

  












  

  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
  </p>
  

  

  
  






  
  
  

  
  
  
    
  

  

  
  <p class="powered-by copyright-license-text">
    Â© 2025 Willi Mutschler. This work is licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0" rel="noopener noreferrer" target="_blank">CC BY SA 4.0</a>
  </p>
  

  <p class="powered-by footer-license-icons">
    <a href="https://creativecommons.org/licenses/by-sa/4.0" rel="noopener noreferrer" target="_blank" aria-label="Creative Commons">
      <i class="fab fa-creative-commons fa-2x" aria-hidden="true"></i>
      <i class="fab fa-creative-commons-by fa-2x" aria-hidden="true"></i>
      
      
        <i class="fab fa-creative-commons-sa fa-2x" aria-hidden="true"></i>
      
    </a>
  </p>




  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Wowchemy</a> â the free, <a href="https://github.com/wowchemy/wowchemy-hugo-themes" target="_blank" rel="noopener">open source</a> website builder that empowers creators.
    
  </p>
</footer>


    </main>
  </div>
</div>

  </div>

  <div class="page-footer">
    
    
  </div>

  


<script src="/js/vendor-bundle.min.b4708d4364577c16ab7001b265a063a4.js"></script>




  

  
  

  






  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.js" integrity="" crossorigin="anonymous"></script>




<script src="https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>





  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>











  
  


<script src="/en/js/wowchemy.min.42010733157c11a71adebfe9bae43355.js"></script>



  <script src="/js/wowchemy-map.a26e9d2f7238ba5b868384f1c5bc6477.js" type="module"></script>




















</body>
</html>
