<!DOCTYPE html><html lang="en-us" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.6.0 for Hugo" />
  

  
  












  
  










  







  
  

  
  
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Willi Mutschler" />

  
  
  
    
  
  <meta name="description" content="In this guide I will walk you through the installation procedure to get a Pop!_OS 21.10 system with a luks-encrypted partition which contains a LVM with a logical volume for the root filesystem that is formatted with btrfs and contains a subvolume @ for / and a subvolume @home for /home. I will show how to optimize the btrfs mount options and how to setup an encrypted swap partition which works with hibernation. This layout enables one to use BTRBK which will regularly take snapshots of the system and optionally on any apt operation. The recovery system of Pop!_OS is also installed to the disk and accessible via the systemd bootloader." />

  
  <link rel="alternate" hreflang="en-us" href="https://mutschler.dev/linux/pop-os-btrfs-21-10/" />

  
  
  
    <meta name="theme-color" content="#bbdefb" />
  

  
  
    
    <script src="/js/mathjax-config.js"></script>
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha512-W0xM4mr6dEP9nREo7Z9z+9X70wytKvMGeDsj7ps2+xg5QPrEBXC8tAW1IFnzjR6eoJ90JmCnFzerQJTLzIEHjA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    
    
    
    
      
      
    
    
    

    
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.css" integrity="" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.8916ecd0e6b91586be6f7b434c75fb00.css" />

  
  
  
  
  
  
  
    
    
    <link rel="stylesheet" href="/css/libs/chroma/github-light.min.css" title="hl-light" media="print" onload="this.media='all'" disabled>
    <link rel="stylesheet" href="/css/libs/chroma/dracula.min.css" title="hl-dark" media="print" onload="this.media='all'" >
  

  
  



  


  


  




  
  
  

  
  

  
  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  
  <link rel="icon" type="image/png" href="/media/icon_hu589851f325050e29bd29c51f9d799271_45964_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu589851f325050e29bd29c51f9d799271_45964_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://mutschler.dev/linux/pop-os-btrfs-21-10/" />

  
  
  
  
  
  
  
  
    
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary" />
  
  <meta property="og:site_name" content="mutschler.dev" />
  <meta property="og:url" content="https://mutschler.dev/linux/pop-os-btrfs-21-10/" />
  <meta property="og:title" content="DRAFT: Pop!_OS 21.10: installation guide with btrfs-LVM-luks and auto snapshots with BTRBK | mutschler.dev" />
  <meta property="og:description" content="In this guide I will walk you through the installation procedure to get a Pop!_OS 21.10 system with a luks-encrypted partition which contains a LVM with a logical volume for the root filesystem that is formatted with btrfs and contains a subvolume @ for / and a subvolume @home for /home. I will show how to optimize the btrfs mount options and how to setup an encrypted swap partition which works with hibernation. This layout enables one to use BTRBK which will regularly take snapshots of the system and optionally on any apt operation. The recovery system of Pop!_OS is also installed to the disk and accessible via the systemd bootloader." /><meta property="og:image" content="https://mutschler.dev/media/icon_hu589851f325050e29bd29c51f9d799271_45964_512x512_fill_lanczos_center_3.png" />
    <meta property="twitter:image" content="https://mutschler.dev/media/icon_hu589851f325050e29bd29c51f9d799271_45964_512x512_fill_lanczos_center_3.png" /><meta property="og:locale" content="en-us" />
  
    
      <meta
        property="article:published_time"
        content="2021-12-13T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2022-06-17T13:47:19&#43;02:00">
  

  



  

  


  <title>DRAFT: Pop!_OS 21.10: installation guide with btrfs-LVM-luks and auto snapshots with BTRBK | mutschler.dev</title>

  
  
  
  











</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper  dark " data-wc-page-id="1d3c6e9ea82dcf0c6f69ea84dff00940" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.22ad66a4f96b4e9da14bbb023ea57684.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="Search...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    












<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/">mutschler.dev</a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/">mutschler.dev</a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/apple/"><span>Apple</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/linux/"><span>Linux</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/stuff/"><span>Stuff</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://buymeacoffee.com/mutschler" data-toggle="tooltip" data-placement="bottom" title="Buy me a coffee" target="_blank" rel="noopener" aria-label="Buy me a coffee">
                <i class="fas fa-coffee" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="mailto:willi@mutschler.dev" data-toggle="tooltip" data-placement="bottom" title="Write me an email"  aria-label="Write me an email">
                <i class="fas fa-envelope" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://github.com/wmutschl" data-toggle="tooltip" data-placement="bottom" title="Follow me on GitHub" target="_blank" rel="noopener" aria-label="Follow me on GitHub">
                <i class="fab fa-github" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://gitlab.com/wmutschl" data-toggle="tooltip" data-placement="bottom" title="Follow me on Gitlab" target="_blank" rel="noopener" aria-label="Follow me on Gitlab">
                <i class="fab fa-gitlab" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://www.youtube.com/c/wmutschl" data-toggle="tooltip" data-placement="bottom" title="Follow me on YouTube" target="_blank" rel="noopener" aria-label="Follow me on YouTube">
                <i class="fab fa-youtube" aria-hidden="true"></i>
              </a>
            </li>
          
        

        
        
        <li class="nav-item">
          <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    




<div class="container-fluid docs">
  <div class="row flex-xl-nowrap">
    <div class="col-12 col-md-3 col-xl-2 docs-sidebar">
      <form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <div class="d-flex">
      <span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">
        
        
          Linux
        
      </span>
      <span><i class="fas fa-chevron-down"></i></span>
    </div>
  </button>

  
  <button class="form-control sidebar-search js-search d-none d-md-flex">
    <i class="fas fa-search pr-2"></i>
    <span class="sidebar-search-text">Search...</span>
    <span class="sidebar-search-shortcut">/</span>
  </button>
  
</form>

<nav class="collapse docs-links" id="docs-nav">
  
  
  
  
  
  

  
  
    

    
      

      


  
    
    
    
    
      
    
    

    
      <ul class="nav docs-sidenav">
        <li class=""><a href="/linux/">Linux</a></li>
    
      


  <li class=""><a href="/linux/elementary-os-post-install/">elementary OS: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/elementary-os-6-1/">elementary OS 6.1 Jólnir: installation guide with btrfs, luks encryption and auto snapshots with timeshift</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-22-04/">Pop!_OS 22.04: installation guide with btrfs, luks encryption and auto snapshots with timeshift</a></li>



  <li class=""><a href="/linux/pop-os-post-install/">Pop!_OS: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/fedora-post-install/">Fedora Workstation: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/fedora-btrfs-35/">Fedora Workstation 35 with automatic btrfs snapshots and backups using BTRBK</a></li>



  <li class="active"><a href="/linux/pop-os-btrfs-21-10/">DRAFT: Pop!_OS 21.10: installation guide with btrfs-LVM-luks and auto snapshots with BTRBK</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-21-04/">Pop!_OS 21.04: installation guide with btrfs-LVM-luks and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/raspi-post-install/">Ubuntu Server Raspberry Pi: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/raspi-btrfs/">Ubuntu Server 20.10 on Raspberry Pi 4: installation guide with USB Boot (no SD card) and full disk encryption (excluding /boot) using btrfs-inside-luks and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/fedora-btrfs-33/">Fedora Workstation 33: installation guide with btrfs-luks full disk encryption (optionally including /boot) and auto snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/btrfs/">Why I (still) like btrfs</a></li>



  <li class=""><a href="/linux/ubuntu-btrfs-raid1-20-04/">Ubuntu Desktop 20.04: installation guide with btrfs-luks-RAID1 full disk encryption including /boot and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/ubuntu-btrfs-20-04/">Ubuntu Desktop 20.04: installation guide with btrfs-luks full disk encryption including /boot and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/ubuntu-post-install/">Ubuntu Desktop: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-raid1-20-04/">Pop!_OS 20.04: installation guide with btrfs-LVM-luks-RAID1 and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-20-04/">Pop!_OS 20.04: installation guide with btrfs-LVM-luks and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/timeshift/">Timeshift</a></li>

      
    

    
      </ul>
    

  
</nav>

    </div>

    
    
    <div class="d-none d-xl-block col-xl-2 docs-toc">
      












      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
      </ul>

      <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#step-0-general-remarks">Step 0: General remarks</a></li>
    <li><a href="#step-1a-boot-the-install-and-perform-a-clean-install-with-encryption">Step 1a: Boot the install and perform a <code>Clean Install</code> with encryption</a></li>
    <li><a href="#step-1b-optional-understand-the-partition-layout-and-installation-structure">Step 1b (optional): Understand the partition layout and installation structure</a></li>
    <li><a href="#step-2-install-pop_os-using-the-custom-advanced-option">Step 2: Install Pop!_OS using the <code>Custom (Advanced)</code> option</a></li>
    <li><a href="#step-3-post-installation-steps">Step 3: Post-Installation steps</a>
      <ul>
        <li><a href="#mount-the-btrfs-top-level-root-filesystem">Mount the btrfs top-level root filesystem</a></li>
        <li><a href="#create-btrfs-subvolumes--and-home">Create btrfs subvolumes <code>@</code> and <code>@home</code></a></li>
        <li><a href="#changes-to-fstab">Changes to fstab</a></li>
        <li><a href="#changes-to-crypttab">Changes to crypttab</a></li>
        <li><a href="#adjust-configuration-of-kernelstub">Adjust configuration of kernelstub</a></li>
        <li><a href="#adjust-configuration-of-systemd-bootloader">Adjust configuration of systemd bootloader</a></li>
        <li><a href="#create-a-chroot-environment-and-update-initramfs">Create a chroot environment and update initramfs</a></li>
      </ul>
    </li>
    <li><a href="#step-4-reboot-some-checks-and-update-system">Step 4: Reboot, some checks, and update system</a></li>
    <li><a href="#step-5-automatic-snapshots-and-backups-with-btrfs-using-btrbk">Step 5: automatic snapshots and backups with btrfs using BTRBK</a>
      <ul>
        <li><a href="#step-5a-preparations">Step 5a: preparations</a></li>
        <li><a href="#step-5b-install-and-configure-btrbk">Step 5b: install and configure BTRBK</a></li>
        <li><a href="#step-5c-create-systemd-timer-for-btrbk-to-run-every-hour">Step 5c: create systemd timer for BTRBK to run every hour</a></li>
        <li><a href="#step-5d-optional-mount-an-encrypted-backup-disk-as-btrfs-sendreceive-target">Step 5d (optional): Mount an encrypted backup disk as btrfs send/receive target</a></li>
        <li><a href="#step-5e-optional-automatic-snapshots-for-any-apt-operation">Step 5e (optional): Automatic snapshots for any apt operation</a></li>
      </ul>
    </li>
  </ul>
</nav>

      











    </div>
    

    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role="main">

      <article class="article">

        <div class="docs-article-container">
          
        </div>

        
        

        <div class="docs-article-container">
          
          <h1>DRAFT: Pop!_OS 21.10: installation guide with btrfs-LVM-luks and auto snapshots with BTRBK</h1>

          <div class="article-style">

            
            

            <p><em><strong>Please feel free to raise any comments or issues on the <a href="https://github.com/wmutschl/mutschler.dev" target="_blank" rel="noopener">website&rsquo;s Github repository</a>. Pull requests are very much appreciated.</strong></em>
<a href="https://www.buymeacoffee.com/mutschler" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-red.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;" ></a>
<details class="toc-inpage d-print-none d-xl-none " open>
  <summary class="font-weight-bold">Table of Contents</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#step-0-general-remarks">Step 0: General remarks</a></li>
    <li><a href="#step-1a-boot-the-install-and-perform-a-clean-install-with-encryption">Step 1a: Boot the install and perform a <code>Clean Install</code> with encryption</a></li>
    <li><a href="#step-1b-optional-understand-the-partition-layout-and-installation-structure">Step 1b (optional): Understand the partition layout and installation structure</a></li>
    <li><a href="#step-2-install-pop_os-using-the-custom-advanced-option">Step 2: Install Pop!_OS using the <code>Custom (Advanced)</code> option</a></li>
    <li><a href="#step-3-post-installation-steps">Step 3: Post-Installation steps</a>
      <ul>
        <li><a href="#mount-the-btrfs-top-level-root-filesystem">Mount the btrfs top-level root filesystem</a></li>
        <li><a href="#create-btrfs-subvolumes--and-home">Create btrfs subvolumes <code>@</code> and <code>@home</code></a></li>
        <li><a href="#changes-to-fstab">Changes to fstab</a></li>
        <li><a href="#changes-to-crypttab">Changes to crypttab</a></li>
        <li><a href="#adjust-configuration-of-kernelstub">Adjust configuration of kernelstub</a></li>
        <li><a href="#adjust-configuration-of-systemd-bootloader">Adjust configuration of systemd bootloader</a></li>
        <li><a href="#create-a-chroot-environment-and-update-initramfs">Create a chroot environment and update initramfs</a></li>
      </ul>
    </li>
    <li><a href="#step-4-reboot-some-checks-and-update-system">Step 4: Reboot, some checks, and update system</a></li>
    <li><a href="#step-5-automatic-snapshots-and-backups-with-btrfs-using-btrbk">Step 5: automatic snapshots and backups with btrfs using BTRBK</a>
      <ul>
        <li><a href="#step-5a-preparations">Step 5a: preparations</a></li>
        <li><a href="#step-5b-install-and-configure-btrbk">Step 5b: install and configure BTRBK</a></li>
        <li><a href="#step-5c-create-systemd-timer-for-btrbk-to-run-every-hour">Step 5c: create systemd timer for BTRBK to run every hour</a></li>
        <li><a href="#step-5d-optional-mount-an-encrypted-backup-disk-as-btrfs-sendreceive-target">Step 5d (optional): Mount an encrypted backup disk as btrfs send/receive target</a></li>
        <li><a href="#step-5e-optional-automatic-snapshots-for-any-apt-operation">Step 5e (optional): Automatic snapshots for any apt operation</a></li>
      </ul>
    </li>
  </ul>
</nav>
</details>
</p>
<h2 id="overview">Overview</h2>
<p>I am exclusively using btrfs as my filesystem on all my Linux systems, see <a href="../btrfs/">Why I (still) like btrfs</a>. So, in this guide I will show how to install Pop!_OS 21.10 with the following structure:</p>
<ul>
<li>an unencrypted EFI partition for the systemd bootloader</li>
<li>an unencrypted partition for the Pop!_OS recovery system</li>
<li>an encrypted swap partition which works with hibernation</li>
<li>a btrfs-LVM-inside-luks partition for the root filesystem
<ul>
<li>the btrfs logical volume contains a subvolume <code>@</code> for <code>/</code> and a subvolume <code>@home</code> for <code>/home</code>. Note that the Pop!_OS installer does not create any subvolumes on btrfs, so we need to do this manually.</li>
</ul>
</li>
<li>automatic system snapshots and easy rollback similar to <em>zsys</em> using <a href="https://github.com/digint/btrbk" target="_blank" rel="noopener">BTRBK</a> which will regularly take (almost instant) snapshots of the system and (optionally) also on any apt operation</li>
</ul>
<p>This setup works similarly well on other distributions, for which I also have <a href="../../install-guides">installation guides with optional RAID1</a>.</p>
<h2 id="step-0-general-remarks">Step 0: General remarks</h2>
<p>This tutorial is made with Pop!_OS 21.10 from <a href="https://system76.com/pop" target="_blank" rel="noopener">https://system76.com/pop</a> copied to an installation media (usually a USB Flash device but may be a DVD or the ISO file attached to a virtual machine hypervisor). Other versions of Pop!_OS and other distributions that use Systemd boot manager might also work, but sometimes require additional steps (see my other <a href="../../install-guides">installation guides</a>).</p>
<p><strong>I strongly advise to try the following installation steps in a virtual machine first before doing anything like that on real hardware!</strong>
For instance, you can spin up a virtual machine with 4 cores, 8 GB RAM, and a 64GB disk using e.g. the awesome <a href="https://github.com/quickemu-project/quickemu" target="_blank" rel="noopener">quickemu</a> project.</p>
<p>In the following, however, I outline the steps for my Dell Precision 7520 with a NVME drive which I use for the system files and another SSD which is used for btrfs backups.</p>
<h2 id="step-1a-boot-the-install-and-perform-a-clean-install-with-encryption">Step 1a: Boot the install and perform a <code>Clean Install</code> with encryption</h2>
<p>In previous installation guides I prepared the partitions manually; however, as I am basically using the same layout as the automatic POP!_OS installer with the only difference that I want to use btrfs instead of EXT4 as the filesystem, I simply perform the installation twice. The first one is the automatic <code>Clean Install</code> with encryption. When this finishes, do NOT <code>Restart Device</code> or <code>Shut Down</code> but instead right-click in the dock on the <code>Install Pop!_OS</code> app and select <code>Quit</code>.</p>
<p>If you want to see the structure of the installation keep reading, otherwise go to the next step to perform the second Installation.</p>
<h2 id="step-1b-optional-understand-the-partition-layout-and-installation-structure">Step 1b (optional): Understand the partition layout and installation structure</h2>
<p>So, let&rsquo;s open a terminal and have a look on the default partition layout:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo lsblk
</span></span><span class="line"><span class="cl"><span class="c1"># NAME          MAJ:MIN RM    SIZE RO TYPE MOUNTPOINT</span>
</span></span><span class="line"><span class="cl"><span class="c1"># loop0           7:0    0    2.8G  1 loop /rofs</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sda             8:0    0  465.8G  0 disk </span>
</span></span><span class="line"><span class="cl"><span class="c1"># └─sda1          8:1    0  465.8G  0 part </span>
</span></span><span class="line"><span class="cl"><span class="c1"># sdb             8:16   1    3.7G  0 disk </span>
</span></span><span class="line"><span class="cl"><span class="c1"># ├─sdb1          8:17   1    2.9G  0 part /cdrom</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ├─sdb2          8:18   1      4M  0 part </span>
</span></span><span class="line"><span class="cl"><span class="c1"># └─sdb3          8:19   1  843.5M  0 part /var/crash</span>
</span></span><span class="line"><span class="cl"><span class="c1"># nvme0n1       259:0    0  476.9G  0 disk</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ├─nvme0n1p1   259:1    0    498M  0 part</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ├─nvme0n1p2   259:2    0      4G  0 part </span>
</span></span><span class="line"><span class="cl"><span class="c1"># └─nvme0n1p3   259:3    0  468.4G  0 part</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ├─nvme0n1p4   259:4    0      4G  0 part</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo parted /dev/nvme0n1 unit MiB print
</span></span><span class="line"><span class="cl"><span class="c1"># Model: PM961 NVMe SAMSUNG 512GB (nvme)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Disk /dev/nvme0n1: 488386MiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sector size (logical/physical): 512B/512B</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Partition Table: gpt</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Disk Flags: </span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Number  Start      End        Size       File system    Name      Flags</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  1      2.00MiB    500MiB     498MiB     fat32          EFI       boot, esp</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  2      500MiB     4596MiB    4096MiB    fat32          recovery  msftdata</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  3      4596MiB    484288MiB  479692MiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  4      484288MiB  488384MiB  4096MiB    linux-swap(v1)           swap</span>
</span></span></code></pre></div><p>In my case <code>sda</code> is an internal SSD that I use for <a href="../../backup/#5-dell-precision-7520-linux">my backup strategy</a>, whereas <code>sdb</code> is the flash drive that contains the installation files. So, for me the installation target device is called <code>nvme0n1</code> and it has 4 partitions:</p>
<ol>
<li>a 498 MiB FAT32 EFI partition for the systemd bootloader</li>
<li>a 4096 MiB FAT32 partition for the Pop!_OS recovery system</li>
<li>a 479692MiB partition that contains the luks2 encrypted system files</li>
<li>a 4096 MiB swap partition for (encrypted) swap use</li>
</ol>
<p>Let&rsquo;s have a closer look at the luks2-encrypted partition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo cryptsetup luksDump /dev/nvme0n1p3
</span></span><span class="line"><span class="cl"><span class="c1"># LUKS header information</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Version:       	2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Epoch:         	3</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Metadata area: 	16384 [bytes]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Keyslots area: 	16744448 [bytes]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID:          	e7e986dd-19b7-4535-98bf-8ba1760921f1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Label:         	(no label)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Subsystem:     	(no subsystem)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Flags:       	(no flags)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Data segments:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   0: crypt</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	offset: 16777216 [bytes]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	length: (whole device)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	cipher: aes-xts-plain64</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	sector: 512 [bytes]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Keyslots:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   0: luks2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Key:        512 bits</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Priority:   normal</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Cipher:     aes-xts-plain64</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Cipher key: 512 bits</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	PBKDF:      argon2i</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Time cost:  7</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Memory:     1048576</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Threads:    4</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Salt:       53 34 4d ce b8 9d 9b 3c f3 94 bc f1 b4 36 5e d1 </span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	            e9 fb d1 f2 1e 5b a4 fb 42 12 23 f6 80 ad 9f c9 </span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	AF stripes: 4000</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	AF hash:    sha256</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Area offset:32768 [bytes]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Area length:258048 [bytes]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Digest ID:  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Tokens:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Digests:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   0: pbkdf2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Hash:       sha256</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Iterations: 126030</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Salt:       94 24 79 20 76 1b d3 72 6f 9f d9 0b 24 fe 92 db </span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	            ac 16 47 67 29 ef 11 7c 56 2d 44 9e 31 ac e4 26 </span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Digest:     b4 22 72 ae be 9c e1 82 2b d5 33 ae 01 db da a8 </span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	            35 23 0b 85 55 ac 00 ee 2f 43 e2 de 73 10 21 13 </span>
</span></span></code></pre></div><p>So this basically uses the default options to encrypt a partition with luks (e.g. <code>cryptsetup luksFormat /dev/nvme0n1p3</code>). Let&rsquo;s have a look what is inside the encrypted partition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo cryptsetup luksOpen /dev/nvme0n1p3 cryptdata
</span></span><span class="line"><span class="cl"><span class="c1"># Enter passphrase for /dev/nvme0n1p3:</span>
</span></span><span class="line"><span class="cl">ls /dev/mapper
</span></span><span class="line"><span class="cl"><span class="c1"># control  cryptdata  data-root</span>
</span></span><span class="line"><span class="cl">sudo pvs
</span></span><span class="line"><span class="cl"><span class="c1">#  PV                    VG   Fmt  Attr PSize    PFree</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  /dev/mapper/cryptdata data lvm2 a--  &lt;468.43g    0 </span>
</span></span><span class="line"><span class="cl">sudo vgs
</span></span><span class="line"><span class="cl"><span class="c1">#  VG   #PV #LV #SN Attr   VSize    VFree</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  data   1   1   0 wz--n- &lt;468.43g    0 </span>
</span></span><span class="line"><span class="cl">sudo lvs
</span></span><span class="line"><span class="cl"><span class="c1">#  LV   VG   Attr       LSize    Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  root data -wi-a----- &lt;468.43g</span>
</span></span><span class="line"><span class="cl">sudo lsblk /dev/mapper/data-root -f
</span></span><span class="line"><span class="cl"><span class="c1"># NAME      FSTYPE FSVER LABEL UUID                                 FSAVAIL FSUSE% MOUNTPOINT</span>
</span></span><span class="line"><span class="cl"><span class="c1"># data-root ext4   1.0         05f227c9-b2d5-4a8e-a297-9eaa58b45906</span>
</span></span></code></pre></div><p>By default POP!_OS uses Logical Volume Management (LVM), where our encrypted partition (called <code>cryptdata</code>) is a physical volume that contains a volume group called <code>data</code>. Inside the volume group there is a logical volume called <code>root</code> that contains our system files. This so-called <code>root partition</code> is formatted with ext4. The LVM is actually a bit of an overkill for my personal use case, but I&rsquo;ll stick to it as otherwise the installer cannot access the luks2 partition.</p>
<p>Okay, let&rsquo;s close everything:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo cryptsetup luksClose /dev/mapper/data-root
</span></span><span class="line"><span class="cl">sudo cryptsetup luksClose /dev/mapper/cryptdata
</span></span><span class="line"><span class="cl">ls /dev/mapper
</span></span><span class="line"><span class="cl"><span class="c1"># control</span>
</span></span></code></pre></div><p>and do the second install.</p>
<h2 id="step-2-install-pop_os-using-the-custom-advanced-option">Step 2: Install Pop!_OS using the <code>Custom (Advanced)</code> option</h2>
<p>Now let&rsquo;s open again the installer from the dock, select the region, language and keyboard layout. Then choose <code>Custom (Advanced)</code>. You will see your partitioned hard disk:</p>
<ul>
<li>Click on the first partition, activate <code>Use partition</code>, activate <code>Format</code>, Use as <code>Boot /boot/efi</code>, Filesystem: <code>fat32</code>.</li>
<li>Click on the second partition, activate <code>Use partition</code>, activate <code>Format</code>, Use as <code>Custom</code> and enter <code>/recovery</code>, Filesystem: <code>fat32</code>.</li>
<li>Click on the third and largest partition. A <code>Decrypt This Partition</code> dialog opens, enter your luks password and hit <code>Decrypt</code>. A new line is displayed <code>LVM data</code>. Click on this partition, activate <code>Use partition</code>, activate <code>Format</code>, Use as <code>Root (/)</code> , Filesystem: <code>btrfs</code>.</li>
<li>Click on the fourth partition, activate <code>Use partition</code>, Use as <code>Swap</code>.</li>
</ul>
<p><em>If you have other partitions, check their types and use; particularly, deactivate other EFI partitions.</em></p>
<p>Recheck everything (check the partitions where there is a black checkmark) and hit <code>Erase and Install</code>. Follow the steps to create a user account and to write the changes to the disk. Once the installer finishes do NOT <strong>Restart Device</strong>.</p>
<h2 id="step-3-post-installation-steps">Step 3: Post-Installation steps</h2>
<p>Open a terminal and switch to an interactive root session:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo -i
</span></span></code></pre></div><p>You might find maximizing the terminal window is helpful for working with the command-line.</p>
<h3 id="mount-the-btrfs-top-level-root-filesystem">Mount the btrfs top-level root filesystem</h3>
<p>Let&rsquo;s mount our root partition (the top-level btrfs volume always has root-id 5), but with mount options that optimize performance and durability on SSD or NVME drives:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cryptsetup luksOpen /dev/nvme0n1p3 cryptdata
</span></span><span class="line"><span class="cl"><span class="c1"># Enter passphrase for /dev/nvme0n1p3</span>
</span></span><span class="line"><span class="cl">mount -o <span class="nv">subvolid</span><span class="o">=</span>5,ssd,noatime,space_cache,commit<span class="o">=</span>120,compress<span class="o">=</span>zstd,discard<span class="o">=</span>async /dev/mapper/data-root /mnt
</span></span></code></pre></div><p>I have found that there is some general agreement to use the following mount options, namely:</p>
<ul>
<li><code>ssd</code>: use SSD specific options for optimal use on SSD and NVME</li>
<li><code>noatime</code>: prevent frequent disk writes by instructing the Linux kernel not to store the last access time of files and folders</li>
<li><code>space_cache</code>: allows btrfs to store free space cache on the disk to make caching of a block group much quicker</li>
<li><code>commit=120</code>: time interval in which data is written to the filesystem (value of 120 is taken from Manjaro&rsquo;s minimal iso)</li>
<li><code>compress=zstd</code>: allows to specify the compression algorithm which we want to use. btrfs provides lzo, zstd and zlib compression algorithms; however, zstd has become the best performing candidate.</li>
<li><code>discard=async</code>: <a href="https://www.phoronix.com/scan.php?page=news_item&amp;px=Btrfs-Async-Discard" target="_blank" rel="noopener">Btrfs Async Discard Support Looks To Be Ready For Linux 5.6</a></li>
</ul>
<p>We will later also append these mount options to the fstab, but it is good practice to already make use of these optimizations for moving the system files into subvolumes.</p>
<h3 id="create-btrfs-subvolumes--and-home">Create btrfs subvolumes <code>@</code> and <code>@home</code></h3>
<p>Now we will first create the subvolume <code>@</code> and move all files and folders from the top-level filesystem into <code>@</code>. Note that as we use the optimized mount options like compression, these will be already applied during the moving process:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">btrfs subvolume create /mnt/@
</span></span><span class="line"><span class="cl"><span class="c1"># Create subvolume &#39;/mnt/@&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /mnt
</span></span><span class="line"><span class="cl">ls <span class="p">|</span> grep -v @ <span class="p">|</span> xargs mv -t @ <span class="c1">#move all files and folders to /mnt/@</span>
</span></span><span class="line"><span class="cl">ls -a /mnt
</span></span><span class="line"><span class="cl"><span class="c1"># . .. @</span>
</span></span></code></pre></div><p>Now let&rsquo;s create another subvolume called <code>@home</code> and move the user folder from <code>/mnt/@/home/</code> into <code>@home</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">btrfs subvolume create /mnt/@home
</span></span><span class="line"><span class="cl"><span class="c1"># Create subvolume &#39;/mnt/@home&#39;</span>
</span></span><span class="line"><span class="cl">mv /mnt/@/home/* /mnt/@home/
</span></span><span class="line"><span class="cl">ls -a /mnt/@/home
</span></span><span class="line"><span class="cl"><span class="c1"># . ..</span>
</span></span><span class="line"><span class="cl">ls -a /mnt/@home
</span></span><span class="line"><span class="cl"><span class="c1"># . .. wmutschl</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">btrfs subvolume list /mnt
</span></span><span class="line"><span class="cl"><span class="c1"># ID 264 gen 339 top level 5 path @</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ID 265 gen 340 top level 5 path @home</span>
</span></span></code></pre></div><h3 id="changes-to-fstab">Changes to fstab</h3>
<p>We need to adapt the <code>fstab</code> to</p>
<ul>
<li>mount <code>/</code> to the <code>@</code> subvolume</li>
<li>mount <code>/home</code> to the <code>@home</code> subvolume</li>
<li>make use of optimized btrfs mount options</li>
</ul>
<p>So open it with a text editor, e.g.:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">nano /mnt/@/etc/fstab
</span></span></code></pre></div><p>or use these <code>sed</code> commands</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/btrfs  defaults/btrfs  defaults,subvol=@,ssd,noatime,space_cache,commit=120,compress=zstd,discard=async/&#39;</span> /mnt/@/etc/fstab
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;UUID=</span><span class="k">$(</span>blkid -s UUID -o value /dev/mapper/data-root<span class="k">)</span><span class="s2">  /home  btrfs  defaults,subvol=@home,ssd,noatime,space_cache,commit=120,compress=zstd,discard=async   0 0&#34;</span> &gt;&gt; /mnt/@/etc/fstab
</span></span></code></pre></div><p>Either way your <code>fstab</code> should look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat /mnt/@/etc/fstab
</span></span><span class="line"><span class="cl"><span class="c1"># PARTUUID=6b533522-0c33-4f44-890f-4be275c5b06f  /boot/efi  vfat  umask=0077  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># PARTUUID=45bb9da4-9571-40bc-8f20-468332234a62  /recovery  vfat  umask=0077  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptswap  none  swap  defaults  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=591dae2e-37ce-42c9-8ceb-5b124658ca6a  /  btrfs  defaults,subvol=@,ssd,noatime,space_cache,commit=120,compress=zstd,discard=async  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=591dae2e-37ce-42c9-8ceb-5b124658ca6a  /home  btrfs  defaults,subvol=@home,ssd,noatime,space_cache,commit=120,compress=zstd,discard=async   0 0</span>
</span></span></code></pre></div><p>Note that your PARTUUID and UUID numbers will be different. The last two lines for <code>/</code> and <code>/home</code> are the important ones.</p>
<h3 id="changes-to-crypttab">Changes to crypttab</h3>
<p>As we use <code>discard=async</code>, we need to add <code>discard</code> to the <code>crypttab</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/luks/luks,discard/&#39;</span> /mnt/@/etc/crypttab
</span></span><span class="line"><span class="cl">cat /mnt/@/etc/crypttab
</span></span><span class="line"><span class="cl"><span class="c1"># cryptdata UUID=c5b8099a-f035-47fb-939f-fa4ea770a403 none luks,discard</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cryptswap UUID=52de8233-c50b-4873-b586-9ab313d28b56 /dev/urandom swap,plain,offset=1024,cipher=aes-xts-plain64,size=512</span>
</span></span></code></pre></div><h3 id="adjust-configuration-of-kernelstub">Adjust configuration of kernelstub</h3>
<p>We need to adjust some settings for the systemd boot manager and also make sure these settings are not overwritten if we install or update kernels and modules. Namely, we need to add <code>rootflags=subvol=@</code> to the <code>&quot;user&quot;</code> kernel options of the kernelstub configuration file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">nano /mnt/@/etc/kernelstub/configuration
</span></span></code></pre></div><p>Here you need to add <code>rootflags=subvol=@</code> to the <code>&quot;user&quot;</code> kernel options. That is, your configuration file should look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat /mnt/@/etc/kernelstub/configuration
</span></span><span class="line"><span class="cl"><span class="c1"># {</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   &#34;default&#34;: {</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;kernel_options&#34;: [</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;quiet&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;splash&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ],</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;esp_path&#34;: &#34;/boot/efi&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;setup_loader&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;manage_mode&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;force_update&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;live_mode&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;config_rev&#34;:3</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   },</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   &#34;user&#34;: {</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;kernel_options&#34;: [</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;quiet&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;loglevel=0&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;systemd.show_status=false&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;splash&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;rootflags=subvol=@&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ],</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;esp_path&#34;: &#34;/boot/efi&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;setup_loader&#34;: true,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;manage_mode&#34;: true,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;force_update&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;live_mode&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;config_rev&#34;:3</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   }</span>
</span></span><span class="line"><span class="cl"><span class="c1"># }</span>
</span></span></code></pre></div><p><strong>VERY IMPORTANTLY: Don&rsquo;t forget the comma after <code>&quot;splash&quot;</code> (in the line above your added <code>&quot;rootflags=subvol=@&quot;</code> option) , otherwise you get errors when you later run <code>update-initramfs</code> (see below)!</strong></p>
<h3 id="adjust-configuration-of-systemd-bootloader">Adjust configuration of systemd bootloader</h3>
<p>We need to adjust some settings for the systemd boot manager, so let&rsquo;s mount our EFI partition</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">mount /dev/nvme0n1p1 /mnt/@/boot/efi
</span></span></code></pre></div><p>Add <code>rootflags=subvol=@</code> to last line of <code>Pop_OS_current.conf</code> either using a text editor or the following command</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/splash/splash rootflags=subvol=@/&#39;</span> /mnt/@/boot/efi/loader/entries/Pop_OS-current.conf
</span></span><span class="line"><span class="cl">cat /mnt/@/boot/efi/loader/entries/Pop_OS-current.conf
</span></span><span class="line"><span class="cl"><span class="c1"># title Pop!_OS</span>
</span></span><span class="line"><span class="cl"><span class="c1"># linux /EFI/Pop_OS-UUID_of_data-root/vmlinuz.efi</span>
</span></span><span class="line"><span class="cl"><span class="c1"># initrd /EFI/Pop_OS-UUID_of_data-root/initrd.img</span>
</span></span><span class="line"><span class="cl"><span class="c1"># options root=UUID=UUID_of_data-root ro quiet loglevel=0 systemd.show_status=false splash rootflags=subvol=@</span>
</span></span></code></pre></div><p>where <code>UUID_of_data-root</code> is the UUID of /dev/mapper/data-root.</p>
<p>Optionally, add a timeout to the systemd boot menu in order to easily access the recovery partition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;timeout 2&#34;</span> &gt;&gt; /mnt/@/boot/efi/loader/loader.conf
</span></span><span class="line"><span class="cl">cat /mnt/@/boot/efi/loader/loader.conf 
</span></span><span class="line"><span class="cl"><span class="c1"># default Pop_OS-current</span>
</span></span><span class="line"><span class="cl"><span class="c1"># timeout 2</span>
</span></span></code></pre></div><h3 id="create-a-chroot-environment-and-update-initramfs">Create a chroot environment and update initramfs</h3>
<p>Now, let&rsquo;s create a chroot environment, which enables you to work directly inside your newly installed OS, without actually rebooting. For this, unmount the top-level root filesystem from <code>/mnt</code> and remount the subvolume <code>@</code> which we created for <code>/</code> to <code>/mnt</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">cd</span> /
</span></span><span class="line"><span class="cl">umount -l /mnt
</span></span><span class="line"><span class="cl">mount -o defaults,subvol<span class="o">=</span>@,ssd,noatime,space_cache,commit<span class="o">=</span>120,compress<span class="o">=</span>zstd,discard<span class="o">=</span>async /dev/mapper/data-root /mnt
</span></span></code></pre></div><p>Then the following commands will put us into our system using chroot:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="k">for</span> i in /dev /dev/pts /proc /sys /run<span class="p">;</span> <span class="k">do</span> mount -B <span class="nv">$i</span> /mnt<span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>
</span></span><span class="line"><span class="cl">chroot /mnt
</span></span></code></pre></div><p>Cool, you are now inside your system and we can check whether our <code>fstab</code> mounts everything correctly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">mount -av
</span></span><span class="line"><span class="cl"><span class="c1"># /boot/efi                : successfully mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /recovery                : successfully mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># none                     : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /                        : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /home                    : successfully mounted</span>
</span></span></code></pre></div><p>Looks good! Now we need to update the initramfs to make it aware of our changes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">update-initramfs -c -k all
</span></span></code></pre></div><p>Note that if you run into errors like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">update-initramfs: Generating /boot/initrd.img-5.11.0-7620-generic
</span></span><span class="line"><span class="cl">kernelstub.Config    : INFO     Looking <span class="k">for</span> configuration...
</span></span><span class="line"><span class="cl">Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/bin/kernelstub&#34;</span>, line 244, in &lt;module&gt;
</span></span><span class="line"><span class="cl">    main<span class="o">()</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/bin/kernelstub&#34;</span>, line 241, in main
</span></span><span class="line"><span class="cl">    kernelstub.main<span class="o">(</span>args<span class="o">)</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3/dist-packages/kernelstub/application.py&#34;</span>, line 142, in main
</span></span><span class="line"><span class="cl">    <span class="nv">config</span> <span class="o">=</span> Config.Config<span class="o">()</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3/dist-packages/kernelstub/config.py&#34;</span>, line 50, in __init__
</span></span><span class="line"><span class="cl">    self.config <span class="o">=</span> self.load_config<span class="o">()</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3/dist-packages/kernelstub/config.py&#34;</span>, line 60, in load_config
</span></span><span class="line"><span class="cl">    self.config <span class="o">=</span> json.load<span class="o">(</span>config_file<span class="o">)</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3.9/json/__init__.py&#34;</span>, line 293, in load
</span></span><span class="line"><span class="cl">    <span class="k">return</span> loads<span class="o">(</span>fp.read<span class="o">()</span>,
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3.9/json/__init__.py&#34;</span>, line 346, in loads
</span></span><span class="line"><span class="cl">    <span class="k">return</span> _default_decoder.decode<span class="o">(</span>s<span class="o">)</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3.9/json/decoder.py&#34;</span>, line 337, in decode
</span></span><span class="line"><span class="cl">    obj, <span class="nv">end</span> <span class="o">=</span> self.raw_decode<span class="o">(</span>s, <span class="nv">idx</span><span class="o">=</span>_w<span class="o">(</span>s, 0<span class="o">)</span>.end<span class="o">())</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3.9/json/decoder.py&#34;</span>, line 353, in raw_decode
</span></span><span class="line"><span class="cl">    obj, <span class="nv">end</span> <span class="o">=</span> self.scan_once<span class="o">(</span>s, idx<span class="o">)</span>
</span></span><span class="line"><span class="cl">json.decoder.JSONDecodeError: Expecting <span class="s1">&#39;,&#39;</span> delimiter: line <span class="m">20</span> column <span class="m">7</span> <span class="o">(</span>char 363<span class="o">)</span>
</span></span><span class="line"><span class="cl">run-parts: /etc/initramfs/post-update.d//zz-kernelstub exited with <span class="k">return</span> code <span class="m">1</span>
</span></span></code></pre></div><p>you probably forgot a comma after <code>&quot;splash&quot;</code> in the <code>/etc/kernelstub/configuration</code> file (see above).</p>
<h2 id="step-4-reboot-some-checks-and-update-system">Step 4: Reboot, some checks, and update system</h2>
<p>Now, it is time to exit the chroot - cross your fingers - and reboot the system:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">exit</span>
</span></span><span class="line"><span class="cl"><span class="c1"># exit</span>
</span></span><span class="line"><span class="cl">reboot now
</span></span></code></pre></div><p>If all went well you should see a single passphrase prompt (YAY!), where you enter the luks passphrase and your system boots.</p>
<p>Now let&rsquo;s click through the welcome screen and open a terminal to see whether everything is set up correctly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo mount -av
</span></span><span class="line"><span class="cl"><span class="c1"># /boot/efi                : already mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /recovery                : already mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># none                     : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /                        : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /home                    : already mounted</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo mount -v <span class="p">|</span> grep /dev/mapper
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/data-root on / type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache,commit=120,subvolid=265,subvol=/@)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/data-root on /home type btrfs (rw,noatime,compress=zstd:3,ssd,discard=async,space_cache,commit=120,subvolid=266,subvol=/@home)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo swapon
</span></span><span class="line"><span class="cl"><span class="c1"># NAME      TYPE      SIZE USED PRIO</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/dm-2 partition   4G   0B   -2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo btrfs filesystem show /
</span></span><span class="line"><span class="cl"><span class="c1"># Label: none  uuid: 591dae2e-37ce-42c9-8ceb-5b124658ca6a</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Total devices 1 FS bytes used 8.15GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	devid    1 size 468.43GiB used 10.02GiB path /dev/mapper/data-root</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo btrfs subvolume list /
</span></span><span class="line"><span class="cl"><span class="c1"># ID 265 gen 82 top level 5 path @</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ID 266 gen 82 top level 5 path @home</span>
</span></span></code></pre></div><p>If all look&rsquo;s good, let&rsquo;s update and upgrade the system:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt upgrade
</span></span><span class="line"><span class="cl">sudo apt dist-upgrade
</span></span><span class="line"><span class="cl">sudo apt autoremove
</span></span><span class="line"><span class="cl">sudo apt autoclean
</span></span><span class="line"><span class="cl">flatpak update
</span></span></code></pre></div><p>If you installed on a SSD or NVME, enable <code>fstrim.timer</code> as <a href="https://www.phoronix.com/scan.php?page=news_item&amp;px=Fedora-Btrfs-Opts-Discard-Comp" target="_blank" rel="noopener">both fstrim and discard=async mount option can peacefully co-exist</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> fstrim.timer
</span></span></code></pre></div><p>Again, for <a href="https://www.heise.de/ct/hotline/Linux-Verschluesselte-SSD-trimmen-2405875.html" target="_blank" rel="noopener">SSD trimming to work properly</a>, it is important that you add <code>discard</code> to your <code>crypttab</code> (see above). Also check whether you find <code>issue_discards=1</code> in <code>/etc/lvm/lvm.conf</code> (which should be correct by default):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo grep <span class="s2">&#34;issue_discards&#34;</span> /etc/lvm/lvm.conf 
</span></span><span class="line"><span class="cl"><span class="c1"># 	# Configuration option devices/issue_discards.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	issue_discards = 1</span>
</span></span></code></pre></div><p>Now reboot:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo reboot now
</span></span></code></pre></div><h2 id="step-5-automatic-snapshots-and-backups-with-btrfs-using-btrbk">Step 5: automatic snapshots and backups with btrfs using BTRBK</h2>
<h3 id="step-5a-preparations">Step 5a: preparations</h3>
<p>First I create a mount point <code>/btrfs_pool</code> for the top-level root of my btrfs partition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo mkdir /btrfs_pool
</span></span></code></pre></div><p>Next I add an entry to the fstab to mount this at boot time:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;UUID=</span><span class="k">$(</span>blkid -s UUID -o value /dev/mapper/data-root<span class="k">)</span><span class="s2">  /btrfs_pool  btrfs  defaults,subvolid=5,ssd,noatime,space_cache,commit=120,compress=zstd,discard=async   0 0&#34;</span> <span class="p">|</span> sudo tee -a /etc/fstab
</span></span><span class="line"><span class="cl">cat /etc/fstab
</span></span><span class="line"><span class="cl"><span class="c1"># PARTUUID=6b533522-0c33-4f44-890f-4be275c5b06f  /boot/efi  vfat  umask=0077  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># PARTUUID=45bb9da4-9571-40bc-8f20-468332234a62  /recovery  vfat  umask=0077  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptswap  none  swap  defaults  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=591dae2e-37ce-42c9-8ceb-5b124658ca6a  /  btrfs  defaults,subvol=@,ssd,noatime,space_cache,commit=120,compress=zstd,discard=async  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=591dae2e-37ce-42c9-8ceb-5b124658ca6a  /home  btrfs  defaults,subvol=@home,ssd,noatime,space_cache,commit=120,compress=zstd,discard=async   0 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=591dae2e-37ce-42c9-8ceb-5b124658ca6a  /btrfs_pool  btrfs  defaults,subvolid=5,ssd,noatime,space_cache,commit=120,compress=zstd,discard=async   0 0</span>
</span></span></code></pre></div><p>The last line is added which mounts the top-level (subvolid=5, NOT subvol!) to <code>/btrfs_pool</code>. Let&rsquo;s try the fstab and mount everything:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo mount -av
</span></span><span class="line"><span class="cl"><span class="c1"># /boot/efi                : already mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /recovery                : already mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># none                     : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /                        : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /home                    : already mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /btrfs_pool              : successfully mounted</span>
</span></span></code></pre></div><p>BTRBK needs a folder under the top-level where it stores the snapshots, let&rsquo;s call this folder <code>_btrbk_snap</code> and create it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo mkdir /btrfs_pool/_btrbk_snap
</span></span><span class="line"><span class="cl">ls /btrfs_pool
</span></span><span class="line"><span class="cl"><span class="c1"># @  _btrbk_snap  @home</span>
</span></span></code></pre></div><h3 id="step-5b-install-and-configure-btrbk">Step 5b: install and configure BTRBK</h3>
<p>Install BTRBK from the repos:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">btrbk</span>
</span></span></code></pre></div><p>Next I create the following configuration file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">mkdir -p <span class="nv">$HOME</span>/scripts
</span></span><span class="line"><span class="cl">nano <span class="nv">$HOME</span>/scripts/precision-btrbk.conf
</span></span></code></pre></div><p>My configuration file (just for snapshots) looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">transaction_log         /var/log/btrbk.log
</span></span><span class="line"><span class="cl">lockfile                /var/lock/btrbk.lock
</span></span><span class="line"><span class="cl">timestamp_format        long
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">snapshot_dir            _btrbk_snap
</span></span><span class="line"><span class="cl">snapshot_preserve_min   3h
</span></span><span class="line"><span class="cl">snapshot_preserve       6h 5d 3w 1m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">volume /btrfs_pool
</span></span><span class="line"><span class="cl">  snapshot_create  always
</span></span><span class="line"><span class="cl">  subvolume @
</span></span><span class="line"><span class="cl">  subvolume @home
</span></span></code></pre></div><p>This looks into <code>/btrfs_pool</code> and creates snapshots for the subvolumes <code>@</code> and <code>@home</code> into the directory <code>/btrfs_pool/_btrbk_snap</code>. All snapshots are preserved for at least 3 hours, while the usual retention strategy is to keep 6 hourly, 5 daily, 3 weekly and 1 monthly snapshot. Let&rsquo;s test this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo btrbk -c <span class="nv">$HOME</span>/scripts/precision-btrbk.conf dryrun
</span></span><span class="line"><span class="cl"><span class="c1"># --------------------------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Backup Summary (btrbk command line client, version 0.27.1)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Date:   Mon Dec 13 21:10:45 2021</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Config: /home/wmutschl/scripts/precision-btrbk.conf</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Dryrun: YES</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Legend:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ===  up-to-date subvolume (source snapshot)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     +++  created subvolume (source snapshot)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ---  deleted subvolume</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ***  received subvolume (non-incremental)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &gt;&gt;&gt;  received subvolume (incremental)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --------------------------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /btrfs_pool/@</span>
</span></span><span class="line"><span class="cl"><span class="c1"># +++ /btrfs_pool/_btrbk_snap/@.20211213T2110</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /btrfs_pool/@home</span>
</span></span><span class="line"><span class="cl"><span class="c1"># +++ /btrfs_pool/_btrbk_snap/@home.20211213T2110</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># NOTE: Dryrun was active, none of the operations above were actually executed!</span>
</span></span></code></pre></div><p>If there was no error, let&rsquo;s actually run this to create our first snapshots (this should take a fraction of a second) and see whether they are stored correctly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo btrbk -c <span class="nv">$HOME</span>/scripts/precision-btrbk.conf run
</span></span><span class="line"><span class="cl"><span class="c1"># --------------------------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Backup Summary (btrbk command line client, version 0.27.1)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Date:   Mon Dec 13 21:10:59 2021</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Config: /home/wmutschl/scripts/precision-btrbk.conf</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Legend:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ===  up-to-date subvolume (source snapshot)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     +++  created subvolume (source snapshot)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ---  deleted subvolume</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ***  received subvolume (non-incremental)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &gt;&gt;&gt;  received subvolume (incremental)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --------------------------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /btrfs_pool/@</span>
</span></span><span class="line"><span class="cl"><span class="c1"># +++ /btrfs_pool/_btrbk_snap/@.20211213T2110</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># /btrfs_pool/@home</span>
</span></span><span class="line"><span class="cl"><span class="c1"># +++ /btrfs_pool/_btrbk_snap/@home.20211213T2110</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ls /btrfs_pool/_btrbk_snap
</span></span><span class="line"><span class="cl"><span class="c1"># @.20211213T2110  @home.20211213T2110</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo btrfs subvolume list /
</span></span><span class="line"><span class="cl"><span class="c1"># ID 265 gen 153 top level 5 path @</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ID 266 gen 154 top level 5 path @home</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ID 269 gen 154 top level 5 path _btrbk_snap/@.20211213T2110</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ID 270 gen 154 top level 5 path _btrbk_snap/@home.20211213T2110</span>
</span></span></code></pre></div><h3 id="step-5c-create-systemd-timer-for-btrbk-to-run-every-hour">Step 5c: create systemd timer for BTRBK to run every hour</h3>
<p>On servers that run constantly I usually use the <code>crontab</code> for automatic snapshots with BTRBK; however, on my laptop I use a systemd timer instead. First let&rsquo;s adapt/create the btrbk timer: <code>sudo nano /lib/systemd/system/btrbk.timer</code> which looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>Unit<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Description</span><span class="o">=</span>btrbk hourly snapshots and backup
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Timer<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">OnCalendar</span><span class="o">=</span>hourly
</span></span><span class="line"><span class="cl"><span class="nv">AccuracySec</span><span class="o">=</span>10min
</span></span><span class="line"><span class="cl"><span class="nv">Persistent</span><span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Install<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">WantedBy</span><span class="o">=</span>timers.target
</span></span></code></pre></div><p>Second let&rsquo;s adapt the service <code>sudo nano /lib/systemd/system/btrbk.service</code> which looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>Unit<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Description</span><span class="o">=</span>btrbk snapshots and backup
</span></span><span class="line"><span class="cl"><span class="nv">Documentation</span><span class="o">=</span>man:btrbk<span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Service<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Type</span><span class="o">=</span>oneshot
</span></span><span class="line"><span class="cl"><span class="nv">ExecStart</span><span class="o">=</span>/usr/sbin/btrbk -c /home/wmutschl/scripts/precision-btrbk.conf run
</span></span></code></pre></div><p>Make sure the permissions are correct:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo chmod <span class="m">644</span> /lib/systemd/system/btrbk.timer
</span></span><span class="line"><span class="cl">sudo chmod <span class="m">644</span> /lib/systemd/system/btrbk.service
</span></span></code></pre></div><p>and checkout if it works (tip: you can exit the log outputs by writing <code>:q</code> or hitting <code>CTRL+C</code>)):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo systemctl start btrbk.service
</span></span><span class="line"><span class="cl">sudo systemctl status btrbk.service
</span></span><span class="line"><span class="cl"># ○ btrbk.service - btrbk snapshots and backup
</span></span><span class="line"><span class="cl">#      Loaded: loaded (/lib/systemd/system/btrbk.service; static)
</span></span><span class="line"><span class="cl">#      Active: inactive (dead)
</span></span><span class="line"><span class="cl">#        Docs: man:btrbk(1)
</span></span><span class="line"><span class="cl"># 
</span></span><span class="line"><span class="cl"># Dec 13 21:24:22 pop-os btrbk[6699]:     ---  deleted subvolume
</span></span><span class="line"><span class="cl"># Dec 13 21:24:22 pop-os btrbk[6699]:     ***  received subvolume (non-incremental)
</span></span><span class="line"><span class="cl"># Dec 13 21:24:22 pop-os btrbk[6699]:     &gt;&gt;&gt;  received subvolume (incremental)
</span></span><span class="line"><span class="cl"># Dec 13 21:24:22 pop-os btrbk[6699]: ---------------------------------------------------------&gt;
</span></span><span class="line"><span class="cl"># Dec 13 21:24:22 pop-os btrbk[6699]: /btrfs_pool/@
</span></span><span class="line"><span class="cl"># Dec 13 21:24:22 pop-os btrbk[6699]: +++ /btrfs_pool/_btrbk_snap/@.20211213T2124
</span></span><span class="line"><span class="cl"># Dec 13 21:24:22 pop-os btrbk[6699]: /btrfs_pool/@home
</span></span><span class="line"><span class="cl"># Dec 13 21:24:22 pop-os btrbk[6699]: +++ /btrfs_pool/_btrbk_snap/@home.20211213T2124
</span></span><span class="line"><span class="cl"># Dec 13 21:24:22 pop-os systemd[1]: btrfs-btrbk-systemd.service: Deactivated successfully.
</span></span><span class="line"><span class="cl"># Dec 13 21:24:22 pop-os systemd[1]: Finished btrbk snapshots and backup.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat /var/log/btrbk.log
</span></span><span class="line"><span class="cl"># 2021-12-13T21:24:22+0100 startup v0.27.1 - - - # btrbk command line client, version 0.27.1
</span></span><span class="line"><span class="cl"># 2021-12-13T21:24:22+0100 snapshot starting /btrfs_pool/_btrbk_snap/@.20211213T2124 /btrfs_pool/@ - -
</span></span><span class="line"><span class="cl"># 2021-12-13T21:24:22+0100 snapshot success /btrfs_pool/_btrbk_snap/@.20211213T2124 /btrfs_pool/@ - -
</span></span><span class="line"><span class="cl"># 2021-12-13T21:24:22+0100 snapshot starting /btrfs_pool/_btrbk_snap/@home.20211213T2124 /btrfs_pool/@home - -
</span></span><span class="line"><span class="cl"># 2021-12-13T21:24:22+0100 snapshot success /btrfs_pool/_btrbk_snap/@home.20211213T2124 /btrfs_pool/@home - -
</span></span><span class="line"><span class="cl"># 2021-12-13T21:24:22+0100 finished success - - - -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ls /btrfs_pool/_btrbk_snap
</span></span><span class="line"><span class="cl"># @.20211213T2110  @home.20211213T2110
</span></span><span class="line"><span class="cl"># @.20211213T2124  @home.20211213T2124
</span></span></code></pre></div><p>Check if snapshots are created and if any errors occured. If all is well, then enable the timer:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo systemctl enable btrbk.timer
</span></span><span class="line"><span class="cl"># Created symlink /etc/systemd/system/timers.target.wants/btrbk.timer → /lib/systemd/system/btrbk.timer.
</span></span><span class="line"><span class="cl">sudo systemctl start btrbk.timer
</span></span><span class="line"><span class="cl">sudo systemctl daemon-reload
</span></span><span class="line"><span class="cl">sudo systemctl list-timers --all
</span></span></code></pre></div><p>You should see the following line (tip: you can exit by inserting <code>:q</code> or clicking <code>CTRL+C</code>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">NEXT                        LEFT          LAST                        PASSED       UNIT           ACTIVATES                     
</span></span><span class="line"><span class="cl">Mon 2021-12-13 22:00:00 CET 33min left    n/a                         n/a          btrbk.timer    btrbk.service
</span></span></code></pre></div><p>Recheck the hourly timer after an hour (or 33min in my case) to make sure everything is working:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo systemctl list-timers --all
</span></span><span class="line"><span class="cl">cat /var/log/btrbk.log
</span></span><span class="line"><span class="cl">ls /btrfs_pool/_btrbk_snap
</span></span></code></pre></div><p>Make sure the snapshots are created without errors.</p>
<h3 id="step-5d-optional-mount-an-encrypted-backup-disk-as-btrfs-sendreceive-target">Step 5d (optional): Mount an encrypted backup disk as btrfs send/receive target</h3>
<p>I use the internal SSD as a backup disk to receive the incremental btrfs snapshots. So let&rsquo;s create a GPT table on it, create an encrypted partition and format it with the btrfs filesystem. I usually use GParted for this (after installing it); however, you can also use command-line tools like <code>parted</code>, e.g.:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo parted /dev/sda mklabel gpt
</span></span><span class="line"><span class="cl"><span class="c1"># Warning: The existing disk label on /dev/sda will be destroyed and all data on this disk will</span>
</span></span><span class="line"><span class="cl"><span class="c1"># be lost. Do you want to continue?</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Yes/No? Yes                                                               </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Information: You may need to update /etc/fstab.</span>
</span></span><span class="line"><span class="cl">sudo parted /dev/sda mkpart primary 1MiB 100%
</span></span><span class="line"><span class="cl"><span class="c1"># Information: You may need to update /etc/fstab.</span>
</span></span><span class="line"><span class="cl">sudo parted /dev/sda name <span class="m">1</span> BACKUP
</span></span><span class="line"><span class="cl">sudo parted /dev/sda unit MiB print
</span></span><span class="line"><span class="cl"><span class="c1"># Model: ATA Samsung SSD 840 (scsi)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Disk /dev/sda: 476940MiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sector size (logical/physical): 512B/512B</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Partition Table: gpt</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Disk Flags: </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Number  Start    End        Size       File system  Name    Flags</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  1      1.00MiB  476940MiB  476939MiB               BACKUP</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo cryptsetup luksFormat /dev/sda1
</span></span><span class="line"><span class="cl"><span class="c1"># WARNING: Device /dev/sda1 already contains a &#39;crypto_LUKS&#39; superblock signature.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># WARNING!</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ========</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This will overwrite data on /dev/sda1 irrevocably.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Are you sure? (Type &#39;yes&#39; in capital letters): YES</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Enter passphrase for /dev/sda1: </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Verify passphrase: </span>
</span></span><span class="line"><span class="cl">sudo cryptsetup luksOpen /dev/sda1 cryptbackup
</span></span><span class="line"><span class="cl"><span class="c1"># Enter passphrase for /dev/sda1: </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo mkfs.btrfs /dev/mapper/cryptbackup 
</span></span><span class="line"><span class="cl"><span class="c1"># btrfs-progs v5.10.1 </span>
</span></span><span class="line"><span class="cl"><span class="c1"># See http://btrfs.wiki.kernel.org for more information.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Detected a SSD, turning off metadata duplication.  Mkfs with -m dup if you want to force metadata duplication.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Label:              (null)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID:               6f462de9-8148-4b61-b390-c1b9038cb367</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Node size:          16384</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sector size:        4096</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Filesystem size:    465.75GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Block group profiles:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   Data:             single            8.00MiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   Metadata:         single            8.00MiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   System:           single            4.00MiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># SSD detected:       yes</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Incompat features:  extref, skinny-metadata</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Runtime features:   </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Checksum:           crc32c</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Number of devices:  1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Devices:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    ID        SIZE  PATH</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     1   465.75GiB  /dev/mapper/cryptbackup</span>
</span></span></code></pre></div><p>Let&rsquo;s create a mount point <code>/btrfs_backup</code> for this disk and update the fstab:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo mkdir /btrfs_backup
</span></span></code></pre></div><p>Next I add an entry to the fstab to mount this at boot time:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;UUID=</span><span class="k">$(</span>blkid -s UUID -o value /dev/mapper/cryptbackup<span class="k">)</span><span class="s2">  /btrfs_backup  btrfs  defaults,subvolid=5,ssd,noatime,space_cache,commit=120,compress=zstd,discard=async   0 0&#34;</span> <span class="p">|</span> sudo tee -a /etc/fstab
</span></span><span class="line"><span class="cl">cat /etc/fstab
</span></span><span class="line"><span class="cl"><span class="c1"># PARTUUID=6b533522-0c33-4f44-890f-4be275c5b06f  /boot/efi  vfat  umask=0077  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># PARTUUID=45bb9da4-9571-40bc-8f20-468332234a62  /recovery  vfat  umask=0077  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptswap  none  swap  defaults  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=591dae2e-37ce-42c9-8ceb-5b124658ca6a  /  btrfs  defaults,subvol=@,ssd,noatime,space_cache,commit=120,compress=zstd,discard=async  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=591dae2e-37ce-42c9-8ceb-5b124658ca6a  /home  btrfs  defaults,subvol=@home,ssd,noatime,space_cache,commit=120,compress=zstd,discard=async   0 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=591dae2e-37ce-42c9-8ceb-5b124658ca6a  /btrfs_pool  btrfs  defaults,subvolid=5,ssd,noatime,space_cache,commit=120,compress=zstd,discard=async   0 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=6f462de9-8148-4b61-b390-c1b9038cb367  /btrfs_backup  btrfs  defaults,subvolid=5,ssd,noatime,space_cache,commit=120,compress=zstd,discard=async   0 0</span>
</span></span></code></pre></div><p>The last line is added which mounts the top-level (subvolid=5, NOT subvol!) to <code>/btrfs_backup</code>. Let&rsquo;s try the fstab and mount everything:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo mount -av
</span></span><span class="line"><span class="cl"><span class="c1"># /boot/efi                : already mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /recovery                : already mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># none                     : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /                        : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /home                    : already mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /btrfs_pool              : successfully mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /btrfs_backup            : successfully mounted</span>
</span></span></code></pre></div><p>I want my system to automatically unlock my backup disk such that I need to type my luks passphrase only once (this step is optional, but recommended). So let&rsquo;s create a key-file, secure it, and add it to our luks partition of the backup disk:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo mkdir /etc/luks
</span></span><span class="line"><span class="cl">sudo dd <span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">of</span><span class="o">=</span>/etc/luks/boot_os.keyfile <span class="nv">bs</span><span class="o">=</span><span class="m">4096</span> <span class="nv">count</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1+0 records in</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1+0 records out</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 4096 bytes (4.1 kB, 4.0 KiB) copied, 0.000928939 s, 4.4 MB/s</span>
</span></span><span class="line"><span class="cl">sudo chmod <span class="nv">u</span><span class="o">=</span>rx,go-rwx /etc/luks
</span></span><span class="line"><span class="cl">sudo chmod <span class="nv">u</span><span class="o">=</span>r,go-rwx /etc/luks/boot_os.keyfile
</span></span><span class="line"><span class="cl">sudo cryptsetup luksAddKey /dev/sda1 /etc/luks/boot_os.keyfile
</span></span><span class="line"><span class="cl"><span class="c1"># Enter any existing passphrase: </span>
</span></span></code></pre></div><p>Let&rsquo;s restrict the pattern of keyfiles and avoid leaking key material for the initramfs hook:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;KEYFILE_PATTERN=/etc/luks/*.keyfile&#34;</span> <span class="p">|</span> sudo tee -a /etc/cryptsetup-initramfs/conf-hook
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;UMASK=0077&#34;</span> <span class="p">|</span> sudo tee -a /etc/initramfs-tools/initramfs.conf
</span></span></code></pre></div><p>These commands will harden the security options in the intiramfs configuration file and hook (<em>not sure if this is also needed for systemd bootloader?!?</em>).</p>
<p>Next, add the keyfile to your <code>crypttab</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;cryptbackup UUID=</span><span class="k">$(</span>blkid -s UUID -o value /dev/sda1<span class="k">)</span><span class="s2"> /etc/luks/boot_os.keyfile luks,discard&#34;</span> <span class="p">|</span> sudo tee -a /etc/crypttab
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat /etc/crypttab
</span></span><span class="line"><span class="cl"><span class="c1"># cryptdata UUID=c5b8099a-f035-47fb-939f-fa4ea770a403 none luks,discard</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cryptswap UUID=52de8233-c50b-4873-b586-9ab313d28b56 /dev/urandom swap,plain,offset=1024,cipher=aes-xts-plain64,size=512</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cryptbackup UUID=87278135-9aec-4da7-9fe4-fca1ecf2aeb7 /etc/luks/boot_os.keyfile luks,discard</span>
</span></span></code></pre></div><p>and update the initramfs:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo update-initramfs -u -k all
</span></span></code></pre></div><p>BTRBK needs folders under the top-level of your backup disk where it stores the received snapshots, let&rsquo;s call these folders <code>@</code> and <code>@home</code> and create it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo mkdir /btrfs_backup/@
</span></span><span class="line"><span class="cl">sudo mkdir /btrfs_backup/@home
</span></span><span class="line"><span class="cl">ls /btrfs_backup
</span></span><span class="line"><span class="cl"><span class="c1"># @  @home</span>
</span></span></code></pre></div><p>We need to also change the configuration file used for BTRBK: <code>nano $HOME/scripts/precision-btrbk.conf</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">transaction_log         /var/log/btrbk.log
</span></span><span class="line"><span class="cl">lockfile                /var/lock/btrbk.lock
</span></span><span class="line"><span class="cl">timestamp_format        long
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">snapshot_dir            _btrbk_snap
</span></span><span class="line"><span class="cl">snapshot_preserve_min   3h
</span></span><span class="line"><span class="cl">snapshot_preserve       6h 5d 3w 1m
</span></span><span class="line"><span class="cl">target_preserve_min     3h
</span></span><span class="line"><span class="cl">target_preserve         24h 31d 52w
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">volume /btrfs_pool
</span></span><span class="line"><span class="cl">  snapshot_create  always
</span></span><span class="line"><span class="cl">  target send-receive /btrfs_backup
</span></span><span class="line"><span class="cl">  subvolume @
</span></span><span class="line"><span class="cl">  subvolume @home
</span></span></code></pre></div><p>Let&rsquo;s first run it in dry mode:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo btrbk -c <span class="nv">$HOME</span>/scripts/precision-btrbk.conf dryrun
</span></span></code></pre></div><p>If there was no error, run it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo btrbk -c <span class="nv">$HOME</span>/scripts/precision-btrbk.conf run --progress
</span></span></code></pre></div><p>This will take a while, because the initial backup is transferred to your backup disk. All other snapshots will be sent and received incrementially.</p>
<h3 id="step-5e-optional-automatic-snapshots-for-any-apt-operation">Step 5e (optional): Automatic snapshots for any apt operation</h3>
<p>TBA</p>
<p>Now, if you run <code>sudo apt install|remove|upgrade|dist-upgrade</code>, <em>btrbk</em> will create a snapshot of your system, but these won&rsquo;t be sent to your backup disk right away, but only every hour.</p>
<p><strong>FINISHED! CONGRATULATIONS AND THANKS FOR STICKING THROUGH!</strong></p>
<p><strong>Check out my <a href="../pop-os-post-install">Pop!_OS post-installation steps</a>.</strong></p>
<p><strong>If you ever need to rollback your system, checkout my <a href="../../timeshift">Recovery and system rollback</a>.</strong></p>


          </div>

          

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/linux/">linux</a>
  
  <a class="badge badge-light" href="/tag/pop-os/">pop-os</a>
  
  <a class="badge badge-light" href="/tag/install-guide/">install guide</a>
  
  <a class="badge badge-light" href="/tag/btrfs/">btrfs</a>
  
  <a class="badge badge-light" href="/tag/luks/">luks</a>
  
  <a class="badge badge-light" href="/tag/timeshift/">timeshift</a>
  
  <a class="badge badge-light" href="/tag/timeshift-autosnap-apt/">timeshift-autosnap-apt</a>
  
</div>



          
          
          <div class="article-widget">
            
<div class="post-nav">
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Previous</div>
    <a href="/linux/fedora-btrfs-35/" rel="next">Fedora Workstation 35 with automatic btrfs snapshots and backups using BTRBK</a>
  </div>
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Next</div>
    <a href="/linux/pop-os-btrfs-21-04/" rel="prev">Pop!_OS 21.04: installation guide with btrfs-LVM-luks and auto-apt snapshots with Timeshift</a>
  </div>
  
</div>

          </div>
          
        </div>

        <div class="body-footer">
          <p>Last updated on Jun 17, 2022</p>

          




          




          


        </div>

      </article>

      <footer class="site-footer">

  












  

  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
  </p>
  

  

  
  






  
  
  

  
  
  
    
  

  

  
  <p class="powered-by copyright-license-text">
    © 2023 Willi Mutschler. This work is licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0" rel="noopener noreferrer" target="_blank">CC BY SA 4.0</a>
  </p>
  

  <p class="powered-by footer-license-icons">
    <a href="https://creativecommons.org/licenses/by-sa/4.0" rel="noopener noreferrer" target="_blank" aria-label="Creative Commons">
      <i class="fab fa-creative-commons fa-2x" aria-hidden="true"></i>
      <i class="fab fa-creative-commons-by fa-2x" aria-hidden="true"></i>
      
      
        <i class="fab fa-creative-commons-sa fa-2x" aria-hidden="true"></i>
      
    </a>
  </p>




  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Wowchemy</a> — the free, <a href="https://github.com/wowchemy/wowchemy-hugo-themes" target="_blank" rel="noopener">open source</a> website builder that empowers creators.
    
  </p>
</footer>


    </main>
  </div>
</div>

  </div>

  <div class="page-footer">
    
    
  </div>

  


<script src="/js/vendor-bundle.min.46271ef31da3f018e9cd1b59300aa265.js"></script>




  

  
  

  






  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.js" integrity="" crossorigin="anonymous"></script>




<script src="https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>





  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>











  
  


<script src="/en/js/wowchemy.min.a6238d5886fa4a2f7cf92df25709326f.js"></script>



  <script src="/js/wowchemy-map.a26e9d2f7238ba5b868384f1c5bc6477.js" type="module"></script>




















</body>
</html>
