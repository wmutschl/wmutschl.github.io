<!DOCTYPE html><html lang="en-us" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.6.0 for Hugo" />
  

  
  












  
  










  







  
  

  
  
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Willi Mutschler" />

  
  
  
    
  
  <meta name="description" content="In this guide I will walk you through the installation procedure to get an Ubuntu 20.04 system with a luks-encrypted partition for the root filesystem (including /boot) formatted with btrfs that contains a subvolume @ for / and a subvolume @home for /home. I will show how to optimize the btrfs mount options and how to add a key-file to type the luks passphrase only once for GRUB. I will also cover how to setup an encrypted swap partition or swapfile. This layout enables one to use Timeshift and timeshift-autosnap-apt which will regularly take snapshots of the system and particularly on any apt operation. Moreover, using grub-btrfs all snapshots can be accessed and booted into from the GRUB menu." />

  
  <link rel="alternate" hreflang="en-us" href="https://mutschler.dev/linux/ubuntu-btrfs-20-04/" />

  
  
  
    <meta name="theme-color" content="#bbdefb" />
  

  
  
    
    <script src="/js/mathjax-config.js"></script>
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha512-W0xM4mr6dEP9nREo7Z9z+9X70wytKvMGeDsj7ps2+xg5QPrEBXC8tAW1IFnzjR6eoJ90JmCnFzerQJTLzIEHjA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    
    
    
    
      
      
    
    
    

    
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.css" integrity="" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.8916ecd0e6b91586be6f7b434c75fb00.css" />

  
  
  
  
  
  
  
    
    
    <link rel="stylesheet" href="/css/libs/chroma/github-light.min.css" title="hl-light" media="print" onload="this.media='all'" disabled>
    <link rel="stylesheet" href="/css/libs/chroma/dracula.min.css" title="hl-dark" media="print" onload="this.media='all'" >
  

  
  



  


  


  




  
  
  

  
  

  
  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  
  <link rel="icon" type="image/png" href="/media/icon_hu589851f325050e29bd29c51f9d799271_45964_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu589851f325050e29bd29c51f9d799271_45964_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://mutschler.dev/linux/ubuntu-btrfs-20-04/" />

  
  
  
  
  
  
  
  
    
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary" />
  
  <meta property="og:site_name" content="mutschler.dev" />
  <meta property="og:url" content="https://mutschler.dev/linux/ubuntu-btrfs-20-04/" />
  <meta property="og:title" content="Ubuntu Desktop 20.04: installation guide with btrfs-luks full disk encryption including /boot and auto-apt snapshots with Timeshift | mutschler.dev" />
  <meta property="og:description" content="In this guide I will walk you through the installation procedure to get an Ubuntu 20.04 system with a luks-encrypted partition for the root filesystem (including /boot) formatted with btrfs that contains a subvolume @ for / and a subvolume @home for /home. I will show how to optimize the btrfs mount options and how to add a key-file to type the luks passphrase only once for GRUB. I will also cover how to setup an encrypted swap partition or swapfile. This layout enables one to use Timeshift and timeshift-autosnap-apt which will regularly take snapshots of the system and particularly on any apt operation. Moreover, using grub-btrfs all snapshots can be accessed and booted into from the GRUB menu." /><meta property="og:image" content="https://mutschler.dev/media/icon_hu589851f325050e29bd29c51f9d799271_45964_512x512_fill_lanczos_center_3.png" />
    <meta property="twitter:image" content="https://mutschler.dev/media/icon_hu589851f325050e29bd29c51f9d799271_45964_512x512_fill_lanczos_center_3.png" /><meta property="og:locale" content="en-us" />
  
    
      <meta
        property="article:published_time"
        content="2020-05-08T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2022-08-14T20:11:21&#43;02:00">
  

  



  

  


  <title>Ubuntu Desktop 20.04: installation guide with btrfs-luks full disk encryption including /boot and auto-apt snapshots with Timeshift | mutschler.dev</title>

  
  
  
  











</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper  dark " data-wc-page-id="ac7606b7554b0fe115ccbb03da1d605e" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.22ad66a4f96b4e9da14bbb023ea57684.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="Search...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    












<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/">mutschler.dev</a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/">mutschler.dev</a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/apple/"><span>Apple</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/linux/"><span>Linux</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/stuff/"><span>Stuff</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://buymeacoffee.com/mutschler" data-toggle="tooltip" data-placement="bottom" title="Buy me a coffee" target="_blank" rel="noopener" aria-label="Buy me a coffee">
                <i class="fas fa-coffee" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="mailto:willi@mutschler.dev" data-toggle="tooltip" data-placement="bottom" title="Write me an email"  aria-label="Write me an email">
                <i class="fas fa-envelope" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://github.com/wmutschl" data-toggle="tooltip" data-placement="bottom" title="Follow me on GitHub" target="_blank" rel="noopener" aria-label="Follow me on GitHub">
                <i class="fab fa-github" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://gitlab.com/wmutschl" data-toggle="tooltip" data-placement="bottom" title="Follow me on Gitlab" target="_blank" rel="noopener" aria-label="Follow me on Gitlab">
                <i class="fab fa-gitlab" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://www.youtube.com/c/wmutschl" data-toggle="tooltip" data-placement="bottom" title="Follow me on YouTube" target="_blank" rel="noopener" aria-label="Follow me on YouTube">
                <i class="fab fa-youtube" aria-hidden="true"></i>
              </a>
            </li>
          
        

        
        
        <li class="nav-item">
          <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    




<div class="container-fluid docs">
  <div class="row flex-xl-nowrap">
    <div class="col-12 col-md-3 col-xl-2 docs-sidebar">
      <form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <div class="d-flex">
      <span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">
        
        
          Linux
        
      </span>
      <span><i class="fas fa-chevron-down"></i></span>
    </div>
  </button>

  
  <button class="form-control sidebar-search js-search d-none d-md-flex">
    <i class="fas fa-search pr-2"></i>
    <span class="sidebar-search-text">Search...</span>
    <span class="sidebar-search-shortcut">/</span>
  </button>
  
</form>

<nav class="collapse docs-links" id="docs-nav">
  
  
  
  
  
  

  
  
    

    
      

      


  
    
    
    
    
      
    
    

    
      <ul class="nav docs-sidenav">
        <li class=""><a href="/linux/">Linux</a></li>
    
      


  <li class=""><a href="/linux/pop-os-btrfs-24-04/">Pop!_OS 24.04: installation guide with BTRFS, LUKS encryption and auto snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/elementary-os-post-install/">elementary OS: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/elementary-os-6-1/">elementary OS 6.1 JÃ³lnir: installation guide with btrfs, luks encryption and auto snapshots with timeshift</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-22-04/">Pop!_OS 22.04: installation guide with btrfs, luks encryption and auto snapshots with timeshift</a></li>



  <li class=""><a href="/linux/pop-os-post-install/">Pop!_OS: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/fedora-post-install/">Fedora Workstation: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/fedora-btrfs-35/">Fedora Workstation 35 with automatic btrfs snapshots and backups using BTRBK</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-21-10/">DRAFT: Pop!_OS 21.10: installation guide with btrfs-LVM-luks and auto snapshots with BTRBK</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-21-04/">Pop!_OS 21.04: installation guide with btrfs-LVM-luks and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/raspi-post-install/">Ubuntu Server Raspberry Pi: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/raspi-btrfs/">Ubuntu Server 20.10 on Raspberry Pi 4: installation guide with USB Boot (no SD card) and full disk encryption (excluding /boot) using btrfs-inside-luks and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/fedora-btrfs-33/">Fedora Workstation 33: installation guide with btrfs-luks full disk encryption (optionally including /boot) and auto snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/btrfs/">Why I (still) like btrfs</a></li>



  <li class=""><a href="/linux/ubuntu-btrfs-raid1-20-04/">Ubuntu Desktop 20.04: installation guide with btrfs-luks-RAID1 full disk encryption including /boot and auto-apt snapshots with Timeshift</a></li>



  <li class="active"><a href="/linux/ubuntu-btrfs-20-04/">Ubuntu Desktop 20.04: installation guide with btrfs-luks full disk encryption including /boot and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/ubuntu-post-install/">Ubuntu Desktop: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-raid1-20-04/">Pop!_OS 20.04: installation guide with btrfs-LVM-luks-RAID1 and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-20-04/">Pop!_OS 20.04: installation guide with btrfs-LVM-luks and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/timeshift/">Timeshift</a></li>

      
    

    
      </ul>
    

  
</nav>

    </div>

    
    
    <div class="d-none d-xl-block col-xl-2 docs-toc">
      












      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
      </ul>

      <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#step-0-general-remarks">Step 0: General remarks</a></li>
    <li><a href="#step-1-boot-the-install-check-uefi-mode-and-open-an-interactive-root-shell">Step 1: Boot the install, check UEFI mode and open an interactive root shell</a></li>
    <li><a href="#step-2-prepare-partitions-manually">Step 2: Prepare partitions manually</a>
      <ul>
        <li><a href="#create-partition-table-and-layout">Create partition table and layout</a></li>
        <li><a href="#create-luks1-partition">Create luks1 partition</a></li>
        <li><a href="#create-filesystems-for-root-and-efi-system-partitions">Create filesystems for root and EFI System partitions</a></li>
      </ul>
    </li>
    <li><a href="#step-3-optional-optimize-mount-options-for-ssd-or-nvme-drives">Step 3 (optional): Optimize mount options for SSD or NVME drives</a></li>
    <li><a href="#step-4-install-ubuntu-using-the-ubiquity-installer-without-the-bootloader">Step 4: Install Ubuntu using the Ubiquity installer without the bootloader</a></li>
    <li><a href="#step-5-post-installation-steps">Step 5: Post-Installation steps</a>
      <ul>
        <li><a href="#create-a-chroot-environment-and-enter-your-system">Create a chroot environment and enter your system</a></li>
        <li><a href="#create-crypttab">Create crypttab</a></li>
        <li><a href="#encrypted-swap">Encrypted swap</a></li>
        <li><a href="#add-a-key-file-to-type-luks-passphrase-only-once-optional-but-recommended">Add a key-file to type luks passphrase only once (optional, but recommended)</a></li>
        <li><a href="#install-the-efi-bootloader">Install the EFI bootloader</a></li>
      </ul>
    </li>
    <li><a href="#step-6-reboot-some-checks-and-update-system">Step 6: Reboot, some checks, and update system</a></li>
    <li><a href="#step-7-install-timeshift-timeshift-autosnap-apt-and-grub-btrfs">Step 7: Install Timeshift, timeshift-autosnap-apt and grub-btrfs</a></li>
  </ul>
</nav>

      











    </div>
    

    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role="main">

      <article class="article">

        <div class="docs-article-container">
          
        </div>

        
        

        <div class="docs-article-container">
          
          <h1>Ubuntu Desktop 20.04: installation guide with btrfs-luks full disk encryption including /boot and auto-apt snapshots with Timeshift</h1>

          <div class="article-style">

            
            

            <p><em><strong>Please feel free to raise any comments or issues on the <a href="https://github.com/wmutschl/mutschler.dev" target="_blank" rel="noopener">website&rsquo;s Github repository</a>. Pull requests are very much appreciated.</strong></em>
<a href="https://www.buymeacoffee.com/mutschler" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-red.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;" ></a></p>
<p>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/yRSElRlp7TQ" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<em>Note that this written guide is an updated version of the video and contains much more information.</em>
<details class="toc-inpage d-print-none d-xl-none " open>
  <summary class="font-weight-bold">Table of Contents</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#step-0-general-remarks">Step 0: General remarks</a></li>
    <li><a href="#step-1-boot-the-install-check-uefi-mode-and-open-an-interactive-root-shell">Step 1: Boot the install, check UEFI mode and open an interactive root shell</a></li>
    <li><a href="#step-2-prepare-partitions-manually">Step 2: Prepare partitions manually</a>
      <ul>
        <li><a href="#create-partition-table-and-layout">Create partition table and layout</a></li>
        <li><a href="#create-luks1-partition">Create luks1 partition</a></li>
        <li><a href="#create-filesystems-for-root-and-efi-system-partitions">Create filesystems for root and EFI System partitions</a></li>
      </ul>
    </li>
    <li><a href="#step-3-optional-optimize-mount-options-for-ssd-or-nvme-drives">Step 3 (optional): Optimize mount options for SSD or NVME drives</a></li>
    <li><a href="#step-4-install-ubuntu-using-the-ubiquity-installer-without-the-bootloader">Step 4: Install Ubuntu using the Ubiquity installer without the bootloader</a></li>
    <li><a href="#step-5-post-installation-steps">Step 5: Post-Installation steps</a>
      <ul>
        <li><a href="#create-a-chroot-environment-and-enter-your-system">Create a chroot environment and enter your system</a></li>
        <li><a href="#create-crypttab">Create crypttab</a></li>
        <li><a href="#encrypted-swap">Encrypted swap</a></li>
        <li><a href="#add-a-key-file-to-type-luks-passphrase-only-once-optional-but-recommended">Add a key-file to type luks passphrase only once (optional, but recommended)</a></li>
        <li><a href="#install-the-efi-bootloader">Install the EFI bootloader</a></li>
      </ul>
    </li>
    <li><a href="#step-6-reboot-some-checks-and-update-system">Step 6: Reboot, some checks, and update system</a></li>
    <li><a href="#step-7-install-timeshift-timeshift-autosnap-apt-and-grub-btrfs">Step 7: Install Timeshift, timeshift-autosnap-apt and grub-btrfs</a></li>
  </ul>
</nav>
</details>
</p>
<h2 id="overview">Overview</h2>
<p>Since a couple of months, I am exclusively using btrfs as my filesystem on all my systems, see: <a href="../btrfs/">Why I (still) like btrfs</a>. So, in this guide I will show how to install Ubuntu 20.04 with the following structure:</p>
<ul>
<li>a btrfs-inside-luks partition for the root filesystem (including <code>/boot</code>) containing a subvolume <code>@</code> for <code>/</code> and a subvolume <code>@home</code> for <code>/home</code> with only one passphrase prompt from GRUB</li>
<li>either an encrypted swap partition or a swapfile (I will show both)</li>
<li>an unencrypted EFI partition for the GRUB bootloader</li>
<li>automatic system snapshots and easy rollback similar to <em>zsys</em> using:
<ul>
<li><a href="https://github.com/teejee2008/timeshift" target="_blank" rel="noopener">Timeshift</a> which will regularly take (almost instant) snapshots of the system</li>
<li><a href="https://github.com/wmutschl/timeshift-autosnap-apt" target="_blank" rel="noopener">timeshift-autosnap-apt</a> which will automatically run Timeshift on any apt operation and also keep a backup of your EFI partition inside the snapshot</li>
<li><a href="https://github.com/Antynea/grub-btrfs" target="_blank" rel="noopener">grub-btrfs</a> which will automatically create GRUB entries for all your btrfs snapshots</li>
</ul>
</li>
<li>If you need RAID1, follow this guide: <a href="../ubuntu-btrfs-raid1-20-04">Ubuntu 20.04 btrfs-luks-raid1</a></li>
</ul>
<p>With this setup you basically get the same comfort of Ubuntu&rsquo;s 20.04&rsquo;s ZFS and <em>zsys</em> initiative, but with much more flexibility and comfort due to the awesome <a href="https://github.com/teejee2008/timeshift" target="_blank" rel="noopener">Timeshift</a> program, which saved my bacon quite a few times. This setup works similarly well on other distributions, for which I also have <a href="../../install-guides">installation guides with optional RAID1</a>.</p>
<p><strong>If you ever need to rollback your system, checkout <a href="../../timeshift/">Recovery and system rollback with Timeshift</a>.</strong></p>
<h2 id="step-0-general-remarks">Step 0: General remarks</h2>
<p><strong>I strongly advise to try the following installation steps in a virtual machine first before doing anything like that on real hardware!</strong></p>
<p>So, let&rsquo;s spin up a virtual machine with 4 cores, 8 GB RAM, and a 64GB disk using e.g. my fork of the awesome bash script <a href="https://github.com/wmutschl/quickemu" target="_blank" rel="noopener">quickemu</a>. I can confirm that the installation works equally well on my Dell XPS 13 9360, my Dell Precision 7520 and on my KVM server.</p>
<p>This tutorial is made with <a href="http://releases.ubuntu.com/focal/" target="_blank" rel="noopener">Ubuntu 20.04 Focal Fossa</a> copied to an installation media (usually a USB Flash device but may be a DVD or the ISO file attached to a virtual machine hypervisor). Other versions of Ubuntu or distributions that use the Ubiquity installer (like Linux Mint) also work, see my other <a href="../../install-guides">installation guides</a>.</p>
<h2 id="step-1-boot-the-install-check-uefi-mode-and-open-an-interactive-root-shell">Step 1: Boot the install, check UEFI mode and open an interactive root shell</h2>
<p>Since most modern PCs have UEFI, I will cover only the UEFI installation (see the <a href="../../references/#btrfs-installation-guides">References</a> on how to deal with Legacy installs). So, boot the installation medium in UEFI mode, choose your language and click <code>Try Ubuntu</code>. Once the Live Desktop environment has started we need to use a Terminal shell command-line to issue a series of commands to prepare the target device before executing the installer itself. As I have a German Keyboard, I first go to <code>Settings -- Region &amp; Language</code> and set my keyboard layout.</p>
<p>Then, open a terminal (<kbd>CTRL</kbd>+<kbd>ALT</kbd>+<kbd>T</kbd>) and run the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mount <span class="p">|</span> grep efivars
</span></span><span class="line"><span class="cl"><span class="c1"># efivarfs on /sys/firmware/efi/efivars type efivarfs (rw,nosuid,nodev,noexec,relatime)</span>
</span></span></code></pre></div><p>to detect whether we are in UEFI mode. Now switch to an interactive root session:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo -i
</span></span></code></pre></div><p>You might find maximizing the terminal window is helpful for working with the command-line. Do not close this terminal window during the whole installation process until we are finished with everything.</p>
<h2 id="step-2-prepare-partitions-manually">Step 2: Prepare partitions manually</h2>
<h3 id="create-partition-table-and-layout">Create partition table and layout</h3>
<p>First find out the name of your drive. For me the installation target device is called <code>vda</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">lsblk
</span></span><span class="line"><span class="cl"><span class="c1"># NAME  MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT</span>
</span></span><span class="line"><span class="cl"><span class="c1"># loop0   7:0    0   1.9G  1 loop /rofs</span>
</span></span><span class="line"><span class="cl"><span class="c1"># loop1   7:1    0  27.1M  1 loop /snap/snapd/7264</span>
</span></span><span class="line"><span class="cl"><span class="c1"># loop2   7:2    0    55M  1 loop /snap/core18/1705</span>
</span></span><span class="line"><span class="cl"><span class="c1"># loop3   7:3    0 240.8M  1 loop /snap/gnome-3-34-1804/24</span>
</span></span><span class="line"><span class="cl"><span class="c1"># loop4   7:4    0  62.1M  1 loop /snap/gtk-common-themes/1506</span>
</span></span><span class="line"><span class="cl"><span class="c1"># loop5   7:5    0  49.8M  1 loop /snap/snap-store/433</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sr0    11:0    1   2.5G  0 rom  /cdrom</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sr1    11:1    1  1024M  0 rom  </span>
</span></span><span class="line"><span class="cl"><span class="c1"># sr2    11:2    1  1024M  0 rom  </span>
</span></span><span class="line"><span class="cl"><span class="c1"># vda   252:0    0    64G  0 disk </span>
</span></span></code></pre></div><p>You can also open <code>gparted</code> or have a look into the <code>/dev</code> folder to make sure what your hard drive is called. In most cases they are called <code>sda</code> for normal SSD and HDD, whereas for NVME storage the naming is <code>nvme0</code>. Also note that there are no partitions or data on my hard drive, you might want to double check which partition layout fits your use case, particularly if you dual-boot with other systems.</p>
<p>We&rsquo;ll now create the following partition layout on <code>vda</code>:</p>
<ol>
<li>a 512 MiB FAT32 EFI partition for the GRUB bootloader</li>
<li>a 4 GiB partition for encrypted swap use</li>
<li>a luks1 encrypted partition which will be our root btrfs filesystem</li>
</ol>
<p>Some remarks:</p>
<ul>
<li><code>/boot</code> will reside on the encrypted luks1 partition. The GRUB bootloader is able to decrypt luks1 at boot time. Alternatively, you could create an encrypted luks1 partition for <code>/boot</code> and a luks2 encrypted partition for the root filesystem.</li>
<li>With btrfs I do not need any other partitions for e.g. <code>/home</code>, as we will use subvolumes instead.</li>
<li>If you don&rsquo;t want a swap partition, I will also show how to create a swapfile inside its own subvolume <code>@swap</code> below. Note, however, that if you plan to use RAID1 with btrfs, swapfiles are not supported, and you should stick to an encrypted swap partition.</li>
</ul>
<p>Let&rsquo;s use <code>parted</code> for this (feel free to use <code>gparted</code> accordingly):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">parted /dev/vda
</span></span><span class="line"><span class="cl">  mklabel gpt
</span></span><span class="line"><span class="cl">  mkpart primary 1MiB 513MiB
</span></span><span class="line"><span class="cl">  mkpart primary 513MiB 4609MiB
</span></span><span class="line"><span class="cl">  mkpart primary 4609MiB 100%
</span></span><span class="line"><span class="cl">  print
</span></span><span class="line"><span class="cl">  <span class="c1"># Model: Virtio Block Device (virtblk)</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Disk /dev/vda: 68.7GB</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Sector size (logical/physical): 512B/512B</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Partition Table: gpt</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Disk Flags: </span>
</span></span><span class="line"><span class="cl">  <span class="c1"># </span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Number  Start   End     Size    File system  Name     Flags</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#  1      1049kB  538MB   537MB                primary</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#  2      538MB   4833MB  4295MB               primary</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#  3      4833MB  68.7GB  63.9GB               primary</span>
</span></span><span class="line"><span class="cl">  quit
</span></span></code></pre></div><p>Do not set names or flags, as in my experience the Ubiquity installer has some problems with that.</p>
<h3 id="create-luks1-partition">Create luks1 partition</h3>
<p>The default luks (Linux Unified Key Setup) format used by the cryptsetup tool has changed since the release of Ubuntu 18.04 Bionic. 18.04 used version 1 (&ldquo;luks1&rdquo;) but more recent Ubuntu releases default to version 2 (&ldquo;luks2&rdquo;) and check that <code>/boot</code> is not located inside an encrypted partition. GRUB is able to decrypt luks version 1 at boot time, but Ubiquity does not allow this by default. Note that if you want to use luks version 2 you should create an encrypted <code>/boot</code> partition using version 1, whereas the root filesystem can then be formatted using version 2. Either way, we need to prepare the luks1 partition or else GRUB will not be able to unlock the encrypted device. Note that most Linux distributions also default to version 1 if you do a full disk encryption (e.g. Manjaro Architect).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cryptsetup luksFormat --type<span class="o">=</span>luks1 /dev/vda3
</span></span><span class="line"><span class="cl"><span class="c1"># WARNING!</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ========</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This will overwrite data on /dev/vda3 irrevocably.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Are you sure? (Type uppercase yes): YES</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Enter passphrase for /dev/vda3: </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Verify passphrase:</span>
</span></span></code></pre></div><p>Use a very good password here. Now map the encrypted partition to a device called <code>cryptdata</code>, which will be our root filesystem:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cryptsetup luksOpen /dev/vda3 cryptdata
</span></span><span class="line"><span class="cl"><span class="c1"># Enter passphrase for /dev/vda3:</span>
</span></span><span class="line"><span class="cl">ls /dev/mapper/
</span></span><span class="line"><span class="cl"><span class="c1"># control  cryptdata</span>
</span></span></code></pre></div><h3 id="create-filesystems-for-root-and-efi-system-partitions">Create filesystems for root and EFI System partitions</h3>
<p>Create a filesystem for the EFI System partition. If there was e.g. an NTFS filesystem at the beginning of the drive, the Ubiquity installer will be unable to mount the filesystem otherwise.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkfs.fat -F32 /dev/vda1
</span></span></code></pre></div><p>We need to pre-format <code>cryptdata</code> because, in my experience, the Ubiquity installer messes something up and complains about devices with the same name being mounted twice.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkfs.btrfs /dev/mapper/cryptdata
</span></span><span class="line"><span class="cl"><span class="c1"># btrfs-progs v5.4.1 </span>
</span></span><span class="line"><span class="cl"><span class="c1"># See http://btrfs.wiki.kernel.org for more information.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Label:              (null)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID:               4025b177-70ac-462b-9895-bdde1d6b3d0c</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Node size:          16384</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sector size:        4096</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Filesystem size:    59.50GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Block group profiles:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   Data:             single            8.00MiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   Metadata:         DUP               1.00GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   System:           DUP               8.00MiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># SSD detected:       no</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Incompat features:  extref, skinny-metadata</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Checksum:           crc32c</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Number of devices:  1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Devices:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    ID        SIZE  PATH</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     1    59.50GiB  /dev/mapper/cryptdata</span>
</span></span></code></pre></div><p><code>cryptdata</code> is our root partition which we&rsquo;ll use for the root filesystem.
Note that the SSD is not detected for me here, because I am running this in a Virtual Machine, but I will still pretend that I am on a SSD.</p>
<h2 id="step-3-optional-optimize-mount-options-for-ssd-or-nvme-drives">Step 3 (optional): Optimize mount options for SSD or NVME drives</h2>
<p>Unfortunately, the Ubiquity installer does not set good mount options for btrfs on SSD or NVME drives, so you should change this for optimized performance and durability. I have found that there is some general agreement to use the following mount options:</p>
<ul>
<li><code>ssd</code>: use SSD specific options for optimal use on SSD and NVME</li>
<li><code>noatime</code>: prevent frequent disk writes by instructing the Linux kernel not to store the last access time of files and folders</li>
<li><code>space_cache</code>: allows btrfs to store free space cache on the disk to make caching of a block group much quicker</li>
<li><code>commit=120</code>: time interval in which data is written to the filesystem (value of 120 is taken from Manjaro)</li>
<li><code>compress=zstd</code>: allows to specify the compression algorithm which we want to use. btrfs provides lzo, zstd and zlib compression algorithms. Based on some Phoronix test cases, zstd seems to be the better performing candidate.</li>
<li>Lastly the pass flag for fschk in the <code>fstab</code> is useless for btrfs and should be set to 0.</li>
</ul>
<p>We need to change two configuration files:</p>
<ul>
<li><code>/usr/lib/partman/mount.d/70btrfs</code></li>
<li><code>/usr/lib/partman/fstab.d/btrfs</code></li>
</ul>
<p>So let&rsquo;s use an editor to change the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nano /usr/lib/partman/mount.d/70btrfs
</span></span><span class="line"><span class="cl"><span class="c1"># line 24: options=&#34;${options:+$options,}subvol=@,ssd,noatime,space_cache,commit=120,compress=zstd&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># line 31: options=&#34;${options:+$options,}subvol=@home,ssd,noatime,space_cache,commit=120,compress=zstd&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">nano /usr/lib/partman/fstab.d/btrfs
</span></span><span class="line"><span class="cl"><span class="c1"># line 30: pass=0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># line 31: home_options=&#34;${options:+$options,}subvol=@home,ssd,noatime,space_cache,commit=120,compress=zstd&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># line 32: options=&#34;${options:+$options,}subvol=@,ssd,noatime,space_cache,commit=120,compress=zstd&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># line 36: pass=0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># line 37: options=&#34;${options:+$options,}subvol=@home,ssd,noatime,space_cache,commit=120,compress=zstd&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># line 40: pass=0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># line 56: echo &#34;$home_path&#34; &#34;$home_mp&#34; btrfs &#34;$home_options&#34; 0 0</span>
</span></span></code></pre></div><h2 id="step-4-install-ubuntu-using-the-ubiquity-installer-without-the-bootloader">Step 4: Install Ubuntu using the Ubiquity installer without the bootloader</h2>
<p>Now let&rsquo;s run the installation process, but without installing the bootloader, as we want to put <code>/boot</code> on an encrypted partition which is actually not allowed by Ubiquity. So we need to run the installer with:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ubiquity --no-bootloader
</span></span></code></pre></div><p>Choose the installation language, keyboard layout, Normal or Minimal installation, check the boxes of the Other options according to your needs. In the &ldquo;Installation type&rdquo; options choose &ldquo;Something Else&rdquo; and the manual partitioner will start:</p>
<ul>
<li>Select /dev/vda1, press the <code>Change</code> button. Choose <code>Use as</code> &lsquo;EFI System Partition&rsquo;.</li>
<li>Select /dev/vda2, press the <code>Change</code> button. Choose <code>Use as</code> &lsquo;swap area&rsquo; to create a swap partition. We will encrypt this partition later in the <code>crypttab</code>.</li>
<li>Select the root filesystem device for formatting (/dev/mapper/cryptdata type btrfs on top), press the <code>Change</code> button. Choose <code>Use as</code> &lsquo;btrfs journaling filesystem&rsquo;, check <code>Format the partition</code> and use &lsquo;/&rsquo; as <code>Mount point</code>.</li>
<li>If you have other partitions, check their types and use; particularly,deactivate other EFI partitions.</li>
</ul>
<p>Note that if you don&rsquo;t declare a swap partition, the installer will create a swapfile, but for btrfs this needs to be in its own subvolume (otherwise we cannot take snapshots of <code>@</code>). I will show how to change this after the installation process finishes.</p>
<p>Recheck everything, press the <code>Install Now</code> button to write the changes to the disk and hit the <code>Continue button</code>. Select the time zone and fill out your user name and password. If your installation is successful choose the <code>Continue Testing</code> option. <strong>DO NOT REBOOT!</strong>, but return to your terminal.</p>
<h2 id="step-5-post-installation-steps">Step 5: Post-Installation steps</h2>
<h3 id="create-a-chroot-environment-and-enter-your-system">Create a chroot environment and enter your system</h3>
<p>Return to the terminal and create a chroot (change-root) environment to work directly inside your newly installed operating system:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mount -o <span class="nv">subvol</span><span class="o">=</span>@,ssd,noatime,space_cache,commit<span class="o">=</span>120,compress<span class="o">=</span>zstd /dev/mapper/cryptdata /mnt
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in /dev /dev/pts /proc /sys /run<span class="p">;</span> <span class="k">do</span> sudo mount -B <span class="nv">$i</span> /mnt<span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>
</span></span><span class="line"><span class="cl">sudo cp /etc/resolv.conf /mnt/etc/
</span></span><span class="line"><span class="cl">sudo chroot /mnt
</span></span></code></pre></div><p>Now you are actually inside your system, so let&rsquo;s mount all other partitions and have a look at the btrfs subvolumes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mount -av
</span></span><span class="line"><span class="cl"><span class="c1"># /                        : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /boot/efi                : successfully mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /home                    : successfully mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># none                     : ignored</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">btrfs subvolume list /
</span></span><span class="line"><span class="cl"><span class="c1"># ID 256 gen 164 top level 5 path @</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ID 258 gen 30 top level 5 path @home</span>
</span></span></code></pre></div><p>Looks great. Note that the subvolume <code>@</code> is mounted to <code>/</code>, whereas the subvolume <code>@home</code> is mounted to <code>/home</code>.</p>
<h3 id="create-crypttab">Create crypttab</h3>
<p>We need to create the <code>crypttab</code> manually:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">UUIDVDA3</span><span class="o">=</span><span class="k">$(</span>blkid -s UUID -o value /dev/vda3<span class="k">)</span> <span class="c1">#this is an environmental variable</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;cryptdata UUID=</span><span class="si">${</span><span class="nv">UUIDVDA3</span><span class="si">}</span><span class="s2"> none luks&#34;</span> &gt;&gt; /etc/crypttab
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat /etc/crypttab
</span></span><span class="line"><span class="cl"><span class="c1"># cryptdata UUID=8e893c0f-4060-49e3-9d96-db6dce7466dc none luks</span>
</span></span></code></pre></div><p>Note that the UUID is from the luks partition /dev/vda3, not from the device mapper <code>/dev/mapper/cryptdata</code>! You can get all UUID using <code>blkid</code>.</p>
<h3 id="encrypted-swap">Encrypted swap</h3>
<p>There are many ways to encrypt the swap partition, a good reference is <a href="https://wiki.archlinux.org/index.php/Dm-crypt/Swap_encryption" target="_blank" rel="noopener">dm-crypt/Swap encryption</a>. For the sake of this guide, I will show how to set up both an encrypted swap partition as well as a swapfile which resides in its own btrfs subvolume. Choose the one you like more.</p>
<h4 id="option-a-swap-partition">Option A: Swap partition</h4>
<p>As I have no use for hibernation or suspend-to-disk, I will simply use a random password to decrypt the swap partition using the <code>crypttab</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">SWAPUUID</span><span class="o">=</span><span class="k">$(</span>blkid -s UUID -o value /dev/vda2<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;cryptswap UUID=</span><span class="si">${</span><span class="nv">SWAPUUID</span><span class="si">}</span><span class="s2"> /dev/urandom swap,offset=1024,cipher=aes-xts-plain64,size=512&#34;</span> &gt;&gt; /etc/crypttab
</span></span><span class="line"><span class="cl">cat /etc/crypttab
</span></span><span class="line"><span class="cl"><span class="c1"># cryptdata UUID=8e893c0f-4060-49e3-9d96-db6dce7466dc none luks</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cryptswap UUID=9cae34c0-3755-43b1-ac05-2173924fd433 /dev/urandom swap,offset=1024,cipher=aes-xts-plain64,size=512</span>
</span></span></code></pre></div><p>We also need to adapt the fstab accordingly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sed -i <span class="s2">&#34;s|UUID=</span><span class="si">${</span><span class="nv">SWAPUUID</span><span class="si">}</span><span class="s2">|/dev/mapper/cryptswap|&#34;</span> /etc/fstab
</span></span><span class="line"><span class="cl">cat /etc/fstab
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptdata /               btrfs   defaults,subvol=@,ssd,noatime,space_cache,commit=120,compress=zstd 0       0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=01DE-F282  /boot/efi       vfat    umask=0077      0       1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptdata /home           btrfs   defaults,subvol=@home,ssd,noatime,space_cache,commit=120,compress=zstd 0       0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptswap none            swap    sw              0       0</span>
</span></span></code></pre></div><p>The sed command simply replaced the UUID of your swap partition with the encrypted device called <code>/dev/mapper/cryptswap</code>. There you go, you have an encrypted swap partition. Alternatively, or additionally, you can set up a swapfile, or skip to the next step.</p>
<h4 id="option-b-swapfile">Option B: Swapfile</h4>
<p>Swapfiles used to be a tricky business on btrfs, as it messed up snapshots and compression, but recent kernels are able to handle swapfile correctly if one puts them in a dedicated subvolume, in our case this will be called <code>@swap</code>. (Note, though, that if you plan to set up a RAID1 using btrfs you have to deactivate the swapfile again as this is still not supported in a RAID1 managed by btrfs.)</p>
<p>If you did not create a swap partition above, Ubiquity created a swapfile for you. Let&rsquo;s remove this file and also any reference to it in the <code>fstab</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">swapoff /swapfile
</span></span><span class="line"><span class="cl">rm /swapfile
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;\|^/swapfile|d&#39;</span> /etc/fstab <span class="c1">#this removes any lines starting with /swapfile</span>
</span></span></code></pre></div><p>Next we mount the top-level root btrfs filesystem, which always has id 5, to <code>/btrfs_pool</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir /btrfs_pool
</span></span><span class="line"><span class="cl">mount -o <span class="nv">subvolid</span><span class="o">=</span><span class="m">5</span> /dev/mapper/cryptdata /btrfs_pool
</span></span><span class="line"><span class="cl">ls /btrfs_pool
</span></span><span class="line"><span class="cl"><span class="c1"># @  @home</span>
</span></span></code></pre></div><p>Note that we now look from the outside on our system, i.e. in <code>@</code> we have the same files as in <code>/</code>, in <code>@home</code> the same files as in <code>/home</code>. Let&rsquo;s create another subvolume called <code>@swap</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">btrfs subvolume create /btrfs_pool/@swap
</span></span><span class="line"><span class="cl">ls /btrfs_pool
</span></span><span class="line"><span class="cl"><span class="c1"># @  @home  @swap</span>
</span></span></code></pre></div><p>and create a 4GB swapfile inside this subvolume (change the size according to your needs) and set the necessary properties for btrfs:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">truncate -s <span class="m">0</span> /btrfs_pool/@swap/swapfile
</span></span><span class="line"><span class="cl">chattr +C /btrfs_pool/@swap/swapfile
</span></span><span class="line"><span class="cl">btrfs property <span class="nb">set</span> /btrfs_pool/@swap/swapfile compression none
</span></span><span class="line"><span class="cl">fallocate -l 4G /btrfs_pool/@swap/swapfile
</span></span><span class="line"><span class="cl">chmod <span class="m">600</span> /btrfs_pool/@swap/swapfile
</span></span><span class="line"><span class="cl">mkswap /btrfs_pool/@swap/swapfile
</span></span><span class="line"><span class="cl"><span class="c1"># Setting up swapspace version 1, size = 4 GiB (4294963200 bytes)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># no label, UUID=2c39e8bd-c158-4126-8389-5d56c0977db0</span>
</span></span><span class="line"><span class="cl">mkdir /btrfs_pool/@/swap
</span></span></code></pre></div><p>Note that in the last line we created the folder <code>/swap</code> to mount <code>@swap</code> to it via the <code>fstab</code>. So, let&rsquo;s make the necessary change with a text editor, e.g.:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nano /etc/fstab
</span></span></code></pre></div><p>or these <code>sed</code> commands</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;UUID=</span><span class="k">$(</span>blkid -s UUID -o value /dev/mapper/cryptdata<span class="k">)</span><span class="s2">   /swap   btrfs   subvol=@swap,compress=no   0 0&#34;</span> &gt;&gt; /etc/fstab
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;/swap/swapfile none swap defaults 0 0&#34;</span> &gt;&gt; /etc/fstab
</span></span></code></pre></div><p>Either way your <code>fstab</code> should look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat /etc/fstab
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptdata /               btrfs   defaults,subvol=@,ssd,noatime,space_cache,commit=120,compress=zstd 0       0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=01DE-F282  /boot/efi       vfat    umask=0077      0       1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptdata /home           btrfs   defaults,subvol=@home,ssd,noatime,space_cache,commit=120,compress=zstd 0       0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=aa90f2d3-10d9-420b-86e2-92ffce0ece9d   /swap   btrfs   subvol=@swap,compress=no   0 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /swap/swapfile none swap defaults 0 0</span>
</span></span></code></pre></div><p>We are done with swap and can unmount the top-level root filesystem:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">umount /btrfs_pool
</span></span></code></pre></div><h3 id="add-a-key-file-to-type-luks-passphrase-only-once-optional-but-recommended">Add a key-file to type luks passphrase only once (optional, but recommended)</h3>
<p>The device holding the kernel (and the initramfs image) is unlocked by GRUB, but the root device needs to be unlocked again at initramfs stage, regardless whether itâs the same device or not, so you&rsquo;ll get a second prompt for your passphrase. This is because GRUB boots with the given vmlinuz and initramfs images; in other words, all devices are locked, and the root device needs to be unlocked again. To avoid extra passphrase prompts at initramfs stage, a workaround is to unlock via key files stored into the initramfs image. This can also be used to unlock any additional luks partitions you want on your disk. Since the initramfs image now resides on an encrypted device, this still provides protection for data at rest. After all for luks the volume key can already be found by user space in the Device Mapper table, so one could argue that including key files to the initramfs image â created with restrictive permissions â doesnât change the threat model for luks devices. Note that this is exactly what e.g. the Manjaro architect installer does as well.</p>
<p>Long story short, let&rsquo;s create a key-file, secure it, and add it to our luks volume:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir /etc/luks
</span></span><span class="line"><span class="cl">dd <span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">of</span><span class="o">=</span>/etc/luks/boot_os.keyfile <span class="nv">bs</span><span class="o">=</span><span class="m">4096</span> <span class="nv">count</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1+0 records in</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1+0 records out</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 4096 bytes (4.1 kB, 4.0 KiB) copied, 0.000928939 s, 4.4 MB/s</span>
</span></span><span class="line"><span class="cl">chmod <span class="nv">u</span><span class="o">=</span>rx,go-rwx /etc/luks
</span></span><span class="line"><span class="cl">chmod <span class="nv">u</span><span class="o">=</span>r,go-rwx /etc/luks/boot_os.keyfile
</span></span><span class="line"><span class="cl">cryptsetup luksAddKey /dev/vda3 /etc/luks/boot_os.keyfile
</span></span><span class="line"><span class="cl"><span class="c1"># Enter any existing passphrase: </span>
</span></span><span class="line"><span class="cl">cryptsetup luksDump /dev/vda3 <span class="p">|</span> grep <span class="s2">&#34;Key Slot&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Key Slot 0: ENABLED</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Key Slot 1: ENABLED</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Key Slot 2: DISABLED</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Key Slot 3: DISABLED</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Key Slot 4: DISABLED</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Key Slot 5: DISABLED</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Key Slot 6: DISABLED</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Key Slot 7: DISABLED</span>
</span></span></code></pre></div><p>Note that &ldquo;Key Slot 0&rdquo; contains our passphrase, whereas &ldquo;Key Slot 1&rdquo; contains the key-file. Let&rsquo;s restrict the pattern of keyfiles and avoid leaking key material for the initramfs hook:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;KEYFILE_PATTERN=/etc/luks/*.keyfile&#34;</span> &gt;&gt; /etc/cryptsetup-initramfs/conf-hook
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;UMASK=0077&#34;</span> &gt;&gt; /etc/initramfs-tools/initramfs.conf
</span></span></code></pre></div><p>These commands will harden the security options in the intiramfs configuration file and hook.</p>
<p>Next, add the keyfile to your <code>crypttab</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sed -i <span class="s2">&#34;s|none|/etc/luks/boot_os.keyfile|&#34;</span> /etc/crypttab <span class="c1"># this replaces none with /etc/luks/boot_os.keyfile</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat /etc/crypttab
</span></span><span class="line"><span class="cl"><span class="c1"># cryptdata UUID=8e893c0f-4060-49e3-9d96-db6dce7466dc /etc/luks/boot_os.keyfile luks</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cryptswap UUID=9cae34c0-3755-43b1-ac05-2173924fd433 /dev/urandom swap,offset=1024,cipher=aes-xts-plain64,size=512</span>
</span></span></code></pre></div><h3 id="install-the-efi-bootloader">Install the EFI bootloader</h3>
<p>Now it is time to finalize the setup and install the GRUB bootloader. First we need to make it capable to unlock luks1-type partitions by setting <code>GRUB_ENABLE_CRYPTODISK=y</code> in <code>/etc/default/grub</code>, then install the bootloader to the device <code>/dev/vda</code> and lastly update GRUB. Just in case, I also reinstall the generic kernel (&ldquo;linux-generic&rdquo; and &ldquo;linux-headers-generic&rdquo;) and also install the Hardware Enablement kernel (&ldquo;linux-generic-hwe-20.04&rdquo; &ldquo;linux-headers-generic-hwe-20.04&rdquo;):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;GRUB_ENABLE_CRYPTODISK=y&#34;</span> &gt;&gt; /etc/default/grub
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apt install -y --reinstall grub-efi-amd64-signed linux-generic linux-headers-generic linux-generic-hwe-20.04 linux-headers-generic-hwe-20.04
</span></span><span class="line"><span class="cl"><span class="c1"># --- SOME APT INSTALLATION OUTPUT ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">update-initramfs -c -k all
</span></span><span class="line"><span class="cl"><span class="c1"># update-initramfs: Generating /boot/initrd.img-5.4.0-26-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># update-initramfs: Generating /boot/initrd.img-5.4.0-29-generic</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">grub-install /dev/vda
</span></span><span class="line"><span class="cl"><span class="c1"># Installing for x86_64-efi platform.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Installation finished. No error reported.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">update-grub
</span></span><span class="line"><span class="cl"><span class="c1"># Sourcing file `/etc/default/grub&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sourcing file `/etc/default/grub.d/init-select.cfg&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Generating grub configuration file ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Found linux image: /boot/vmlinuz-5.4.0-29-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Found initrd image: /boot/initrd.img-5.4.0-29-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Found linux image: /boot/vmlinuz-5.4.0-26-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Found initrd image: /boot/initrd.img-5.4.0-26-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Adding boot menu entry for UEFI Firmware Settings</span>
</span></span><span class="line"><span class="cl"><span class="c1"># done</span>
</span></span></code></pre></div><p>Lastly, double-check that the initramfs image has restrictive permissions and includes the keyfile:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">stat -L -c <span class="s2">&#34;%A  %n&#34;</span> /boot/initrd.img
</span></span><span class="line"><span class="cl"><span class="c1"># -rw-------  /boot/initrd.img</span>
</span></span><span class="line"><span class="cl">lsinitramfs /boot/initrd.img <span class="p">|</span> grep <span class="s2">&#34;^cryptroot/keyfiles/&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cryptroot/keyfiles/cryptdata.key</span>
</span></span></code></pre></div><p>Note that cryptsetup-initramfs may rename key files inside the initramfs.</p>
<h2 id="step-6-reboot-some-checks-and-update-system">Step 6: Reboot, some checks, and update system</h2>
<p>Now, it is time to exit the chroot - cross your fingers - and reboot the system:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">exit</span>
</span></span><span class="line"><span class="cl"><span class="c1"># exit</span>
</span></span><span class="line"><span class="cl">reboot now
</span></span></code></pre></div><p>If all went well you should see a single passphrase prompt (YAY!) from GRUB:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Enter the passphrase for hd0,gpt3 (some very long number):
</span></span></code></pre></div><p>where you enter the luks passphrase to unlock GRUB, which then either asks you again for your passphrase or uses the key-file to unlock <code>/dev/vda3</code> and map it to <code>/dev/mapper/cryptdata</code>. If you added a key-file you need to type your password only once. Note that if you mistyped the password for GRUB, you must restart the computer and retry.</p>
<p>Now let&rsquo;s click through the welcome screen and open up a terminal to see whether everything is set up correctly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cat /etc/crypttab
</span></span><span class="line"><span class="cl"><span class="c1"># cryptdata UUID=8e893c0f-4060-49e3-9d96-db6dce7466dc /etc/luks/boot_os.keyfile luks</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cryptswap UUID=9cae34c0-3755-43b1-ac05-2173924fd433 /dev/urandom swap,offset=1024,cipher=aes-xts-plain64,size=512</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo cat /etc/fstab
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptdata /               btrfs   defaults,subvol=@,ssd,noatime,space_cache,commit=120,compress=zstd 0       0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=01DE-F282  /boot/efi       vfat    umask=0077      0       1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptdata /home           btrfs   defaults,subvol=@home,ssd,noatime,space_cache,commit=120,compress=zstd 0       0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptswap none            swap    sw              0       0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=aa90f2d3-10d9-420b-86e2-92ffce0ece9d   /swap   btrfs   subvol=@swap,compress=no   0 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /swap/swapfile none swap defaults 0 0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo mount -av
</span></span><span class="line"><span class="cl"><span class="c1"># /                        : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /boot/efi                : already mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /home                    : already mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># none                     : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /swap                    : already mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># none                     : ignored</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo mount -v <span class="p">|</span> grep /dev/mapper
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptdata on / type btrfs (rw,noatime,compress=zstd:3,ssd,space_cache,commit=120,subvolid=256,subvol=/@)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptdata on /swap type btrfs (rw,relatime,compress=zstd:3,ssd,space_cache,commit=120,subvolid=262,subvol=/@swap)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptdata on /home type btrfs (rw,noatime,compress=zstd:3,ssd,space_cache,commit=120,subvolid=258,subvol=/@home)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo swapon
</span></span><span class="line"><span class="cl"><span class="c1"># NAME           TYPE      SIZE USED PRIO</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /swap/swapfile file        4G   0B   -2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/dm-1      partition   4G   0B   -3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo btrfs filesystem show /
</span></span><span class="line"><span class="cl"><span class="c1"># Label: none  uuid: aa90f2d3-10d9-420b-86e2-92ffce0ece9d</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Total devices 1 FS bytes used 6.61GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	devid    1 size 59.50GiB used 9.02GiB path /dev/mapper/cryptdata</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo btrfs subvolume list /
</span></span><span class="line"><span class="cl"><span class="c1"># ID 256 gen 195 top level 5 path @</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ID 258 gen 192 top level 5 path @home</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ID 262 gen 180 top level 5 path @swap</span>
</span></span></code></pre></div><p>Look&rsquo;s good. Note that in this tutorial I installed both a swapfile and a swap partition. Normally you would choose one or the other.</p>
<p>Let&rsquo;s update the system and reboot one more time:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt upgrade
</span></span><span class="line"><span class="cl">sudo apt dist-upgrade
</span></span><span class="line"><span class="cl">sudo apt autoremove
</span></span><span class="line"><span class="cl">sudo apt autoclean
</span></span></code></pre></div><p>Optionally, if you installed on a SSD and NVME, enable <code>fstrim.timer</code> as we did not add <code>discard</code> to the <code>crypttab</code>. This is due to the fact that <a href="https://www.phoronix.com/scan.php?page=news_item&amp;px=Btrfs-Async-Discard" target="_blank" rel="noopener">Btrfs Async Discard Support Looks To Be Ready For Linux 5.6</a> is quite new, but 20.04 still runs kernel 5.4, it is better to enable the <code>fstrim.timer</code> systemd service:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> fstrim.timer
</span></span></code></pre></div><p>Now reboot:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo reboot now
</span></span></code></pre></div><h2 id="step-7-install-timeshift-timeshift-autosnap-apt-and-grub-btrfs">Step 7: Install Timeshift, timeshift-autosnap-apt and grub-btrfs</h2>
<p>Open a terminal and install some dependencies:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install -y btrfs-progs git make
</span></span></code></pre></div><p>Install Timeshift and configure it directly via the GUI:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install timeshift
</span></span><span class="line"><span class="cl">sudo timeshift-gtk
</span></span></code></pre></div><ul>
<li>Select btrfs as the âSnapshot Typeâ; continue with âNextâ</li>
<li>Choose your btrfs system partition as âSnapshot Locationâ; continue with âNextâ</li>
<li>&ldquo;Select Snapshot Levels&rdquo; (type and number of snapshots that will be automatically created and managed/deleted by Timeshift), my recommendations:
<ul>
<li>Activate &ldquo;Monthly&rdquo; and set it to 1</li>
<li>Activate &ldquo;Weekly&rdquo; and set it to 3</li>
<li>Activate &ldquo;Daily&rdquo; and set it to 5</li>
<li>Deactivate &ldquo;Hourly&rdquo;</li>
<li>Activate &ldquo;Boot&rdquo; and set it to 3</li>
<li>Activate &ldquo;Stop cron emails for scheduled tasks&rdquo;</li>
<li>continue with &ldquo;Next&rdquo;</li>
<li>I also include the <code>@home</code> subvolume (which is not selected by default). Note that when you restore a snapshot Timeshift you get the choise whether you want to restore it as well (which in most cases you don&rsquo;t want to).</li>
<li>Click &ldquo;Finish&rdquo;</li>
</ul>
</li>
<li>&ldquo;Create&rdquo; a manual first snapshot &amp; exit Timeshift</li>
</ul>
<p><em>Timeshift</em> will now check every hour if snapshots (&ldquo;hourly&rdquo;, &ldquo;daily&rdquo;, &ldquo;weekly&rdquo;, &ldquo;monthly&rdquo;, &ldquo;boot&rdquo;) need to be created or deleted. Note that &ldquo;boot&rdquo; snapshots will not be created directly but about 10 minutes after a system startup.</p>
<p><em>Timeshift</em> puts all snapshots into <code>/run/timeshift/backup</code>. Conveniently, the real root (subvolid 5) of your btrfs partition is also mounted here, so it is easy to view, create, delete and move around snapshots manually.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ls /run/timeshift/backup
</span></span><span class="line"><span class="cl"><span class="c1"># @  @home  @swap  timeshift-btrfs</span>
</span></span></code></pre></div><p>Note that <code>/run/timeshift/backup/@</code> contains your <code>/</code> folder, <code>/run/timeshift/backup/@home</code> contains your <code>/home</code> folder, <code>/run/timeshift/backup/@swap</code> contains your <code>/swap</code> folder.</p>
<p>Now let&rsquo;s install <em>timeshift-autosnap-apt</em> and <em>grub-btrfs</em> from GitHub</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/wmutschl/timeshift-autosnap-apt.git /home/<span class="nv">$USER</span>/timeshift-autosnap-apt
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /home/<span class="nv">$USER</span>/timeshift-autosnap-apt
</span></span><span class="line"><span class="cl">sudo make install
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">git clone https://github.com/Antynea/grub-btrfs.git /home/<span class="nv">$USER</span>/grub-btrfs
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /home/<span class="nv">$USER</span>/grub-btrfs
</span></span><span class="line"><span class="cl">sudo make install
</span></span></code></pre></div><p>After this, optionally, make changes to the configuration files:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo nano /etc/timeshift-autosnap-apt.conf
</span></span><span class="line"><span class="cl">sudo nano /etc/default/grub-btrfs/config
</span></span></code></pre></div><p>For example, as we don&rsquo;t have a dedicated /boot partition, we can set <code>snapshotBoot=false</code> in the <code>timeshift-autosnap-apt-conf</code> file to not rsync the <code>/boot</code> directory to <code>/boot.backup</code>. Note that the EFI partition is still rsynced into your snapshot to <code>/boot.backup/efi</code>. For <em>grub-btrfs</em>, I change <code>GRUB_BTRFS_SUBMENUNAME</code> to &ldquo;MY BTRFS SNAPSHOTS&rdquo;.</p>
<p>Check if everything is working:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo timeshift-autosnap-apt
</span></span><span class="line"><span class="cl"><span class="c1"># Rsyncing /boot/efi into the filesystem before the call to timeshift.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Using system disk as snapshot device for creating snapshots in BTRFS mode</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/dm-0 is mounted at: /run/timeshift/backup, options: rw,relatime,compress=zstd:3,ssd,space_cache,commit=120,subvolid=5,subvol=/</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Creating new backup...(BTRFS)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Saving to device: /dev/dm-0, mounted at path: /run/timeshift/backup</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Created directory: /run/timeshift/backup/timeshift-btrfs/snapshots/2020-05-06_23-43-29</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Created subvolume snapshot: /run/timeshift/backup/timeshift-btrfs/snapshots/2020-05-06_23-43-29/@</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Created subvolume snapshot: /run/timeshift/backup/timeshift-btrfs/snapshots/2020-05-06_23-43-29/@home</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Created control file: /run/timeshift/backup/timeshift-btrfs/snapshots/2020-05-06_23-43-29/info.json</span>
</span></span><span class="line"><span class="cl"><span class="c1"># BTRFS Snapshot saved successfully (0s)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Tagged snapshot &#39;2020-05-06_23-43-29&#39;: ondemand</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ------------------------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sourcing file `/etc/default/grub&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sourcing file `/etc/default/grub.d/init-select.cfg&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Generating grub configuration file ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Found linux image: /boot/vmlinuz-5.4.0-29-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Found initrd image: /boot/initrd.img-5.4.0-29-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Found linux image: /boot/vmlinuz-5.4.0-26-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Found initrd image: /boot/initrd.img-5.4.0-26-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Adding boot menu entry for UEFI Firmware Settings</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ###### - Grub-btrfs: Snapshot detection started - ######</span>
</span></span><span class="line"><span class="cl"><span class="c1"># # Info: Separate boot partition not detected </span>
</span></span><span class="line"><span class="cl"><span class="c1"># # Found snapshot: 2020-05-06 23:43:29 | timeshift-btrfs/snapshots/2020-05-06_23-43-29/@</span>
</span></span><span class="line"><span class="cl"><span class="c1"># # Found snapshot: 2020-05-06 23:35:24 | timeshift-btrfs/snapshots/2020-05-06_23-35-24/@</span>
</span></span><span class="line"><span class="cl"><span class="c1"># # Found 2 snapshot(s)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ###### - Grub-btrfs: Snapshot detection ended   - ######</span>
</span></span><span class="line"><span class="cl"><span class="c1"># done</span>
</span></span></code></pre></div><p>Now, if you run <code>sudo apt install|remove|upgrade|dist-upgrade</code>, <em>timeshift-autosnap-apt</em> will create a snapshot of your system with <em>Timeshift</em> and <em>grub-btrfs</em> creates the corresponding boot menu entries (actually it creates boot menu entries for all subvolumes of your system). For example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install rolldice
</span></span><span class="line"><span class="cl"><span class="c1"># Reading package lists... Done</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Building dependency tree       </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Reading state information... Done</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The following NEW packages will be installed:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   rolldice</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 0 upgraded, 1 newly installed, 0 to remove and 37 not upgraded.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Need to get 9.628 B of archives.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># After this operation, 31,7 kB of additional disk space will be used.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Get:1 http://de.archive.ubuntu.com/ubuntu focal/universe amd64 rolldice amd64 1.16-1build1 [9.628 B]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Fetched 9.628 B in 0s (32,4 kB/s)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Rsyncing /boot/efi into the filesystem before the call to timeshift.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Using system disk as snapshot device for creating snapshots in BTRFS mode</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/dm-0 is mounted at: /run/timeshift/backup, options: rw,relatime,compress=zstd:3,ssd,space_cache,commit=120,subvolid=5,subvol=/</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Creating new backup...(BTRFS)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Saving to device: /dev/dm-0, mounted at path: /run/timeshift/backup</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Created directory: /run/timeshift/backup/timeshift-btrfs/snapshots/2020-05-06_23-45-37</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Created subvolume snapshot: /run/timeshift/backup/timeshift-btrfs/snapshots/2020-05-06_23-45-37/@</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Created subvolume snapshot: /run/timeshift/backup/timeshift-btrfs/snapshots/2020-05-06_23-45-37/@home</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Created control file: /run/timeshift/backup/timeshift-btrfs/snapshots/2020-05-06_23-45-37/info.json</span>
</span></span><span class="line"><span class="cl"><span class="c1"># BTRFS Snapshot saved successfully (0s)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Tagged snapshot &#39;2020-05-06_23-45-37&#39;: ondemand</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ------------------------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sourcing file `/etc/default/grub&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sourcing file `/etc/default/grub.d/init-select.cfg&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Generating grub configuration file ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Found linux image: /boot/vmlinuz-5.4.0-29-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Found initrd image: /boot/initrd.img-5.4.0-29-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Found linux image: /boot/vmlinuz-5.4.0-26-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Found initrd image: /boot/initrd.img-5.4.0-26-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Adding boot menu entry for UEFI Firmware Settings</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ###### - Grub-btrfs: Snapshot detection started - ######</span>
</span></span><span class="line"><span class="cl"><span class="c1"># # Info: Separate boot partition not detected </span>
</span></span><span class="line"><span class="cl"><span class="c1"># # Found snapshot: 2020-05-06 23:45:37 | timeshift-btrfs/snapshots/2020-05-06_23-45-37/@</span>
</span></span><span class="line"><span class="cl"><span class="c1"># # Found snapshot: 2020-05-06 23:43:29 | timeshift-btrfs/snapshots/2020-05-06_23-43-29/@</span>
</span></span><span class="line"><span class="cl"><span class="c1"># # Found snapshot: 2020-05-06 23:35:24 | timeshift-btrfs/snapshots/2020-05-06_23-35-24/@</span>
</span></span><span class="line"><span class="cl"><span class="c1"># # Found 3 snapshot(s)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ###### - Grub-btrfs: Snapshot detection ended   - ######</span>
</span></span><span class="line"><span class="cl"><span class="c1"># done</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Selecting previously unselected package rolldice.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (Reading database ... 158308 files and directories currently installed.)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Preparing to unpack .../rolldice_1.16-1build1_amd64.deb ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Unpacking rolldice (1.16-1build1) ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Setting up rolldice (1.16-1build1) ...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Processing triggers for man-db (2.9.1-1) ...</span>
</span></span></code></pre></div><p><strong>FINISHED! CONGRATULATIONS AND THANKS FOR STICKING THROUGH!</strong>
<strong>If you ever need to rollback your system, checkout <a href="../../timeshift/">Recovery and system rollback with Timeshift</a>.</strong></p>


          </div>

          

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/linux/">linux</a>
  
  <a class="badge badge-light" href="/tag/ubuntu/">ubuntu</a>
  
  <a class="badge badge-light" href="/tag/install-guide/">install guide</a>
  
  <a class="badge badge-light" href="/tag/btrfs/">btrfs</a>
  
  <a class="badge badge-light" href="/tag/luks/">luks</a>
  
  <a class="badge badge-light" href="/tag/timeshift/">timeshift</a>
  
  <a class="badge badge-light" href="/tag/timeshift-autosnap-apt/">timeshift-autosnap-apt</a>
  
</div>



          
          
          <div class="article-widget">
            
<div class="post-nav">
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Previous</div>
    <a href="/linux/ubuntu-btrfs-raid1-20-04/" rel="next">Ubuntu Desktop 20.04: installation guide with btrfs-luks-RAID1 full disk encryption including /boot and auto-apt snapshots with Timeshift</a>
  </div>
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Next</div>
    <a href="/linux/ubuntu-post-install/" rel="prev">Ubuntu Desktop: Things to do after installation (Apps, Settings, and Tweaks)</a>
  </div>
  
</div>

          </div>
          
        </div>

        <div class="body-footer">
          <p>Last updated on Aug 14, 2022</p>

          




          




          


        </div>

      </article>

      <footer class="site-footer">

  












  

  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
  </p>
  

  

  
  






  
  
  

  
  
  
    
  

  

  
  <p class="powered-by copyright-license-text">
    Â© 2025 Willi Mutschler. This work is licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0" rel="noopener noreferrer" target="_blank">CC BY SA 4.0</a>
  </p>
  

  <p class="powered-by footer-license-icons">
    <a href="https://creativecommons.org/licenses/by-sa/4.0" rel="noopener noreferrer" target="_blank" aria-label="Creative Commons">
      <i class="fab fa-creative-commons fa-2x" aria-hidden="true"></i>
      <i class="fab fa-creative-commons-by fa-2x" aria-hidden="true"></i>
      
      
        <i class="fab fa-creative-commons-sa fa-2x" aria-hidden="true"></i>
      
    </a>
  </p>




  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Wowchemy</a> â the free, <a href="https://github.com/wowchemy/wowchemy-hugo-themes" target="_blank" rel="noopener">open source</a> website builder that empowers creators.
    
  </p>
</footer>


    </main>
  </div>
</div>

  </div>

  <div class="page-footer">
    
    
  </div>

  


<script src="/js/vendor-bundle.min.b4708d4364577c16ab7001b265a063a4.js"></script>




  

  
  

  






  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.js" integrity="" crossorigin="anonymous"></script>




<script src="https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>





  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>











  
  


<script src="/en/js/wowchemy.min.42010733157c11a71adebfe9bae43355.js"></script>



  <script src="/js/wowchemy-map.a26e9d2f7238ba5b868384f1c5bc6477.js" type="module"></script>




















</body>
</html>
