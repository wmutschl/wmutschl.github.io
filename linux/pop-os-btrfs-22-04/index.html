<!DOCTYPE html><html lang="en-us" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.6.0 for Hugo" />
  

  
  












  
  










  







  
  

  
  
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Willi Mutschler" />

  
  
  
    
  
  <meta name="description" content="In this guide I will walk you through the installation procedure to get a Pop!_OS 22.04 system with a luks-encrypted partition which contains a LVM with a logical volume for the root filesystem that is formatted with btrfs and contains a subvolume @ for / and a subvolume @home for /home. I will show how to optimize the btrfs mount options and how to setup an encrypted swap partition which works with hibernation. This layout enables one to use timeshift which will regularly take snapshots of the system and (optionally) on any apt operation. The recovery system of Pop!_OS is also installed to the disk and accessible via the systemd bootloader." />

  
  <link rel="alternate" hreflang="en-us" href="https://mutschler.dev/linux/pop-os-btrfs-22-04/" />

  
  
  
    <meta name="theme-color" content="#bbdefb" />
  

  
  
    
    <script src="/js/mathjax-config.js"></script>
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha512-W0xM4mr6dEP9nREo7Z9z+9X70wytKvMGeDsj7ps2+xg5QPrEBXC8tAW1IFnzjR6eoJ90JmCnFzerQJTLzIEHjA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    
    
    
    
      
      
    
    
    

    
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.css" integrity="" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.8916ecd0e6b91586be6f7b434c75fb00.css" />

  
  
  
  
  
  
  
    
    
    <link rel="stylesheet" href="/css/libs/chroma/github-light.min.css" title="hl-light" media="print" onload="this.media='all'" disabled>
    <link rel="stylesheet" href="/css/libs/chroma/dracula.min.css" title="hl-dark" media="print" onload="this.media='all'" >
  

  
  



  


  


  




  
  
  

  
  

  
  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  
  <link rel="icon" type="image/png" href="/media/icon_hu589851f325050e29bd29c51f9d799271_45964_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu589851f325050e29bd29c51f9d799271_45964_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://mutschler.dev/linux/pop-os-btrfs-22-04/" />

  
  
  
  
  
  
  
  
    
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary" />
  
  <meta property="og:site_name" content="mutschler.dev" />
  <meta property="og:url" content="https://mutschler.dev/linux/pop-os-btrfs-22-04/" />
  <meta property="og:title" content="Pop!_OS 22.04: installation guide with btrfs, luks encryption and auto snapshots with timeshift | mutschler.dev" />
  <meta property="og:description" content="In this guide I will walk you through the installation procedure to get a Pop!_OS 22.04 system with a luks-encrypted partition which contains a LVM with a logical volume for the root filesystem that is formatted with btrfs and contains a subvolume @ for / and a subvolume @home for /home. I will show how to optimize the btrfs mount options and how to setup an encrypted swap partition which works with hibernation. This layout enables one to use timeshift which will regularly take snapshots of the system and (optionally) on any apt operation. The recovery system of Pop!_OS is also installed to the disk and accessible via the systemd bootloader." /><meta property="og:image" content="https://mutschler.dev/media/icon_hu589851f325050e29bd29c51f9d799271_45964_512x512_fill_lanczos_center_3.png" />
    <meta property="twitter:image" content="https://mutschler.dev/media/icon_hu589851f325050e29bd29c51f9d799271_45964_512x512_fill_lanczos_center_3.png" /><meta property="og:locale" content="en-us" />
  
    
      <meta
        property="article:published_time"
        content="2022-05-24T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2023-07-14T22:12:08&#43;02:00">
  

  



  

  


  <title>Pop!_OS 22.04: installation guide with btrfs, luks encryption and auto snapshots with timeshift | mutschler.dev</title>

  
  
  
  











</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper  dark " data-wc-page-id="6c2cee08c3979bfa5ae48fc51b4cc2f8" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.22ad66a4f96b4e9da14bbb023ea57684.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="Search...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    












<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/">mutschler.dev</a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/">mutschler.dev</a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/apple/"><span>Apple</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link  active" href="/linux/"><span>Linux</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/stuff/"><span>Stuff</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://buymeacoffee.com/mutschler" data-toggle="tooltip" data-placement="bottom" title="Buy me a coffee" target="_blank" rel="noopener" aria-label="Buy me a coffee">
                <i class="fas fa-coffee" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="mailto:willi@mutschler.dev" data-toggle="tooltip" data-placement="bottom" title="Write me an email"  aria-label="Write me an email">
                <i class="fas fa-envelope" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://github.com/wmutschl" data-toggle="tooltip" data-placement="bottom" title="Follow me on GitHub" target="_blank" rel="noopener" aria-label="Follow me on GitHub">
                <i class="fab fa-github" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://gitlab.com/wmutschl" data-toggle="tooltip" data-placement="bottom" title="Follow me on Gitlab" target="_blank" rel="noopener" aria-label="Follow me on Gitlab">
                <i class="fab fa-gitlab" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://www.youtube.com/c/wmutschl" data-toggle="tooltip" data-placement="bottom" title="Follow me on YouTube" target="_blank" rel="noopener" aria-label="Follow me on YouTube">
                <i class="fab fa-youtube" aria-hidden="true"></i>
              </a>
            </li>
          
        

        
        
        <li class="nav-item">
          <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    




<div class="container-fluid docs">
  <div class="row flex-xl-nowrap">
    <div class="col-12 col-md-3 col-xl-2 docs-sidebar">
      <form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <div class="d-flex">
      <span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">
        
        
          Linux
        
      </span>
      <span><i class="fas fa-chevron-down"></i></span>
    </div>
  </button>

  
  <button class="form-control sidebar-search js-search d-none d-md-flex">
    <i class="fas fa-search pr-2"></i>
    <span class="sidebar-search-text">Search...</span>
    <span class="sidebar-search-shortcut">/</span>
  </button>
  
</form>

<nav class="collapse docs-links" id="docs-nav">
  
  
  
  
  
  

  
  
    

    
      

      


  
    
    
    
    
      
    
    

    
      <ul class="nav docs-sidenav">
        <li class=""><a href="/linux/">Linux</a></li>
    
      


  <li class=""><a href="/linux/pop-os-btrfs-24-04/">Pop!_OS 24.04: installation guide with BTRFS, LUKS encryption and auto snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/elementary-os-post-install/">elementary OS: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/elementary-os-6-1/">elementary OS 6.1 Jólnir: installation guide with btrfs, luks encryption and auto snapshots with timeshift</a></li>



  <li class="active"><a href="/linux/pop-os-btrfs-22-04/">Pop!_OS 22.04: installation guide with btrfs, luks encryption and auto snapshots with timeshift</a></li>



  <li class=""><a href="/linux/pop-os-post-install/">Pop!_OS: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/fedora-post-install/">Fedora Workstation: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/fedora-btrfs-35/">Fedora Workstation 35 with automatic btrfs snapshots and backups using BTRBK</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-21-10/">DRAFT: Pop!_OS 21.10: installation guide with btrfs-LVM-luks and auto snapshots with BTRBK</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-21-04/">Pop!_OS 21.04: installation guide with btrfs-LVM-luks and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/raspi-post-install/">Ubuntu Server Raspberry Pi: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/raspi-btrfs/">Ubuntu Server 20.10 on Raspberry Pi 4: installation guide with USB Boot (no SD card) and full disk encryption (excluding /boot) using btrfs-inside-luks and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/fedora-btrfs-33/">Fedora Workstation 33: installation guide with btrfs-luks full disk encryption (optionally including /boot) and auto snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/btrfs/">Why I (still) like btrfs</a></li>



  <li class=""><a href="/linux/ubuntu-btrfs-raid1-20-04/">Ubuntu Desktop 20.04: installation guide with btrfs-luks-RAID1 full disk encryption including /boot and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/ubuntu-btrfs-20-04/">Ubuntu Desktop 20.04: installation guide with btrfs-luks full disk encryption including /boot and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/ubuntu-post-install/">Ubuntu Desktop: Things to do after installation (Apps, Settings, and Tweaks)</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-raid1-20-04/">Pop!_OS 20.04: installation guide with btrfs-LVM-luks-RAID1 and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/pop-os-btrfs-20-04/">Pop!_OS 20.04: installation guide with btrfs-LVM-luks and auto-apt snapshots with Timeshift</a></li>



  <li class=""><a href="/linux/timeshift/">Timeshift</a></li>

      
    

    
      </ul>
    

  
</nav>

    </div>

    
    
    <div class="d-none d-xl-block col-xl-2 docs-toc">
      












      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
      </ul>

      <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#step-0-general-remarks">Step 0: General remarks</a></li>
    <li><a href="#step-1-prepare-partitions-by-performing-a-clean-install-first">Step 1: Prepare partitions by performing a Clean Install first</a>
      <ul>
        <li><a href="#optional-understand-the-default-partition-layout-and-installation-structure">[Optional] Understand the default partition layout and installation structure</a></li>
      </ul>
    </li>
    <li><a href="#step-2-install-pop_os-using-the-custom-advanced-option">Step 2: Install Pop!_OS using the <code>Custom (Advanced)</code> option</a></li>
    <li><a href="#step-3-post-installation-steps">Step 3: Post-Installation steps</a>
      <ul>
        <li><a href="#mount-the-btrfs-top-level-root-filesystem-with-zstd-compression">Mount the btrfs top-level root filesystem with zstd compression</a></li>
        <li><a href="#create-btrfs-subvolumes--and-home">Create btrfs subvolumes <code>@</code> and <code>@home</code></a></li>
        <li><a href="#changes-to-fstab">Changes to fstab</a></li>
        <li><a href="#changes-to-crypttab">Changes to crypttab</a></li>
        <li><a href="#adjust-configuration-of-kernelstub">Adjust configuration of kernelstub</a></li>
        <li><a href="#adjust-configuration-of-systemd-bootloader">Adjust configuration of systemd bootloader</a></li>
        <li><a href="#create-a-chroot-environment-and-update-initramfs">Create a chroot environment and update initramfs</a></li>
      </ul>
    </li>
    <li><a href="#step-4-reboot-some-checks-and-system-updates">Step 4: Reboot, some checks, and system updates</a></li>
    <li><a href="#step-5-install-timeshift-and-timeshift-autosnap-apt">Step 5: Install timeshift and timeshift-autosnap-apt</a></li>
    <li><a href="#step-6-practice-recovery-and-system-rollback">Step 6: Practice recovery and system rollback</a>
      <ul>
        <li><a href="#rollback-with-timeshift">Rollback with timeshift</a></li>
        <li><a href="#rollback-manually">Rollback manually</a></li>
      </ul>
    </li>
  </ul>
</nav>

      











    </div>
    

    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role="main">

      <article class="article">

        <div class="docs-article-container">
          
        </div>

        
        

        <div class="docs-article-container">
          
          <h1>Pop!_OS 22.04: installation guide with btrfs, luks encryption and auto snapshots with timeshift</h1>

          <div class="article-style">

            
            

            <p><em><strong>Please feel free to raise any comments or issues on the <a href="https://github.com/wmutschl/mutschler.dev" target="_blank" rel="noopener">website&rsquo;s Github repository</a>. Pull requests are very much appreciated.</strong></em>
<a href="https://www.buymeacoffee.com/mutschler" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-red.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;" ></a></p>
<p>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/i8HDHAX1RJc" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<em>Note that this written guide is an updated version of the video and contains much more information.</em>
<details class="toc-inpage d-print-none d-xl-none " open>
  <summary class="font-weight-bold">Table of Contents</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#step-0-general-remarks">Step 0: General remarks</a></li>
    <li><a href="#step-1-prepare-partitions-by-performing-a-clean-install-first">Step 1: Prepare partitions by performing a Clean Install first</a>
      <ul>
        <li><a href="#optional-understand-the-default-partition-layout-and-installation-structure">[Optional] Understand the default partition layout and installation structure</a></li>
      </ul>
    </li>
    <li><a href="#step-2-install-pop_os-using-the-custom-advanced-option">Step 2: Install Pop!_OS using the <code>Custom (Advanced)</code> option</a></li>
    <li><a href="#step-3-post-installation-steps">Step 3: Post-Installation steps</a>
      <ul>
        <li><a href="#mount-the-btrfs-top-level-root-filesystem-with-zstd-compression">Mount the btrfs top-level root filesystem with zstd compression</a></li>
        <li><a href="#create-btrfs-subvolumes--and-home">Create btrfs subvolumes <code>@</code> and <code>@home</code></a></li>
        <li><a href="#changes-to-fstab">Changes to fstab</a></li>
        <li><a href="#changes-to-crypttab">Changes to crypttab</a></li>
        <li><a href="#adjust-configuration-of-kernelstub">Adjust configuration of kernelstub</a></li>
        <li><a href="#adjust-configuration-of-systemd-bootloader">Adjust configuration of systemd bootloader</a></li>
        <li><a href="#create-a-chroot-environment-and-update-initramfs">Create a chroot environment and update initramfs</a></li>
      </ul>
    </li>
    <li><a href="#step-4-reboot-some-checks-and-system-updates">Step 4: Reboot, some checks, and system updates</a></li>
    <li><a href="#step-5-install-timeshift-and-timeshift-autosnap-apt">Step 5: Install timeshift and timeshift-autosnap-apt</a></li>
    <li><a href="#step-6-practice-recovery-and-system-rollback">Step 6: Practice recovery and system rollback</a>
      <ul>
        <li><a href="#rollback-with-timeshift">Rollback with timeshift</a></li>
        <li><a href="#rollback-manually">Rollback manually</a></li>
      </ul>
    </li>
  </ul>
</nav>
</details>
</p>
<h2 id="overview">Overview</h2>
<p>I am exclusively using btrfs as my filesystem on all my Linux systems, see <a href="../btrfs/">Why I (still) like btrfs</a>. So, in this guide I will show how to install Pop!_OS 22.04 with the following structure:</p>
<ul>
<li>an unencrypted EFI partition for the systemd bootloader</li>
<li>an unencrypted partition for the Pop!_OS recovery system</li>
<li>an encrypted swap partition which works with hibernation</li>
<li>an encrypted btrfs partition (with LVM) for the root filesystem
<ul>
<li>the btrfs logical volume contains a subvolume <code>@</code> for <code>/</code> and a subvolume <code>@home</code> for <code>/home</code>. Note that the Pop!_OS installer does not create btrfs subvolumes by default, so we need to do this manually.</li>
</ul>
</li>
<li>automatic system snapshots and easy rollback using:
<ul>
<li><a href="https://github.com/teejee2008/timeshift" target="_blank" rel="noopener">timeshift</a> which will regularly take (almost instant) snapshots of the system</li>
<li><a href="https://github.com/wmutschl/timeshift-autosnap-apt" target="_blank" rel="noopener">timeshift-autosnap-apt</a> which creates btrfs snapshot with timeshift on any system update with apt</li>
</ul>
</li>
</ul>
<p>This setup works similarly well on other distributions, for which I also have <a href="../../install-guides">installation guides (with optional RAID1)</a>.</p>
<h2 id="step-0-general-remarks">Step 0: General remarks</h2>
<p>This tutorial is made with Pop!_OS 22.04 from <a href="https://system76.com/pop" target="_blank" rel="noopener">System76</a> copied to an installation media (usually a USB Flash device). Other versions of Pop!_OS and other distributions that use the systemd boot manager might also work, but sometimes require additional steps (see my other <a href="../../install-guides">installation guides</a>).</p>
<p><strong>I strongly advise to try the following installation steps in a virtual machine first before doing anything like that on real hardware!</strong> For instance, you can spin up a virtual machine using e.g. the awesome <a href="https://github.com/quickemu-project/quickemu" target="_blank" rel="noopener">quickemu</a> project.</p>
<h2 id="step-1-prepare-partitions-by-performing-a-clean-install-first">Step 1: Prepare partitions by performing a Clean Install first</h2>
<p>If you already have (a previous version of) POP!_OS installed, you can safely skip this step as you have already a partition layout that will work with the installer.
In my previous installation guides, I manually prepared the partitions to have full control on the individual partition sizes. However, as time moved on I noticed that I tend to stick to the default partition layout of POP!_OS. So the easiest and quickest approach is to simply perform the installation twice. So, let&rsquo;s run first the automatic <code>Clean Install</code> with encryption. When this finishes, do NOT <code>Restart Device</code> or <code>Shut Down</code>, but instead right-click in the dock on the <code>Install Pop!_OS</code> app and select <code>Quit</code>.</p>
<p>Of course, you can adapt the partitions with Gparted to your licking. If you want to see the structure of the installation keep reading, otherwise go to the next step to perform the second Installation.</p>
<h3 id="optional-understand-the-default-partition-layout-and-installation-structure">[Optional] Understand the default partition layout and installation structure</h3>
<p>So, let&rsquo;s open a terminal and have a look on the default partition layout (obviously you should probably just use Gparted for this):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo lsblk
</span></span><span class="line"><span class="cl"><span class="c1"># NAME       MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS</span>
</span></span><span class="line"><span class="cl"><span class="c1"># loop0        7:0    0   2.4G  1 loop /rofs</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sda          8:0    0  55.9G  0 disk </span>
</span></span><span class="line"><span class="cl"><span class="c1"># ├─sda1       8:1    0   498M  0 part </span>
</span></span><span class="line"><span class="cl"><span class="c1"># ├─sda2       8:2    0     4G  0 part </span>
</span></span><span class="line"><span class="cl"><span class="c1"># ├─sda3       8:3    0  47.4G  0 part </span>
</span></span><span class="line"><span class="cl"><span class="c1"># └─sda4       8:4    0     4G  0 part </span>
</span></span><span class="line"><span class="cl"><span class="c1"># sdb          8:16   0 465.8G  0 disk </span>
</span></span><span class="line"><span class="cl"><span class="c1"># sdc          8:32   0 223.6G  0 disk </span>
</span></span><span class="line"><span class="cl"><span class="c1"># ├─sdc1       8:33   0   100M  0 part </span>
</span></span><span class="line"><span class="cl"><span class="c1"># ├─sdc2       8:34   0    16M  0 part </span>
</span></span><span class="line"><span class="cl"><span class="c1"># ├─sdc3       8:35   0   223G  0 part </span>
</span></span><span class="line"><span class="cl"><span class="c1"># └─sdc4       8:36   0   517M  0 part </span>
</span></span><span class="line"><span class="cl"><span class="c1"># sdd          8:48   1  58.9G  0 disk </span>
</span></span><span class="line"><span class="cl"><span class="c1"># ├─sdd1       8:49   1  58.8G  0 part </span>
</span></span><span class="line"><span class="cl"><span class="c1"># │ └─ventoy 253:0    0   2.5G  1 dm   /media/pop-os/Pop_OS 22.04 amd64 # Intel</span>
</span></span><span class="line"><span class="cl"><span class="c1"># │                                    /cdrom</span>
</span></span><span class="line"><span class="cl"><span class="c1"># └─sdd2       8:50   1    32M  0 part /media/pop-os/Pop_OS 22.04 amd64 Intel</span>
</span></span></code></pre></div><p>I&rsquo;ve installed POP!_OS to a small SSD which is recognized as <code>sda</code> on my machine. <code>sdb</code> is another empty ssd and Windows is installed on <code>sdc</code>. Lastly, <code>sdd</code> is a USB stick on which I have <a href="https://www.ventoy.net" target="_blank" rel="noopener">Ventoy</a> installed and which contains the ISO of the installer.</p>
<p>So let&rsquo;s have a closer look at the partition layout of <code>sda</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo parted /dev/sda unit MiB print
</span></span><span class="line"><span class="cl"><span class="c1"># Model: ATA Patriot Pyro SE (scsi)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Disk /dev/sda: 57242MiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sector size (logical/physical): 512B/512B</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Partition Table: gpt</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Disk Flags: </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Number  Start     End       Size      File system     Name      Flags</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  1      2.00MiB   500MiB    498MiB    fat32                     boot, esp</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  2      500MiB    4596MiB   4096MiB   fat32           recovery  msftdata</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  3      4596MiB   53144MiB  48548MiB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  4      53144MiB  57240MiB  4096MiB   linux-swap(v1)            swap</span>
</span></span></code></pre></div><p>We have the following 4 partitions:</p>
<ol>
<li>a 498 MiB FAT32 EFI partition for the systemd bootloader (note the boot, eps flags)</li>
<li>a 4096 MiB FAT32 partition for the Pop!_OS recovery system</li>
<li>a 48548MiB partition that contains the actual system files</li>
<li>a 4096 MiB swap partition for (encrypted) swap use</li>
</ol>
<p>Let&rsquo;s have a closer look at the luks2-encrypted <code>sda3</code> partition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo cryptsetup luksDump /dev/sda3
</span></span><span class="line"><span class="cl"><span class="c1"># LUKS header information</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Version:       	2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Epoch:         	3</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Metadata area: 	16384 [bytes]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Keyslots area: 	16744448 [bytes]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID:          	52d31097-e125-46f0-a139-85087e1b5565</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Label:         	(no label)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Subsystem:     	(no subsystem)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Flags:       	(no flags)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Data segments:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   0: crypt</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	offset: 16777216 [bytes]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	length: (whole device)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	cipher: aes-xts-plain64</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	sector: 512 [bytes]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Keyslots:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   0: luks2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Key:        512 bits</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Priority:   normal</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Cipher:     aes-xts-plain64</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Cipher key: 512 bits</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	PBKDF:      argon2id</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Time cost:  4</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Memory:     1048576</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Threads:    4</span>
</span></span></code></pre></div><p>So this basically uses the default options to encrypt a partition with luks (e.g. running <code>cryptsetup luksFormat /dev/sda3</code>). Now let&rsquo;s have a closer look what is inside the encrypted partition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo cryptsetup luksOpen /dev/sda3 cryptdata
</span></span><span class="line"><span class="cl"><span class="c1"># Enter passphrase for /dev/sda3:</span>
</span></span><span class="line"><span class="cl">ls /dev/mapper
</span></span><span class="line"><span class="cl"><span class="c1"># control  cryptdata  data-root</span>
</span></span><span class="line"><span class="cl">sudo pvs
</span></span><span class="line"><span class="cl"><span class="c1">#  PV                    VG   Fmt  Attr PSize  PFree</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  /dev/mapper/cryptdata data lvm2 a--  47.39g    0</span>
</span></span><span class="line"><span class="cl">sudo vgs
</span></span><span class="line"><span class="cl"><span class="c1">#  VG   #PV #LV #SN Attr   VSize  VFree</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  data   1   1   0 wz--n- 47.39g    0</span>
</span></span><span class="line"><span class="cl">sudo lvs
</span></span><span class="line"><span class="cl"><span class="c1">#  LV   VG   Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  root data -wi-a----- 47.39g</span>
</span></span><span class="line"><span class="cl">sudo lsblk /dev/mapper/data-root -f
</span></span><span class="line"><span class="cl"><span class="c1">#NAME      FSTYPE FSVER LABEL UUID                                 FSAVAIL FSUSE% MOUNTPOINTS</span>
</span></span><span class="line"><span class="cl"><span class="c1">#data-root ext4   1.0         bcb96b85-03df-45ca-92aa-6a182386631b </span>
</span></span></code></pre></div><p>By default, if you install with encryption POP!_OS uses <a href="https://askubuntu.com/questions/3596/what-is-lvm-and-what-is-it-used-for" target="_blank" rel="noopener">Logical Volume Management (LVM)</a>, which is a fancy way to combine different disks dynamically into the same partition. In more detail, the encrypted partition (called <code>cryptdata</code>) is a physical volume that contains a volume group called <code>data</code>. Inside the volume group there is a logical volume called <code>root</code> that contains our actual system files. This <code>data-root</code> partition is formatted with ext4. I actually never use any features of LVM, but there is no downside in terms of performance or similar to using it. Moreover, the installer requires LVM if you plan to use encryption.</p>
<p>Okay, now we know what the partition layout is, so let&rsquo;s close everything:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo cryptsetup luksClose /dev/mapper/data-root
</span></span><span class="line"><span class="cl">sudo cryptsetup luksClose /dev/mapper/cryptdata
</span></span><span class="line"><span class="cl">ls /dev/mapper
</span></span><span class="line"><span class="cl"><span class="c1"># control</span>
</span></span></code></pre></div><p>and do the actual second install with btrfs as the underlying filesystem.</p>
<h2 id="step-2-install-pop_os-using-the-custom-advanced-option">Step 2: Install Pop!_OS using the <code>Custom (Advanced)</code> option</h2>
<p>Now let&rsquo;s open again the installer from the dock, select the region, language and keyboard layout. Then choose <code>Custom (Advanced)</code>. You will see your partitioned hard disk:</p>
<ul>
<li>Click on the first partition, activate <code>Use partition</code>, activate <code>Format</code>, Use as <code>Boot /boot/efi</code>, Filesystem: <code>fat32</code>.</li>
<li>Click on the second partition, activate <code>Use partition</code>, activate <code>Format</code>, Use as <code>Custom</code> and enter <code>/recovery</code>, Filesystem: <code>fat32</code>.</li>
<li>Click on the third and largest partition. A <code>Decrypt This Partition</code> dialog opens, enter your luks password and hit <code>Decrypt</code>. A new device is <code>LVM data</code> will be displayed (often at the bottom of the screen). Click on this partition, activate <code>Use partition</code>, activate <code>Format</code>, Use as <code>Root (/)</code> , Filesystem: <code>btrfs</code>.</li>
<li>Click on the fourth partition, activate <code>Use partition</code>, Use as <code>Swap</code>.</li>
</ul>
<p><em>If you have other partitions, check their types and use; particularly, deactivate using or changing any other EFI partitions.</em></p>
<p>Recheck everything (check the partitions where there is a black checkmark) and hit <code>Erase and Install</code>. Follow the steps to create a user account and to write the changes to the disk. Once the installer finishes do NOT select <strong>Restart Device</strong>, but keep the window open.</p>
<h2 id="step-3-post-installation-steps">Step 3: Post-Installation steps</h2>
<p>Open a terminal and switch to an interactive root session:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo -i
</span></span></code></pre></div><p>You might find maximizing the terminal window is helpful for working with the command-line.</p>
<h3 id="mount-the-btrfs-top-level-root-filesystem-with-zstd-compression">Mount the btrfs top-level root filesystem with zstd compression</h3>
<p>Let&rsquo;s mount our root partition (the top-level btrfs volume always has root-id 5), but with some mount options that optimize performance and durability on SSD or NVME drives:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cryptsetup luksOpen /dev/sda3 cryptdata
</span></span><span class="line"><span class="cl"><span class="c1"># Enter passphrase for /dev/sda3</span>
</span></span><span class="line"><span class="cl">mount -o <span class="nv">subvolid</span><span class="o">=</span>5,defaults,compress<span class="o">=</span>zstd:1,discard<span class="o">=</span>async /dev/mapper/data-root /mnt
</span></span></code></pre></div><p>By default, POP!_OS 22.04. uses the default mount options of btrfs. That is, SSD drives will be automatically detected (<code>ssd</code> mount option) and <code>space_cache=v2</code>, which is also the <a href="https://pagure.io/fedora-btrfs/project/issue/24" target="_blank" rel="noopener">default in Fedora</a>. Now there is some debate whether one should use <a href="https://pagure.io/fedora-btrfs/project/issue/9" target="_blank" rel="noopener"><code>noatime</code> (instead of the default <code>relatime</code>)</a>, but personally I have not seen any difference, so I&rsquo;m not using <code>noatime</code> in this guide. However, I have found that there is some additional general advise to use:</p>
<ul>
<li><code>compress=zstd:1</code>: allows to specify the compression algorithm which we want to use. btrfs provides lzo, zstd and zlib compression algorithms; however, zstd has become the best performing candidate. I use level 1 as this is recommended by the <a href="https://fedoraproject.org/wiki/Changes/BtrfsTransparentCompression#Simple_Analysis_of_btrfs_zstd_compression_level" target="_blank" rel="noopener">Fedora team on a workstation</a></li>
<li><code>discard=async</code>: this will become the standard soon, see e.g. <a href="https://pagure.io/fedora-btrfs/project/issue/6" target="_blank" rel="noopener">enable discard=async by default</a></li>
</ul>
<p>We will later also append these mount options to the fstab, but it is good practice to already make use of compression when moving the system files from the top-level btrfs root into the dedicated subvolumes <code>@</code> and <code>@home</code>.</p>
<p>Sometimes the LVM group is not activated, see <a href="https://github.com/wmutschl/mutschler.dev/issues/4" target="_blank" rel="noopener">this issue for help</a>.</p>
<h3 id="create-btrfs-subvolumes--and-home">Create btrfs subvolumes <code>@</code> and <code>@home</code></h3>
<p>Now we will first create the subvolume <code>@</code> and move all files and folders from the top-level filesystem into <code>@</code>. Note that as we use the optimized mount options like compression, these will be already applied during the moving process:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">btrfs subvolume create /mnt/@
</span></span><span class="line"><span class="cl"><span class="c1"># Create subvolume &#39;/mnt/@&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /mnt
</span></span><span class="line"><span class="cl">ls <span class="p">|</span> grep -v @ <span class="p">|</span> xargs mv -t @
</span></span><span class="line"><span class="cl"><span class="c1"># this moves all files that don&#39;t have &#34;@&#34; in the name to the @/ folder</span>
</span></span><span class="line"><span class="cl">ls -a /mnt
</span></span><span class="line"><span class="cl"><span class="c1"># . .. @</span>
</span></span></code></pre></div><p>Now let&rsquo;s create another subvolume called <code>@home</code> and move the user folder from <code>/mnt/@/home/</code> into <code>@home</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">btrfs subvolume create /mnt/@home
</span></span><span class="line"><span class="cl"><span class="c1"># Create subvolume &#39;/mnt/@home&#39;</span>
</span></span><span class="line"><span class="cl">mv /mnt/@/home/* /mnt/@home/
</span></span><span class="line"><span class="cl">ls -a /mnt/@/home
</span></span><span class="line"><span class="cl"><span class="c1"># . ..</span>
</span></span><span class="line"><span class="cl">ls -a /mnt/@home
</span></span><span class="line"><span class="cl"><span class="c1"># . .. wmutschl</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">btrfs subvolume list /mnt
</span></span><span class="line"><span class="cl"><span class="c1"># ID 264 gen 339 top level 5 path @</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ID 265 gen 340 top level 5 path @home</span>
</span></span></code></pre></div><h3 id="changes-to-fstab">Changes to fstab</h3>
<p>We need to adapt the <code>fstab</code> to</p>
<ul>
<li>mount <code>/</code> to the <code>@</code> subvolume</li>
<li>mount <code>/home</code> to the <code>@home</code> subvolume</li>
<li>make use of optimized btrfs mount options</li>
</ul>
<p>So open it with a text editor, e.g.:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">nano /mnt/@/etc/fstab
</span></span></code></pre></div><p>or use these <code>sed</code> commands</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/btrfs  defaults/btrfs  defaults,subvol=@,compress=zstd:1,discard=async/&#39;</span> /mnt/@/etc/fstab
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;UUID=</span><span class="k">$(</span>blkid -s UUID -o value /dev/mapper/data-root<span class="k">)</span><span class="s2">  /home  btrfs  defaults,subvol=@home,compress=zstd:1,discard=async   0 0&#34;</span> &gt;&gt; /mnt/@/etc/fstab
</span></span></code></pre></div><p>Either way your <code>fstab</code> should look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat /mnt/@/etc/fstab
</span></span><span class="line"><span class="cl"><span class="c1"># PARTUUID=2ea6ae0f-6b6a-4e4c-8eaa-7fec8dde5162  /boot/efi  vfat   umask=0077  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># PARTUUID=8ce17e3b-3853-4d10-b878-5dd1ccd6fe8a  /recovery  vfat   umask=0077  0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/cryptswap                          none       swap   defaults    0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=052ec665-cf5d-4372-bb65-1b82237b9101      /          btrfs  defaults,subvol=@,compress=zstd:1,discard=async        0  0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=052ec665-cf5d-4372-bb65-1b82237b9101      /home      btrfs  defaults,subvol=@home,compress=zstd:1,discard=async    0  0</span>
</span></span></code></pre></div><p>Note that your PARTUUID and UUID numbers will be different. The last two lines for <code>/</code> and <code>/home</code> are the important ones.</p>
<h3 id="changes-to-crypttab">Changes to crypttab</h3>
<p>As we use <code>discard=async</code>, we need to add <code>discard</code> to the <code>crypttab</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/luks/luks,discard/&#39;</span> /mnt/@/etc/crypttab
</span></span><span class="line"><span class="cl">cat /mnt/@/etc/crypttab
</span></span><span class="line"><span class="cl"><span class="c1"># cryptdata UUID=52d31097-e125-46f0-a139-85087e1b5565 none luks,discard</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cryptswap UUID=8cd56bf1-1a43-49c3-98b0-835b658b54fc /dev/urandom swap,plain,offset=1024,cipher=aes-xts-plain64,size=512</span>
</span></span></code></pre></div><p>Here we can also see that the swap partition is encrypted and mounted to a device called <code>cryptswap</code>.</p>
<h3 id="adjust-configuration-of-kernelstub">Adjust configuration of kernelstub</h3>
<p>We need to adjust some settings for the systemd boot manager and also make sure these settings are not overwritten if we install or update kernels and modules. Namely, we need to add <code>rootflags=subvol=@</code> to the <code>&quot;user&quot;</code> section of the kernelstub configuration file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">nano /mnt/@/etc/kernelstub/configuration
</span></span></code></pre></div><p>Here you need to add <code>rootflags=subvol=@</code> to the <code>&quot;user&quot;</code> kernel options. That is, your configuration file should look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat /mnt/@/etc/kernelstub/configuration
</span></span><span class="line"><span class="cl"><span class="c1"># {</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   &#34;default&#34;: {</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;kernel_options&#34;: [</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;quiet&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;splash&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ],</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;esp_path&#34;: &#34;/boot/efi&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;setup_loader&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;manage_mode&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;force_update&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;live_mode&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;config_rev&#34;:3</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   },</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   &#34;user&#34;: {</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;kernel_options&#34;: [</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;quiet&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;loglevel=0&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;systemd.show_status=false&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;splash&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       &#34;rootflags=subvol=@&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ],</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;esp_path&#34;: &#34;/boot/efi&#34;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;setup_loader&#34;: true,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;manage_mode&#34;: true,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;force_update&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;live_mode&#34;: false,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     &#34;config_rev&#34;:3</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   }</span>
</span></span><span class="line"><span class="cl"><span class="c1"># }</span>
</span></span></code></pre></div><p><strong>VERY IMPORTANTLY: Don&rsquo;t forget to put a comma after</strong> <code>&quot;splash&quot;</code> in the line above the added <code>&quot;rootflags=subvol=@&quot;</code> option, which ends without a comma. Otherwise you will get errors when you later run <code>update-initramfs</code> (see below)!</p>
<h3 id="adjust-configuration-of-systemd-bootloader">Adjust configuration of systemd bootloader</h3>
<p>We need to adjust some settings for the systemd boot manager as well, so let&rsquo;s mount our EFI partition</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">mount /dev/sda1 /mnt/@/boot/efi
</span></span></code></pre></div><p>Add <code>rootflags=subvol=@</code> to the last line of <code>Pop_OS_current.conf</code> either using a text editor or the following command</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/splash/splash rootflags=subvol=@/&#39;</span> /mnt/@/boot/efi/loader/entries/Pop_OS-current.conf
</span></span><span class="line"><span class="cl">cat /mnt/@/boot/efi/loader/entries/Pop_OS-current.conf
</span></span><span class="line"><span class="cl"><span class="c1"># title Pop!_OS</span>
</span></span><span class="line"><span class="cl"><span class="c1"># linux /EFI/Pop_OS-UUID_of_data-root/vmlinuz.efi</span>
</span></span><span class="line"><span class="cl"><span class="c1"># initrd /EFI/Pop_OS-UUID_of_data-root/initrd.img</span>
</span></span><span class="line"><span class="cl"><span class="c1"># options root=UUID=UUID_of_data-root ro quiet loglevel=0 systemd.show_status=false splash rootflags=subvol=@</span>
</span></span></code></pre></div><p>where <code>UUID_of_data-root</code> is the UUID of <code>/dev/mapper/data-root</code>.</p>
<p>Optionally, I like to add a timeout to the systemd boot menu in order to easily access the recovery partition:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;timeout 3&#34;</span> &gt;&gt; /mnt/@/boot/efi/loader/loader.conf
</span></span><span class="line"><span class="cl">cat /mnt/@/boot/efi/loader/loader.conf 
</span></span><span class="line"><span class="cl"><span class="c1"># default Pop_OS-current</span>
</span></span><span class="line"><span class="cl"><span class="c1"># timeout 3</span>
</span></span></code></pre></div><h3 id="create-a-chroot-environment-and-update-initramfs">Create a chroot environment and update initramfs</h3>
<p>Now, let&rsquo;s create a chroot environment, which enables one to work directly inside the newly installed OS, without actually booting into it. For this, unmount the top-level root filesystem from <code>/mnt</code> and remount the subvolume <code>@</code> to <code>/mnt</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">cd</span> /
</span></span><span class="line"><span class="cl">umount -l /mnt
</span></span><span class="line"><span class="cl">mount -o <span class="nv">subvol</span><span class="o">=</span>@,defaults,compress<span class="o">=</span>zstd:1,discard<span class="o">=</span>async /dev/mapper/data-root /mnt
</span></span><span class="line"><span class="cl">ls /mnt
</span></span><span class="line"><span class="cl"><span class="c1"># bin boot dev etc home lib lib32 lib64 libx32 media mnt opt proc recovery root run sbin srv sys tmp usr var</span>
</span></span></code></pre></div><p>Then the following commands will put us into our system using chroot (taken from System76&rsquo;s help post on how to <a href="https://support.system76.com/articles/bootloader/#systemd-boot" target="_blank" rel="noopener">Repair the Bootloader</a>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="k">for</span> i in /dev /dev/pts /proc /sys /run<span class="p">;</span> <span class="k">do</span> mount -B <span class="nv">$i</span> /mnt<span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>
</span></span><span class="line"><span class="cl">chroot /mnt
</span></span></code></pre></div><p>We are now inside the new system, so let&rsquo;s check whether our <code>fstab</code> mounts everything correctly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">mount -av
</span></span><span class="line"><span class="cl"><span class="c1"># /boot/efi                : successfully mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /recovery                : successfully mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># none                     : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /                        : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /home                    : successfully mounted</span>
</span></span></code></pre></div><p>Looks good! Now we need to update the initramfs to make it aware of our changes to the kernelstub:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">update-initramfs -c -k all
</span></span><span class="line"><span class="cl"><span class="c1"># update-initramfs: Generating /boot/initrd.img-5.17.5-76051705-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Config    : INFO     Looking for configuration...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub           : INFO     System information: </span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1">#     OS:..................Pop!_OS 22.04</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Root partition:....../dev/dm-2</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Root FS UUID:........052ec665-cf5d-4372-bb65-1b82237b9101</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ESP Path:............/boot/efi</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ESP Partition:......./dev/sda1</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     ESP Partition #:.....1</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     NVRAM entry #:.......-1</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Boot Variable #:.....0000</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Kernel Boot Options:.quiet loglevel=0 systemd.show_status=false splash rootflags=subvol=@</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Kernel Image Path:.../boot/vmlinuz-5.17.5-76051705-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Initrd Image Path:.../boot/initrd.img-5.17.5-76051705-generic</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     Force-overwrite:.....False</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     Copying Kernel into ESP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     Copying initrd.img into ESP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     Setting up loader.conf configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     Making entry file for Pop!_OS</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     Backing up old kernel</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kernelstub.Installer : INFO     No old kernel found, skipping</span>
</span></span></code></pre></div><p>Note that if you run into errors like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kernelstub.Config    : INFO     Looking <span class="k">for</span> configuration...
</span></span><span class="line"><span class="cl">Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/bin/kernelstub&#34;</span>, line 244, in &lt;module&gt;
</span></span><span class="line"><span class="cl">    main<span class="o">()</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/bin/kernelstub&#34;</span>, line 241, in main
</span></span><span class="line"><span class="cl">    kernelstub.main<span class="o">(</span>args<span class="o">)</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3/dist-packages/kernelstub/application.py&#34;</span>, line 142, in main
</span></span><span class="line"><span class="cl">    <span class="nv">config</span> <span class="o">=</span> Config.Config<span class="o">()</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3/dist-packages/kernelstub/config.py&#34;</span>, line 50, in __init__
</span></span><span class="line"><span class="cl">    self.config <span class="o">=</span> self.load_config<span class="o">()</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3/dist-packages/kernelstub/config.py&#34;</span>, line 60, in load_config
</span></span><span class="line"><span class="cl">    self.config <span class="o">=</span> json.load<span class="o">(</span>config_file<span class="o">)</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3.9/json/__init__.py&#34;</span>, line 293, in load
</span></span><span class="line"><span class="cl">    <span class="k">return</span> loads<span class="o">(</span>fp.read<span class="o">()</span>,
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3.9/json/__init__.py&#34;</span>, line 346, in loads
</span></span><span class="line"><span class="cl">    <span class="k">return</span> _default_decoder.decode<span class="o">(</span>s<span class="o">)</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3.9/json/decoder.py&#34;</span>, line 337, in decode
</span></span><span class="line"><span class="cl">    obj, <span class="nv">end</span> <span class="o">=</span> self.raw_decode<span class="o">(</span>s, <span class="nv">idx</span><span class="o">=</span>_w<span class="o">(</span>s, 0<span class="o">)</span>.end<span class="o">())</span>
</span></span><span class="line"><span class="cl">  File <span class="s2">&#34;/usr/lib/python3.9/json/decoder.py&#34;</span>, line 353, in raw_decode
</span></span><span class="line"><span class="cl">    obj, <span class="nv">end</span> <span class="o">=</span> self.scan_once<span class="o">(</span>s, idx<span class="o">)</span>
</span></span><span class="line"><span class="cl">json.decoder.JSONDecodeError: Expecting <span class="s1">&#39;,&#39;</span> delimiter: line <span class="m">20</span> column <span class="m">7</span> <span class="o">(</span>char 363<span class="o">)</span>
</span></span><span class="line"><span class="cl">run-parts: /etc/initramfs/post-update.d//zz-kernelstub exited with <span class="k">return</span> code <span class="m">1</span>
</span></span></code></pre></div><p>you probably forgot a comma after <code>&quot;splash&quot;</code> in the <code>/etc/kernelstub/configuration</code> file (see above).</p>
<h2 id="step-4-reboot-some-checks-and-system-updates">Step 4: Reboot, some checks, and system updates</h2>
<p>Now, it is time to exit the chroot.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">exit</span>
</span></span></code></pre></div><p>Close the terminal and finally hit <code>Reboot Device</code> on the installer app. Cross your fingers! If all went well you should see a passphrase prompt (YAY!), where you enter the luks passphrase and your system should boot.</p>
<p>Now let&rsquo;s click through the welcome screen and see whether everything is set up correctly. In a terminal:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo mount -av
</span></span><span class="line"><span class="cl"><span class="c1"># /boot/efi                : already mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /recovery                : already mounted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># none                     : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /                        : ignored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /home                    : already mounted</span>
</span></span></code></pre></div><p>All the entries in the <code>fstab</code> are mounted correctly.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo mount -v <span class="p">|</span> grep /dev/mapper
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/data-root on / type btrfs (rw,relatime,compress=zstd:1,ssd,discard=async,space_cache=v2,subvolid=256,subvol=/@)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/mapper/data-root on /home type btrfs (rw,relatime,compress=zstd:1,ssd,discard=async,space_cache=v2,subvolid=257,subvol=/@home)</span>
</span></span></code></pre></div><p>Our optimized btrfs mount options were passed on and are used correctly. Note that you cannot have different mount options on the same partition.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo swapon
</span></span><span class="line"><span class="cl"><span class="c1"># NAME      TYPE      SIZE USED PRIO</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/dm-2 partition   4G   0B   -2</span>
</span></span></code></pre></div><p>The encrypted swap partition is in use.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo btrfs filesystem show /
</span></span><span class="line"><span class="cl"><span class="c1"># Label: none  uuid: 052ec665-cf5d-4372-bb65-1b82237b9101</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	Total devices 1 FS bytes used 6.33GiB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	devid    1 size 47.39GiB used 8.02GiB path /dev/mapper/data-root</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo btrfs subvolume list /
</span></span><span class="line"><span class="cl"><span class="c1"># ID 256 gen 79 top level 5 path @</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ID 257 gen 79 top level 5 path @home</span>
</span></span></code></pre></div><p>These two btrfs commands tell us which disk is in use and which subvolumes are available.</p>
<p>If you have installed POP!_OS on a SSD or NVME, enable <code>fstrim.timer</code> as <a href="https://www.phoronix.com/scan.php?page=news_item&amp;px=Fedora-Btrfs-Opts-Discard-Comp" target="_blank" rel="noopener">both fstrim and discard=async mount option can peacefully co-exist</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> fstrim.timer
</span></span></code></pre></div><p>Importantly, for <a href="https://www.heise.de/ct/hotline/Linux-Verschluesselte-SSD-trimmen-2405875.html" target="_blank" rel="noopener">SSD trimming to work properly</a>, it is important that you add <code>discard</code> to your <code>crypttab</code> (see above). Also check whether you <code>issue_discards=1</code> is set in <code>/etc/lvm/lvm.conf</code> (it should be set to 1 by default):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat /etc/lvm/lvm.conf <span class="p">|</span> grep issue_discards
</span></span><span class="line"><span class="cl"><span class="c1"># 	# Configuration option devices/issue_discards.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 	issue_discards = 1</span>
</span></span></code></pre></div><p>If all look&rsquo;s good, let&rsquo;s update and upgrade the system:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt upgrade
</span></span><span class="line"><span class="cl">sudo apt dist-upgrade
</span></span><span class="line"><span class="cl">sudo apt autoremove
</span></span><span class="line"><span class="cl">sudo apt autoclean
</span></span><span class="line"><span class="cl">flatpak update
</span></span></code></pre></div><p>Finally, do another reboot.</p>
<h2 id="step-5-install-timeshift-and-timeshift-autosnap-apt">Step 5: Install timeshift and timeshift-autosnap-apt</h2>
<p>Install timeshift and configure it directly via the GUI:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo apt install -y timeshift
</span></span><span class="line"><span class="cl">sudo timeshift-gtk
</span></span></code></pre></div><ul>
<li>Select &ldquo;btrfs&rdquo; as the &ldquo;Snapshot Type&rdquo;; continue with &ldquo;Next&rdquo;</li>
<li>Choose your btrfs system partition as &ldquo;Snapshot Location&rdquo;; continue with &ldquo;Next&rdquo;</li>
<li>&ldquo;Select Snapshot Levels&rdquo; (type and number of snapshots that will be automatically created and managed/deleted by timeshift), my recommendations:
<ul>
<li>Activate &ldquo;Monthly&rdquo; and set it to 2</li>
<li>Activate &ldquo;Weekly&rdquo; and set it to 3</li>
<li>Activate &ldquo;Daily&rdquo; and set it to 5</li>
<li>Deactivate &ldquo;Hourly&rdquo;</li>
<li>Activate &ldquo;Boot&rdquo; and set it to 5</li>
<li>Activate &ldquo;Stop cron emails for scheduled tasks&rdquo;</li>
<li>continue with &ldquo;Next&rdquo;</li>
<li>I doinclude the <code>@home</code> subvolume (which is not selected by default). Note that when you restore a snapshot with timeshift you get to choose whether you want to restore @home as well (which in most cases you actually don&rsquo;t want to do!). But having snapshots of my home folder is quite convenient.</li>
<li>Activate &ldquo;Enable BTRFS qgroups (recommended)&rdquo;. There are some <a href="https://github.com/teejee2008/timeshift/issues?q=is%3Aissue&#43;quota&#43;qgroup&#43;" target="_blank" rel="noopener">issues on GitHub</a> that there MIGHT be some performance issues with this (if you manually deactivate quotas as well), but I&rsquo;ve never had any issues, so I stick with the recommendation to enable it.</li>
<li>Click &ldquo;Finish&rdquo;</li>
</ul>
</li>
<li>&ldquo;Create&rdquo; a manual first snapshot, add a comment &ldquo;Clean Install&rdquo; to it &amp; exit timeshift</li>
</ul>
<p>In the terminal you will see an <code>ERROR: can't list qgroups: quotas not enabled</code>. Simply ignore this as this error comes only the first time you run timeshift, e.g. run <code>sudo timeshift --create</code> in the terminal to create another snapshot and you won&rsquo;t see this error anymore.</p>
<p>Now, <em>timeshift</em> will check every hour if snapshots (&ldquo;hourly&rdquo;, &ldquo;daily&rdquo;, &ldquo;weekly&rdquo;, &ldquo;monthly&rdquo;, &ldquo;boot&rdquo;) need to be created or deleted. Note that &ldquo;boot&rdquo; snapshots will not be created directly but about 10 minutes after a system startup using a cronjob defined in <code>/etc/cron.d/timeshift-hourly</code> and <code>/etc/cron.d/timeshift-boot</code>.</p>
<p>All snapshots are accessible from <code>/run/timeshift/backup</code> (this folder will be mounted after timeshift runs for the first time after a system reboot). Conveniently, the top-level root (subvolid 5) of your btrfs partition is also mounted there, so it is easy to view, create, delete and move around snapshots manually if needed.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ls /run/timeshift/backup
</span></span><span class="line"><span class="cl"><span class="c1"># @  @home  timeshift-btrfs</span>
</span></span></code></pre></div><p>Note that <code>/run/timeshift/backup/@</code> is your <code>/</code> folder and <code>/run/timeshift/backup/@home</code> your <code>/home</code> folder. Your snapshots are accessible via timeshift-btrfs.</p>
<p>Now, to also automatically create timeshift snapshots when updating our system (or any other apt installation like installing or removing apps), let&rsquo;s install <em>timeshift-autosnap-apt</em> from GitHub</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo apt install -y git make
</span></span><span class="line"><span class="cl">git clone https://github.com/wmutschl/timeshift-autosnap-apt.git /home/<span class="nv">$USER</span>/timeshift-autosnap-apt
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /home/<span class="nv">$USER</span>/timeshift-autosnap-apt
</span></span><span class="line"><span class="cl">sudo make install
</span></span></code></pre></div><p>After this, make changes to the configuration file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo nano /etc/timeshift-autosnap-apt.conf
</span></span></code></pre></div><p>For example, as we don&rsquo;t have a dedicated <code>/boot</code> partition, we can set <code>snapshotBoot=false</code> in the <code>timeshift-autosnap-apt-conf</code> file such that the <code>/boot</code> directory is not rsync&rsquo;ed to <code>/boot.backup</code>. Note that the EFI partition will be rsynced into <code>/boot.backup/efi</code>. So if something goes wrong with the EFI partition, you always have a backup of it as well. Moreover, POP!_OS does not use GRUB so we can set <code>updateGrub=false</code>.</p>
<p>Check if everything is working:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo timeshift-autosnap-apt
</span></span><span class="line"><span class="cl"># Rsyncing /boot/efi into the filesystem before the call to timeshift.
</span></span><span class="line"><span class="cl"># Using system disk as snapshot device for creating snapshots in BTRFS mode
</span></span><span class="line"><span class="cl"># 
</span></span><span class="line"><span class="cl"># /dev/dm-0 is mounted at: /run/timeshift/backup, options: rw,relatime,compress=zstd:3,ssd,space_cache,commit=120,subvolid=5,subvol=/
</span></span><span class="line"><span class="cl"># 
</span></span><span class="line"><span class="cl"># Creating new backup...(BTRFS)
</span></span><span class="line"><span class="cl"># Saving to device: /dev/dm-0, mounted at path: /run/timeshift/backup
</span></span><span class="line"><span class="cl"># Created directory: /run/timeshift/backup/timeshift-btrfs/snapshots/2022-05-24_11-15-25
</span></span><span class="line"><span class="cl"># Created subvolume snapshot: /run/timeshift/backup/timeshift-btrfs/snapshots/2022-05-24_11-15-25/@
</span></span><span class="line"><span class="cl"># Created subvolume snapshot: /run/timeshift/backup/timeshift-btrfs/snapshots/2022-05-24_11-15-25/@home
</span></span><span class="line"><span class="cl"># Created control file: /run/timeshift/backup/timeshift-btrfs/snapshots/2022-05-24_11-15-25/info.json
</span></span><span class="line"><span class="cl"># BTRFS Snapshot saved successfully (0s)
</span></span><span class="line"><span class="cl"># Tagged snapshot &#39;2022-05-24_11-15-25&#39;: ondemand
</span></span></code></pre></div><p>Now, if you run <code>sudo apt install|remove|upgrade|dist-upgrade</code>, <em>timeshift-autosnap-apt</em> will create a snapshot of your system with <em>timeshift</em>.</p>
<h2 id="step-6-practice-recovery-and-system-rollback">Step 6: Practice recovery and system rollback</h2>
<p>Now let&rsquo;s practice what to do in the event of a system disaster. Note that we just created snapshots to which we can always rollback. So as a practice case, let&rsquo;s delete our <code>/etc</code> folder, which of course you should never do:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo rm -rf /etc
</span></span></code></pre></div><p>Now try to reboot and you will notice that the boot process obviously gets stuck because the system is broken. So instead boot into POP!_OS&rsquo;s Recovery System. Then go to the File Manager and to Other locations. Select your encrypted disk and enter your luks passphrase to decrypt it. Note that this mounts the top-level root of your system, so you can either now directly access the broken files and move them back or simply use timeshift to rollback. I will show you both approaches.</p>
<h3 id="rollback-with-timeshift">Rollback with timeshift</h3>
<p>Install timeshift either from the Software center or using the terminal:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo apt install timeshift
</span></span></code></pre></div><p>Open Timeshift, select BTRFS and your disk and you will see the snapshots we created. Select one and hit <code>Restore</code>. Timeshift will then rename and move your current broken <code>@</code> subfolder away and replace it with the snapshot that you just selected. Reboot and all is back to normal! Easy huh?!</p>
<h3 id="rollback-manually">Rollback manually</h3>
<p>Open a terminal and go to the mounted folder.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">cd</span> /media/recovery/052ec665-cf5d-4372-bb65-1b82237b9101
</span></span><span class="line"><span class="cl">ls
</span></span><span class="line"><span class="cl"><span class="c1"># @ @home timeshift-btrfs</span>
</span></span></code></pre></div><p>The folder name is based on the UUID of the mounted device. Next, move the broken subvolume away:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo mv @ @.broken
</span></span></code></pre></div><p>Find the snapshot that you want to reuse in the folder <code>timeshift-btrfs/snapshots/</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ls timeshift-btrfs/snapshots
</span></span><span class="line"><span class="cl"><span class="c1">#   2022-05-25_13-12-45   2022-05-25_13-13-48   2022-05-25_13-17-17</span>
</span></span></code></pre></div><p>For example, I want to rollback to the most recent one from <code>2022-05-25_13-17-17</code>. To do this, make a snapshot of the subvolume <code>@</code> which is inside this folder, call it <code>@</code> and create it at the top-level:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo btrfs subvolume snapshot timeshift-btrfs/snapshots/2022-05-25_13-17-17/@ @
</span></span><span class="line"><span class="cl"><span class="c1"># Create a snapshot of &#39;timeshift-btrfs/snapshots/2022-05-25_13-17-17/@&#39; in &#39;./@&#39;</span>
</span></span><span class="line"><span class="cl">ls /media/recovery/052ec665-cf5d-4372-bb65-1b82237b9101
</span></span><span class="line"><span class="cl"><span class="c1"># @ @.broken @home timeshift-btrfs</span>
</span></span></code></pre></div><p>To sum up, we replaced the broken <code>@</code> subovlume with a good one. Reboot and all is back to normal! Easy huh?!</p>
<p>If all went fine, and you are back in your system, you should delete the snapshot using</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">btrfs subvolume delete @.broken
</span></span></code></pre></div><p>in order to save space.</p>
<p><strong>FINISHED! CONGRATULATIONS AND THANKS FOR STICKING THROUGH!</strong></p>
<p><strong>Check out my <a href="../pop-os-post-install">Pop!_OS post-installation steps</a>.</strong></p>


          </div>

          

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/linux/">linux</a>
  
  <a class="badge badge-light" href="/tag/pop-os/">pop-os</a>
  
  <a class="badge badge-light" href="/tag/install-guide/">install guide</a>
  
  <a class="badge badge-light" href="/tag/btrfs/">btrfs</a>
  
  <a class="badge badge-light" href="/tag/luks/">luks</a>
  
  <a class="badge badge-light" href="/tag/timeshift/">timeshift</a>
  
  <a class="badge badge-light" href="/tag/timeshift-autosnap-apt/">timeshift-autosnap-apt</a>
  
</div>



          
          
          <div class="article-widget">
            
<div class="post-nav">
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Previous</div>
    <a href="/linux/elementary-os-6-1/" rel="next">elementary OS 6.1 Jólnir: installation guide with btrfs, luks encryption and auto snapshots with timeshift</a>
  </div>
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Next</div>
    <a href="/linux/pop-os-post-install/" rel="prev">Pop!_OS: Things to do after installation (Apps, Settings, and Tweaks)</a>
  </div>
  
</div>

          </div>
          
        </div>

        <div class="body-footer">
          <p>Last updated on Jul 14, 2023</p>

          




          




          


        </div>

      </article>

      <footer class="site-footer">

  












  

  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
  </p>
  

  

  
  






  
  
  

  
  
  
    
  

  

  
  <p class="powered-by copyright-license-text">
    © 2025 Willi Mutschler. This work is licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0" rel="noopener noreferrer" target="_blank">CC BY SA 4.0</a>
  </p>
  

  <p class="powered-by footer-license-icons">
    <a href="https://creativecommons.org/licenses/by-sa/4.0" rel="noopener noreferrer" target="_blank" aria-label="Creative Commons">
      <i class="fab fa-creative-commons fa-2x" aria-hidden="true"></i>
      <i class="fab fa-creative-commons-by fa-2x" aria-hidden="true"></i>
      
      
        <i class="fab fa-creative-commons-sa fa-2x" aria-hidden="true"></i>
      
    </a>
  </p>




  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Wowchemy</a> — the free, <a href="https://github.com/wowchemy/wowchemy-hugo-themes" target="_blank" rel="noopener">open source</a> website builder that empowers creators.
    
  </p>
</footer>


    </main>
  </div>
</div>

  </div>

  <div class="page-footer">
    
    
  </div>

  


<script src="/js/vendor-bundle.min.b4708d4364577c16ab7001b265a063a4.js"></script>




  

  
  

  






  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.js" integrity="" crossorigin="anonymous"></script>




<script src="https://cdn.jsdelivr.net/gh/bryanbraun/anchorjs@4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>





  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>











  
  


<script src="/en/js/wowchemy.min.42010733157c11a71adebfe9bae43355.js"></script>



  <script src="/js/wowchemy-map.a26e9d2f7238ba5b868384f1c5bc6477.js" type="module"></script>




















</body>
</html>
